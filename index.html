<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bermuda Elevator - Elevator Management System</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b3d91">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bermuda Elevator">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Evitar pull-to-refresh y scroll no deseado */
        html, body {
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
            -webkit-overflow-scrolling: touch;
        }

        body {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            color: #333;
            min-height: 100vh;
        }

        .app-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            overflow: hidden;
            position: relative;
            flex-direction: column;
            position: relative;
        }

        .screen {
            width: 100%;
            height: calc(100vh - 80px);
            display: none;
            flex-direction: column;
            background: #f8f9fa;
            padding-bottom: 20px;
        }

        .screen.active {
            display: flex;
        }

        /* Header Styles */
        .header {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .header-logo {
            height: 80px;
            width: auto;
            object-fit: contain;
        }

        .header-center {
            flex: 1;
            text-align: center;
            font-weight: 700;
            font-size: 20px;
            color: #2c3e50;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .icon-btn:hover {
            background: #dee2e6;
            transform: scale(1.05);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 40px 20px;
            text-align: center;
        }

        .login-logo h1 {
            font-size: 32px;
            font-weight: 700;
            color: #4285F4;
            margin-bottom: 40px;
            letter-spacing: -0.5px;
        }

        .login-form h2 {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 30px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form input {
            width: 100%;
            padding: 15px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: #ffffff;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #4285F4;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 20px;
        }

        .login-btn:hover {
            background: #3367d6;
        }

        .login-separator {
            margin: 20px 0;
            color: #666;
            font-size: 14px;
        }

        .social-login {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .social-btn {
            width: 50px;
            height: 50px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .social-btn:hover {
            border-color: #4285F4;
            transform: translateY(-2px);
        }

        .signup-link {
            color: #666;
            font-size: 14px;
        }

        .signup-link a {
            color: #4285F4;
            text-decoration: none;
            font-weight: 500;
        }

        .signup-link a:hover {
            text-decoration: underline;
        }

        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1e3a8a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-logo {
            font-size: 36px;
            font-weight: 700;
            color: white;
            margin-bottom: 20px;
            letter-spacing: -1px;
        }

        .loading-logo .highlight {
            color: #10b981;
        }

        .loading-dots {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #60a5fa;
            border-radius: 50%;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .loading-dot:nth-child(4) {
            animation-delay: 0.6s;
        }

        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: 500;
            opacity: 0.9;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #60a5fa, #10b981);
            border-radius: 2px;
            animation: loadingProgress 3s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% {
                opacity: 0.4;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        @keyframes loadingProgress {
            0% {
                width: 0%;
            }
            50% {
                width: 70%;
            }
            100% {
                width: 100%;
            }
        }


        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e74c3c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .profile-pic:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .profile-pic svg {
            color: white;
            opacity: 0.8;
        }

        .profile-pic:hover svg {
            opacity: 1;
        }

        /* Profile Modal Styles */
        .profile-modal-content {
            max-width: 400px;
            width: 90%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .profile-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .profile-pic-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .profile-modal-info h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .profile-modal-info p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .profile-modal-body {
            padding: 20px 0;
        }

        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
        }

        .profile-menu-item:hover {
            background: #f8f9fa;
            color: #667eea;
        }

        .profile-menu-item svg {
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .profile-menu-item:hover svg {
            color: #667eea;
        }

        .profile-menu-divider {
            height: 1px;
            background: #e9ecef;
            margin: 10px 0;
        }

        .logout-item {
            color: #e74c3c;
        }

        .logout-item:hover {
            background: #fdf2f2;
            color: #c0392b;
        }

        .logout-item svg {
            color: #e74c3c;
        }

        .logout-item:hover svg {
            color: #c0392b;
        }

        /* Modal Base Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            position: absolute;
            top: 15px;
            right: 20px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            /* Sin margin-top para que no se vea afectado */
            margin-top: 0;
            /* Scroll interno */
            overflow-y: auto;
            overflow-x: hidden;
            height: 100vh;
            /* Evitar pull-to-refresh */
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
            -webkit-overflow-scrolling: touch;
        }

        /* Dashboard Styles */
        
        /* Grid específico para Dashboard - 5 columnas */
        #dashboard-screen .units-grid {
            display: grid !important;
            grid-template-columns: repeat(5, 1fr) !important;
            gap: 12px !important;
            padding: 0 10px;
        }
        
        /* Dashboard listings como flex para mostrar toasts */
        #dashboard-listings {
            display: flex !important;
            flex-direction: column !important;
            gap: 12px !important;
            padding: 0 10px;
            overflow-y: auto !important;
            max-height: calc(100vh - 450px) !important;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }
        
        #dashboard-listings::-webkit-scrollbar {
            width: 6px;
        }
        
        #dashboard-listings::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #dashboard-listings::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        #dashboard-listings::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        @media (max-width: 1400px) {
            #dashboard-screen .units-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }

        @media (max-width: 1100px) {
            #dashboard-screen .units-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }

        @media (max-width: 768px) {
            #dashboard-screen .units-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 480px) {
            #dashboard-screen .units-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Estilos para Toast Notification */
        .toast {
            background: white !important;
            border-radius: 12px !important;
            padding: 16px 20px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            position: relative !important;
            overflow: hidden !important;
            margin-bottom: 12px !important;
            border: 1px solid #e0e0e0 !important;
            min-height: 60px !important;
            z-index: 1000 !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .toast .icon {
            width: 24px;
            height: 24px;
            background: #27ae60;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .toast .msg {
            flex: 1;
            color: #333;
        }
        
        .toast .msg strong {
            font-size: 14px;
            font-weight: 600;
            color: #1e1e1e;
        }
        
        .toast .msg small {
            font-size: 12px;
            color: #666;
        }
        .toast .msg .stop {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
        }
        .toast .msg .stop:hover {
            color: #2980b9;
        }
        
        .toast .progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #27ae60;
            width: 100%;
        }
        
        /* Tarjetas compactas para Dashboard - Estilo Toast */
        #dashboard-listings .item-card,
        #dashboard-screen .item-card {
            min-height: 60px !important;
            max-height: 60px !important;
            width: 100% !important;
            padding: 12px 16px !important;
            margin: 0 !important;
            border-radius: 12px !important;
            display: flex !important;
            flex-direction: row !important;
            justify-content: space-between !important;
            align-items: center !important;
            background: #1e1e1e !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            border: 1px solid #2a2a2a !important;
        }
        
        #dashboard-listings .item-card:hover,
        #dashboard-screen .item-card:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2) !important;
        }
        
        #dashboard-listings .item-title,
        #dashboard-screen .item-title {
            font-size: 15px !important;
            font-weight: 700 !important;
            text-align: left !important;
            margin: 0 !important;
            padding: 0 !important;
            color: white !important;
            flex: 1 !important;
        }
        
        #dashboard-listings .item-meta,
        #dashboard-screen .item-meta {
            display: flex !important;
            justify-content: flex-end !important;
            align-items: center !important;
            margin: 0 !important;
            padding: 0 !important;
            flex-shrink: 0 !important;
        }
        
        #dashboard-listings .status-badge,
        #dashboard-screen .status-badge {
            font-size: 10px !important;
            padding: 4px 10px !important;
            margin: 0 !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
        }
        
        .hero-section {
            text-align: left;
            margin-bottom: 30px;
            position: fixed;
            top: 14%;
            left: 0;
            right: 0;
            z-index: 100;
            background: transparent;
            padding: 20px;
            margin-top: 0;
            /* Evitar pull-to-refresh */
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }

        .hero-title {
            font-size: 43px !important;
            font-weight: 400;
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.2;
            margin-top: -20px;
        }

        .hero-title strong {
            font-weight: 800;
        }

        .hero-subtitle {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 20px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 500;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #27ae60;
        }

        .stat-change.negative {
            color: #e74c3c;
        }

        /* Search Container */
        .search-container {
            background: white;
            border-radius: 15px;
            padding: 8px 15px;
            margin-bottom: 25px;
            position: fixed;
            top: 207px;
            left: 20px;
            right: 20px;
            z-index: 50;
        }

        .fixed-background {
            position: fixed;
            top: -11px;
            left: -50px;
            width: calc(100vw + 100px);
            height: 376px;
            background: #f8f9fa;
            z-index: 30;
            display: none;
        }

        #dashboard-screen.active .fixed-background {
            display: block;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin: 0 auto;
            max-width: 100%;
        }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            outline: none;
            color: #333;
        }

        .search-input::placeholder {
            color: #999;
        }

        .filter-btn {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn {
            background: #1e1e1e;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .search-btn:hover {
            background: #2a2a2a;
        }

        .filter-btn:hover {
            background: #5a6268;
        }

        .status-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-pill {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #e9ecef;
            color: #495057;
        }

        .filter-pill.active {
            background: #2c3e50;
            color: white;
        }

        .filter-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Section Lists */
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: fixed;
            top: 288px;
            left: 20px;
            right: 20px;
            background: #f8f9fa;
            padding: 15px 20px;
            z-index: 45;
            border-radius: 10px;
            transform: translateY(35%);
        }

        .section-title h3 {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
        }

        .view-all {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
        }

        .item-card {
            background: #1e1e1e;
            border-radius: 15px;
            padding: 20px !important;
            margin-bottom: 9px !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            color: white;
            min-height: 160px !important;
            /* Eliminar fondo azul de selección */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-focus-ring-color: transparent;
            outline: none;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Eliminar fondo azul de selección en todas las tarjetas */
        .item-card:active,
        .item-card:focus {
            -webkit-tap-highlight-color: transparent;
            -webkit-focus-ring-color: transparent;
            outline: none;
            background: #1e1e1e !important;
        }

        .item-card.dark {
            background: #1e1e1e;
            color: white;
        }
        /* Estilos adicionales para eliminar selección en elementos clickeables */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* Eliminar fondo azul en botones y elementos interactivos */
        button:active,
        button:focus,
        .btn:active,
        .btn:focus {
            -webkit-tap-highlight-color: transparent;
            -webkit-focus-ring-color: transparent;
            outline: none;
        }

        /* Control de cursor para diferentes elementos */
        
        /* Elementos clickeables - cursor pointer */
        .item-card,
        .item-card *,
        button,
        .btn,
        .profile-pic,
        .search-btn,
        .bookmark-btn,
        .close-btn,
        .nav-item,
        .status-badge,
        .item-icon,
        .item-details,
        .item-title,
        .item-meta,
        .item-location,
        .progress-bar,
        .progress-fill {
            cursor: pointer !important;
        }

        /* Elementos de texto no editables - cursor default */
        h1, h2, h3, h4, h5, h6,
        p, span, div:not(.item-card):not(.btn):not(button),
        .item-info,
        .item-card-header,
        .loading-text,
        .hero-section,
        .card h2,
        .form-group label {
            cursor: default !important;
        }

        /* Inputs y textareas - cursor text */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            cursor: text !important;
        }

        /* Elementos específicos que no deben tener cursor pointer */
        .item-card .item-title,
        .item-card .item-meta,
        .item-card .item-location,
        .item-card .status-badge {
            cursor: inherit !important;
        }

        /* BLOQUEAR CURSOR DE TEXTO SOLO EN TEXTOS */
        
        /* Solo inputs y textareas pueden tener cursor de texto */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="search"],
        textarea,
        select,
        [contenteditable="true"] {
            cursor: text !important;
        }

        /* BLOQUEAR CURSOR DE TEXTO EN TODOS LOS TEXTOS */
        h1, h2, h3, h4, h5, h6,
        p, span, div, label,
        .item-details,
        .item-title,
        .item-meta,
        .item-location,
        .loading-text,
        .hero-section,
        .card h2,
        .form-group label,
        .item-card .item-details h4,
        .item-card .item-details p,
        .item-card .item-title,
        .item-card .item-meta span,
        .item-card .item-location,
        .status-badge,
        .item-icon,
        .progress-bar,
        .progress-fill,
        .profile-pic,
        .search-btn,
        .close-btn,
        .bookmark-btn,
        .nav-item,
        .item-card-header,
        .item-info,
        .item-card * {
            cursor: default !important;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Elementos clickeables mantienen pointer */
        .item-card,
        button,
        .btn,
        a,
        [onclick],
        [role="button"] {
            cursor: pointer !important;
        }

        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 9px !important;
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .item-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: #3498db;
        }

        .item-card.dark .item-icon {
            background: #2a2a2a;
            color: #3498db;
        }

        .item-details h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: white;
        }

        .item-details p {
            font-size: 14px;
            color: #bdc3c7;
            margin-bottom: 2px;
        }

        .item-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }

        .item-location {
            font-size: 14px;
            color: #bdc3c7;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.operational {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.maintenance {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.out-of-service {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.offline {
            background: white !important;
            color: black !important;
        }

        .status-badge.alarm {
            background: #f8d7da !important;
            color: #721c24 !important;
            border: 2px solid #e74c3c !important;
            font-weight: 700 !important;
        }

        .item-card.dark .status-badge.operational {
            background: #2d5a2d;
            color: #90ee90;
        }

        .item-card.dark .status-badge.maintenance {
            background: #5a4a00;
            color: #ffd700;
        }

        .item-card.dark .status-badge.out-of-service {
            background: #5a1a1a;
            color: #ff6b6b;
        }

        .item-card.dark .status-badge.offline {
            background: white !important;
            color: black !important;
        }

        .item-card.dark .status-badge.alarm {
            background: #5a1a1a !important;
            color: #ff6b6b !important;
            border: 2px solid #e74c3c !important;
            font-weight: 700 !important;
        }

        .bookmark-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #ddd;
            transition: all 0.3s ease;
        }

        .bookmark-btn.active {
            color: #e74c3c;
        }

        .item-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 9px !important;
        }

        .item-location {
            font-size: 14px;
            color: #7f8c8d;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #495057;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px !important;
        }

        .progress-fill {
            height: 100%;
            background: #27ae60;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .item-card.dark .progress-bar {
            background: #495057;
        }
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 12px;
            transition: all 0.3s ease;
            border-radius: 12px;
            color: #7f8c8d;
            min-width: 60px;
        }

        .nav-item.active {
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .nav-item:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
        }

        .nav-item.active .nav-label {
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 28px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .status-filters {
                flex-wrap: wrap;
            }
            
            .filter-pill {
                flex: 1;
                min-width: 100px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen.active {
            display: flex;
        }


        /* Specific section styles */
        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .service-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }


        .report-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        /* Service Log Styles */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin: 20px auto;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-group select,
        .form-group textarea,
        .form-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        #addServiceBtn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #addServiceBtn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        #serviceMsg {
            font-size: 14px;
            font-weight: 500;
        }

        #serviceMsg.success {
            color: #27ae60;
        }

        #serviceMsg.error {
            color: #e74c3c;
        }

        .photo-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .service-history-item {
            background: #1e1e1e;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }

        .service-history-item h4 {
            margin: 0 0 8px 0;
            color: white;
            font-size: 16px;
        }

        .service-history-item p {
            margin: 4px 0;
            color: #bdc3c7;
            font-size: 14px;
        }

        #viewHistoryBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }


        .delete-entry-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }

        /* Report Generation Styles */
        #generateReportBtn {
            background: #0b3d91;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #generateReportBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        .success-msg {
            font-size: 14px;
            font-weight: 500;
        }

        .success-msg.success {
            color: #27ae60;
        }

        .success-msg.error {
            color: #e74c3c;
        }

        /* Device Management Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
        }

        .table td {
            border-bottom: 1px solid #e9ecef;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .edit-email:hover {
            background: #1f4e79;
            transform: translateY(-1px);
        }

        #addDeviceBtn {
            background: #0b3d91;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #addDeviceBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        /* User Management Styles */
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #1565c0;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .info-box p {
            margin: 0;
            font-size: 14px;
        }


        #addRoleBtn {
            background: #0b3d91;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #addRoleBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        .delR {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .delR:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }

        #viewUsersBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        #viewDevicesBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        #userEmail {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        #userEmail:focus {
            outline: none;
            border-color: #0b3d91;
            box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
        }

        #rolePass {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        #rolePass:focus {
            outline: none;
            border-color: #0b3d91;
            box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
        }

        /* Message styles */
        .success {
            color: #27ae60;
            font-weight: 600;
        }

        .error {
            color: #e74c3c;
            font-weight: 600;
        }

        .info {
            color: #3498db;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <h1>Bermuda Elevator</h1>
            </div>
            
            <div class="login-form">
                <h2>Login to your Account</h2>
                
                <form id="loginForm">
                    <div class="form-group">
                        <input type="email" id="loginEmail" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="loginPassword" placeholder="Password" required>
                    </div>
                    
                    <button type="submit" class="login-btn">Sign in</button>
                </form>
                
                <div class="signup-link">
                    <span>Don't have an account? Contact your provider to register</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="loading-logo">
            Bermuda<span class="highlight"> Elevator</span>
        </div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <div class="loading-text">Cargando sistema...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content profile-modal-content">
            <div class="profile-modal-header">
                <div class="profile-modal-avatar">
                    <div class="profile-pic-large">A</div>
                </div>
                <div class="profile-modal-info">
                    <h3 id="profile-user-name">User</h3>
                    <p id="profile-user-email">user@example.com</p>
                </div>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            
            <div class="profile-modal-body">
                <div class="profile-menu-item" onclick="showProfileSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Profile</span>
                </div>
                
                <div class="profile-menu-item" onclick="showAccountSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                    </svg>
                    <span>Settings</span>
                </div>
                
                <div class="profile-menu-item" onclick="showNotifications()" style="display: none;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span>Notifications</span>
                </div>
                
                <div class="profile-menu-divider"></div>
                
                <div class="profile-menu-item logout-item" onclick="showLogoutModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16,17 21,12 16,7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Logout</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logout-confirm-modal" class="modal" style="display: none;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #e74c3c; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16,17 21,12 16,7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </div>
                <h2 style="margin: 0; color: #2c3e50; font-size: 24px;">Confirm Logout</h2>
                <p style="color: #7f8c8d; margin: 10px 0 0 0; font-size: 16px;">Are you sure you want to logout from your account?</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button id="cancel-logout" style="flex: 1; background: #95a5a6; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Cancel
                </button>
                <button id="confirm-logout" style="flex: 1; background: #e74c3c; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Logout
                </button>
            </div>
        </div>
    </div>
    <div class="app-container" id="main-app" style="display: none;">
        <!-- Dashboard Screen -->
        <div class="screen active" id="dashboard-screen">
            <!-- Fondo fijo para elementos superiores -->
            <div class="fixed-background"></div>
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn" id="refresh-all-btn" title="Actualizar todas las APIs">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 2v6h-6M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M3 22v-6h6M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        </svg>
                    </button>
                </div>
                <div class="header-center">
                    <div class="logo-container">
                        <img src="https://i.imgur.com/A6T3whG.png" alt="Bermuda Elevator" class="header-logo">
                    </div>
                </div>
                <div class="header-right">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="4" y1="21" x2="4" y2="14"></line>
                            <line x1="4" y1="10" x2="4" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12" y2="3"></line>
                            <line x1="20" y1="21" x2="20" y2="16"></line>
                            <line x1="20" y1="12" x2="20" y2="3"></line>
                            <line x1="1" y1="14" x2="7" y2="14"></line>
                            <line x1="9" y1="8" x2="15" y2="8"></line>
                            <line x1="17" y1="16" x2="23" y2="16"></line>
                        </svg>
                    </button>
                    <button class="icon-btn" onclick="hardReload()" title="Limpiar cache y recargar" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                            <path d="M21 3v5h-5"></path>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                            <path d="M3 21v-5h5"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="hero-section">
                    <h1 class="hero-title">Hello! <strong>User</strong></h1>
                    <p class="hero-subtitle">Monitor and manage all elevator operations</p>
                </div>


                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Search elevator..." id="search-input">
                        <button class="search-btn" id="search-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                    </div>

                </div>

                <div class="section-title">
                    <h3>Recent Activity</h3>
                    <a href="#" class="view-all" onclick="showScreen('units-screen'); return false;">View All</a>
                </div>

                <div class="item-listings" id="dashboard-listings" style="margin-top: 366px; position: fixed; top: 7px; left: 20px; right: 20px; z-index: 40;">
                    <!-- Las tarjetas se cargan dinámicamente desde la API -->
                </div>

            </div>
        </div>

        <!-- Units Screen -->
        <div class="screen" id="units-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn" id="refresh-units-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">Elevator Units</div>
                <div class="header-right">
                    <button class="icon-btn" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="units-grid" id="units-grid">
                    <!-- Units will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Service Screen -->
        <div class="screen" id="service-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">Service & Maintenance</div>
                <div class="header-right">
                    <button class="icon-btn" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="card" id="serviceCard" style="display: block; max-width: 90%; width: 90%; margin: -3% auto 20px auto;">
                    <h2>Service Log</h2>
                    <div style="margin-bottom:20px;">
                      <label style="display:block;margin-bottom:8px;font-weight:600;color:#0b3d91;font-size:0.9rem;">Select Device</label>
                        <select id="serviceDeviceSelect" style="padding:8px;font-size:0.95rem;border-radius:8px;width:100%;border:2px solid #ddd;">
                          <option value="">Loading devices...</option>
                        </select>
                </div>
                    
                    <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                      <h3 style="margin:0 0 10px 0;color:#0b3d91;font-size:1rem;">Add Service Entry</h3>
                      <div class="form-group">
                        <label>Service Type *</label>
                        <select id="serviceType" style="width:100%;padding:8px;font-size:0.9rem;">
                          <option value="emergency">Emergency Call</option>
                          <option value="inspection">Inspection</option>
                          <option value="maintenance">Routine Maintenance</option>
                          <option value="repair">Repair Service</option>
                          <option value="cleaning">Cleaning Service</option>
                          <option value="testing">System Testing</option>
                          <option value="software">Software Update</option>
                          <option value="upgrade">System Upgrade</option>
                          <option value="preventive">Pre-inspection</option>
                          <option value="diagnostic">Diagnostic Check</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Notes/Description *</label>
                        <textarea id="serviceNotes" placeholder="Describe the work performed..." style="width:100%;min-height:80px;padding:8px;font-size:0.9rem;border:1px solid #ccc;border-radius:8px;resize:vertical;box-sizing:border-box;"></textarea>
                      </div>
                      <button id="addServiceBtn" style="width:100%;padding:10px;font-size:0.95rem;margin-top:10px;">Add Service Entry</button>
                      <p id="serviceMsg" style="margin:8px 0;"></p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;" id="viewHistoryContainer">
                        <button id="viewHistoryBtn" style="background: #0b3d91; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            View History
                        </button>
                    </div>
                  </div>
            </div>
        </div>

        <!-- Reports Screen -->
        <div class="screen" id="reports-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">Reports & Analytics</div>
                <div class="header-right">
                    <button class="icon-btn" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                  <h3 style="margin:0 0 15px 0;color:#0b3d91;font-size:1rem;">Generate Report</h3>
                  
                  <div class="form-group">
                    <label>Report Type</label>
                    <select id="reportType" style="width:100%;padding:8px;font-size:0.9rem;">
                      <option value="alarms">Alarm History Report</option>
                      <option value="service">Service Log Report</option>
                      <option value="summary">Monthly Summary</option>
                    </select>
                </div>
                  
                  <div class="form-group">
                    <label>Select Device</label>
                        <select id="reportDeviceSelect" style="width:100%;padding:8px;font-size:0.9rem;">
                          <option value="all">Loading devices...</option>
                        </select>
                  </div>
                  
                  <div class="form-group">
                    <label>Date Range</label>
                    <div id="dateRangeContainer" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                      <input type="date" id="reportStartDate" style="width:100%;padding:8px;font-size:0.85rem;">
                      <input type="date" id="reportEndDate" style="width:100%;padding:8px;font-size:0.85rem;">
                    </div>
                    <div id="monthSelectorContainer" style="display:none;">
                      <input type="month" id="reportMonth" style="width:100%;padding:8px;font-size:0.85rem;">
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label>Technician Comments</label>
                    <textarea id="reportComments" placeholder="Enter your observations, findings, or recommendations..." style="width:100%;padding:8px;font-size:0.85rem;border:1px solid #ddd;border-radius:4px;resize:vertical;min-height:80px;font-family:inherit;"></textarea>
                  </div>
                  
                  <button id="generateReportBtn" style="width:100%;padding:10px;font-size:0.95rem;margin-top:10px;">Generate &amp; Download PDF</button>
                  <p id="reportMsg" style="margin: 8px 0px; color: rgb(41, 128, 185);" class="success-msg"></p>
                </div>
            </div>
        </div>

        <!-- Devices Screen -->
        <div class="screen" id="devices-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">Connected Devices</div>
                <div class="header-right">
                    <button class="icon-btn" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="card" id="devicesCard" style="display: block; max-width: 450px;">
                    <h2 style="font-size:1.2rem;margin-bottom:12px;">Manage Devices</h2>
                    <div class="form-group">
                      <label>Device ID *</label>
                      <input id="newId" placeholder="e.g., ID09" style="padding:7px;font-size:0.85rem;">
                </div>
                    <div class="form-group">
                      <label>Building Name *</label>
                      <input id="newBld" placeholder="e.g., Hamilton Tower" style="padding:7px;font-size:0.85rem;">
            </div>
                    <div class="form-group">
                      <label>Unit/Elevator *</label>
                      <input id="newUnit" placeholder="e.g., Elevator A" style="padding:7px;font-size:0.85rem;">
                    </div>
                    <div class="form-group">
                      <label>Client Email</label>
                      <input id="newEmail" type="email" placeholder="client@example.com" style="padding:7px;font-size:0.85rem;">
                    </div>
                    <button id="addDeviceBtn" style="width:100%;padding:8px;font-size:0.9rem;margin-top:5px;">Add Device</button>
                    <p id="deviceMsg" style="margin:8px 0;"></p>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="viewDevicesBtn" style="background: #0b3d91; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-right: 10px;">
                            View All Devices
                        </button>
                    </div>
                  </div>
            </div>
        </div>

        <!-- Users Screen -->
        <div class="screen" id="users-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">User Management</div>
                <div class="header-right">
                    <button class="icon-btn" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="card" id="usersCard" style="display: block;">
                    <h2>Manage Users</h2>
                    <div class="form-group">
                      <label>Email *</label>
                      <input id="userEmail" type="email" placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                      <label>Password *</label>
                      <input id="rolePass" placeholder="User's password">
                </div>
                    <div class="form-group">
                      <label>Role Type *</label>
                      <select id="roleType" style="width:100%;padding:10px;">
                        <option value="client">Client (View Only)</option>
                        <option value="technician">Technician (All Buildings)</option>
                        <option value="admin">Admin (Full Access)</option>
                      </select>
            </div>
                    <div class="info-box" id="technicianInfo" style="display:none;">
                      <strong>Technician Access</strong>
                      <p>Technicians automatically have access to all buildings.</p>
                    </div>
                    <button id="addRoleBtn" style="width:100%;">Add/Update User</button>
                    <p id="userMsg"></p>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="viewUsersBtn" style="background: #0b3d91; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            View All Users
                        </button>
                    </div>
                  </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('dashboard-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </div>
                <div class="nav-label">Dashboard</div>
            </div>
            <div class="nav-item" onclick="showScreen('units-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9,22 9,12 15,12 15,22"></polyline>
                    </svg>
                </div>
                <div class="nav-label">Units</div>
            </div>
            <div class="nav-item" onclick="showScreen('service-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                    </svg>
                </div>
                <div class="nav-label">Service</div>
            </div>
            <div class="nav-item" onclick="showScreen('reports-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"></path>
                        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                    </svg>
                </div>
                <div class="nav-label">Reports</div>
            </div>
            <div class="nav-item" onclick="showScreen('devices-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                </div>
                <div class="nav-label">Devices</div>
            </div>
            <div class="nav-item" onclick="showScreen('users-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="nav-label">Users</div>
            </div>
        </div>
    </div>

    <!-- Modal de Elevador -->
    <div id="elevator-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="elevator-title" style="margin: 0; color: #2c3e50; font-size: 24px;">Elevator A-01</h2>
            </div>
            <p id="elevator-timestamp" class="timestamp" style="color: #7f8c8d; margin-bottom: 20px;">Last Update: 23/10/2025, 15:41:14</p>
            <div id="elevator-statuses" style="margin-bottom: 20px;">
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Out of Service</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">NORMAL</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Fire Service</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">NORMAL</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Phone Comm</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">NORMAL</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Pit Flooded</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">NORMAL</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Elevator at DZ</span>
                    <span class="blue" style="color: #3498db; font-weight: 600;">NO</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Elevator Moving</span>
                    <span class="blue" style="color: #3498db; font-weight: 600;">NO</span>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="close-elevator-modal" style="background: #000000; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Close
                </button>
            </div>
        </div>
    </div>
    <!-- Modal de Filtros -->
    <div id="filter-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 20px;">Advanced Filters</h3>
                <button id="close-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div class="modal-filters">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;">Elevator Status:</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="status" value="all" checked style="margin: 0;">
                            <span>All Status</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="status" value="operational" style="margin: 0;">
                            <span>Operational</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="status" value="out-of-service" style="margin: 0;">
                            <span>In Alarm</span>
                        </label>
                    </div>
                </div>
                <div style="margin-bottom: 20px; display: none;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;">Building:</label>
                    <select id="buildingFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="all">All Buildings</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="apply-filters" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Apply Filters</button>
                    <button id="clear-filters" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Clear</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Historial de Servicios -->
    <div id="service-history-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">Service History</h3>
                <button id="close-history-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div id="serviceHistory" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <p style="text-align:center;color:#999;padding:20px;">No service history yet</p>
            </div>
        </div>
    </div>

    <!-- Modal de Lista de Usuarios -->
    <div id="users-list-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 900px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">All Users</h3>
                <button id="close-users-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <table class="table" id="rolesTable">
                    <thead><tr><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
                    <tbody>
                        <!-- Los datos se cargarán dinámicamente desde la API -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles de Usuario -->
    <div id="user-details-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">User Details</h3>
                <button id="close-user-details-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div id="userDetailsContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- Los detalles del usuario se cargarán dinámicamente desde la API -->
            </div>
        </div>
    </div>

    <!-- Modal de Lista de Dispositivos -->
    <div id="devices-list-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">All Devices</h3>
                <button id="close-devices-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <table class="table" id="devicesTable" style="font-size:0.8rem;">
                    <thead><tr><th style="padding:5px;">ID</th><th style="padding:5px;">Building</th><th style="padding:5px;">Unit</th><th style="padding:5px;">Actions</th></tr></thead>
                    <tbody>
                        <tr data-device-id="ID00" data-building="N/A" data-unit="N/A" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">ID00</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">N/A</td>
                            <td style="padding:5px;font-size:0.8rem;">N/A</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="ID00" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="ID00" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                        <tr data-device-id="ID01" data-building="test tower house" data-unit="1" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">ID01</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">test tower house</td>
                            <td style="padding:5px;font-size:0.8rem;">1</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="ID01" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="ID01" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                        <tr data-device-id="ID02" data-building="Seon Place" data-unit="Elevator 1" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">ID02</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">Seon Place</td>
                            <td style="padding:5px;font-size:0.8rem;">Elevator 1</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="ID02" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="ID02" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                        <tr data-device-id="ID08" data-building="Continental Building" data-unit="Elevator 1" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">ID08</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">Continental Building</td>
                            <td style="padding:5px;font-size:0.8rem;">Elevator 1</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="ID08" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="ID08" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                        <tr data-device-id="Id01" data-building="Hamilton tower" data-unit="Elevator 2" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">Id01</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">Hamilton tower</td>
                            <td style="padding:5px;font-size:0.8rem;">Elevator 2</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="Id01" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="Id01" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles de Dispositivo -->
    <div id="device-details-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">Device Details</h3>
                <button id="close-device-details-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div id="deviceDetailsContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- Device details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Hidden iframe for form submission -->
    <iframe id="hiddenIframe" name="hiddenIframe" style="display: none;"></iframe>

    <!-- Hidden form for deleting users -->
    <form id="deleteUserForm" action="https://script.google.com/macros/s/AKfycbxUleHuPBZ9FxPX8_p2bZz63NFTpI7oUWd8qX6dP2ktH6LonR7YULPLoCPW28Avv-KArQ/exec" method="post" target="hiddenIframe" style="display: none;">
        <input type="email" name="correo" id="deleteUserEmail" placeholder="Correo del usuario a eliminar" required="">
        <input type="hidden" name="action" value="delete_user">
    </form>

    <!-- Hidden form for adding devices -->
    <form id="addDeviceForm" action="https://script.google.com/macros/s/AKfycbyEyIQFBkpPRfo31BPKX0neg3k8ufj-M_unbtYM2xKI0yL6QBNdokHD0bghSNxpS2Hm/exec" method="post" target="hiddenIframe" style="display: none;">
        <input type="text" name="deviceId" id="addDeviceId" required="">
        <input type="text" name="buildingName" id="addDeviceBuilding" required="">
        <input type="text" name="unitElevator" id="addDeviceUnit" required="">
        <input type="email" name="clientEmail" id="addDeviceEmail">
        <input type="hidden" name="action" value="add_device">
    </form>

    <!-- Hidden form for deleting devices -->
    <form id="deleteDeviceForm" action="https://script.google.com/macros/s/AKfycbyEyIQFBkpPRfo31BPKX0neg3k8ufj-M_unbtYM2xKI0yL6QBNdokHD0bghSNxpS2Hm/exec" method="post" target="hiddenIframe" style="display: none;">
        <input type="email" name="clientEmail" id="deleteDeviceEmail" required="">
        <input type="hidden" name="action" value="delete_device">
    </form>

    <!-- Modal de Confirmación de Eliminación de Usuario -->
    <div id="delete-confirm-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #e74c3c; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
                <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 20px; font-weight: 700;">¿Estás seguro?</h3>
                <p style="margin: 0; color: #6c757d; font-size: 14px;">Esta acción no se puede deshacer</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="cancel-delete" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Cancelar
                </button>
                <button id="confirm-delete" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación de Dispositivo -->
    <div id="delete-device-confirm-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #e74c3c; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                    </svg>
                </div>
                <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 20px; font-weight: 700;">¿Eliminar Dispositivo?</h3>
                <p style="margin: 0; color: #6c757d; font-size: 14px;">Esta acción no se puede deshacer</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="cancel-delete-device" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Cancelar
                </button>
                <button id="confirm-delete-device" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Datos de ejemplo para elevadores
        const elevatorData = [
            {
                id: 1,
                name: "Elevator A-01",
                location: "Building A - Floor 1-10",
                status: "operational",
                lastService: "2024-01-15",
                nextService: "2024-02-15",
                isDark: false,
                progress: 100
            },
            {
                id: 2,
                name: "Elevator A-02",
                location: "Building A - Floor 11-20",
                status: "maintenance",
                lastService: "2024-01-10",
                nextService: "2024-01-25",
                isDark: true,
                progress: 100
            },
            {
                id: 3,
                name: "Elevator B-01",
                location: "Building B - Floor 1-8",
                status: "operational",
                lastService: "2024-01-12",
                nextService: "2024-02-12",
                isDark: false,
                progress: 100
            },
            {
                id: 4,
                name: "Elevator B-02",
                location: "Building B - Floor 9-16",
                status: "operational",
                lastService: "2024-01-08",
                nextService: "2024-02-08",
                isDark: true,
                progress: 100
            }
        ];

        const serviceData = [
            {
                id: 1,
                elevator: "Elevator A-02",
                type: "Routine Maintenance",
                status: "In Progress",
                technician: "John Smith",
                scheduledDate: "2024-01-25",
                priority: "Medium"
            },
            {
                id: 2,
                elevator: "Elevator B-01",
                type: "Safety Inspection",
                status: "Scheduled",
                technician: "Mike Johnson",
                scheduledDate: "2024-01-30",
                priority: "High"
            },
            {
                id: 3,
                elevator: "Elevator A-01",
                type: "Software Update",
                status: "Completed",
                technician: "Sarah Wilson",
                scheduledDate: "2024-01-20",
                priority: "Low"
            }
        ];

        const reportData = [
            {
                id: 1,
                title: "Monthly Performance Report",
                type: "Performance",
                date: "2024-01-01",
                status: "Generated"
            },
            {
                id: 2,
                title: "Maintenance Cost Analysis",
                type: "Financial",
                date: "2024-01-05",
                status: "Generated"
            },
            {
                id: 3,
                title: "Safety Compliance Report",
                type: "Safety",
                date: "2024-01-10",
                status: "Pending"
            }
        ];

        const deviceData = [
            {
                id: 1,
                name: "Control Panel A-01",
                type: "Main Controller",
                status: "Online",
                location: "Building A - Basement",
                lastUpdate: "2 minutes ago"
            },
            {
                id: 2,
                name: "Sensor Network B-01",
                type: "IoT Sensors",
                status: "Online",
                location: "Building B - All Floors",
                lastUpdate: "1 minute ago"
            },
            {
                id: 3,
                name: "Emergency System",
                type: "Safety Device",
                status: "Offline",
                location: "Building A - Floor 5",
                lastUpdate: "5 minutes ago"
            }
        ];

        const userData = [
            {
                id: 1,
                name: "Admin User",
                role: "Administrator",
                email: "admin@elevator.com",
                status: "Active",
                lastLogin: "2024-01-20"
            },
            {
                id: 2,
                name: "Technician 1",
                role: "Maintenance",
                email: "tech1@elevator.com",
                status: "Active",
                lastLogin: "2024-01-19"
            },
            {
                id: 3,
                name: "Operator 1",
                role: "Operator",
                email: "op1@elevator.com",
                status: "Inactive",
                lastLogin: "2024-01-15"
            }
        ];

        // ========================================
        // SISTEMA DE SEGURIDAD - OTP + DEVICE ID
        // ========================================
        const SECURE_API_URL = 'https://script.google.com/macros/s/AKfycbwE-J2SEyLmNseC9nOQ1Rj0OBQH5Q3nsqFI9qh5UT6HnZ7ebvF99wDbPhXRYHWlc2Yicg/exec';
        
        // Función para obtener/generar Device ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('_0xDID');
            if (!deviceId) {
                deviceId = 'DV_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('_0xDID', deviceId);
            }
            return deviceId;
        }

        // Función para crear tarjeta de elevador
        function createElevatorCard(elevator) {
            const card = document.createElement('div');
            card.className = `item-card ${elevator.isDark ? 'dark' : ''}`;
            card.style.marginBottom = '18px';
            card.onclick = function() { openElevatorModal(elevator); };
            
            const statusClass = elevator.status === 'operational' ? 'operational' : 
                              elevator.status === 'maintenance' ? 'maintenance' : 'out-of-service';
            
            card.innerHTML = `
                <div class="item-card-header">
                    <div class="item-info">
                        <div class="item-icon">🏢</div>
                        <div class="item-details">
                            <h4>${elevator.name}</h4>
                            <p>${elevator.location}</p>
                        </div>
                    </div>
                    <button class="bookmark-btn" onclick="toggleBookmark(${elevator.id}); event.stopPropagation();">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                </div>
                <div class="item-title">${elevator.id}</div>
                <div class="item-meta">
                    <span class="item-location">${elevator.location}</span>
                    <span class="status-badge ${statusClass}">${elevator.status}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${elevator.progress}%"></div>
                </div>
            `;
            
            return card;
        }

        // Función para crear tarjeta de servicio
        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'item-card';
            
            card.innerHTML = `
                <div class="item-card-header">
                    <div class="item-info">
                        <div class="item-icon">🔧</div>
                        <div class="item-details">
                            <h4>${service.elevator}</h4>
                            <p>${service.type}</p>
                        </div>
                    </div>
                    <span class="status-badge ${service.status.toLowerCase().replace(' ', '-')}">${service.status}</span>
                </div>
                <div class="item-title">${service.type}</div>
                <div class="item-meta">
                    <span class="item-location">Technician: ${service.technician}</span>
                    <span class="item-location">Date: ${service.scheduledDate}</span>
                </div>
            `;
            
            return card;
        }
        // Función para crear tarjeta de elevador desde datos de dispositivo
        async function createDeviceElevatorCard(device, index, isDashboard = false) {
            // Validar que el dispositivo no tenga datos corruptos
            if (!device || 
                !device.deviceId || 
                device.deviceId.includes('console.log') ||
                device.deviceId.includes('elevator_control_app.html') ||
                device.deviceId.includes('Dispositivos disponibles')) {
                return null;
            }
            
            const card = document.createElement('div');
            card.className = `item-card ${index % 2 === 1 ? 'dark' : ''}`;
            card.onclick = function() { openDeviceElevatorModal(device); };
            
            // Crear nombre del elevador basado en el edificio
            const elevatorName = device.buildingName || `Building ${device.deviceId}`;
            const location = `${device.buildingName} - ${device.unitElevator}`;
            
            // Mostrar estado inicial (operational por defecto)
            let status = 'operational';
            let statusClass = 'operational';
            let progressColor = '#27ae60';
            
            // Agregar atributo data-device-id para identificación
            card.setAttribute('data-device-id', device.deviceId);
            
            // Crear HTML diferente según si es Dashboard o Units
            if (isDashboard) {
                // Dashboard: Solo ID y estado
                card.innerHTML = `
                    <div class="item-title">${device.deviceId}</div>
                    <div class="item-meta">
                        <span class="status-badge ${statusClass}">${status}</span>
                    </div>
                `;
            } else {
                // Units: HTML completo con toda la información
                card.innerHTML = `
                    <div class="item-card-header">
                        <div class="item-info">
                            <div class="item-icon">🏢</div>
                            <div class="item-details">
                                <h4>${elevatorName}</h4>
                                <p>${location}</p>
                            </div>
                        </div>
                        <button class="bookmark-btn" onclick="toggleBookmark('${device.deviceId}'); event.stopPropagation();">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="item-title">${device.deviceId} - ${device.unitElevator}</div>
                    <div class="item-meta">
                        <span class="item-location">${location}</span>
                        <span class="status-badge ${statusClass}">${status}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 100%; background-color: ${progressColor};"></div>
                    </div>
                `;
            }
            
            // Consultar la API con cache para obtener datos de alarmas en tiempo real
            try {
                const data = await getApiDataWithCache();
                
                if (data && data.success && data.data && Array.isArray(data.data)) {
                    // Buscar el dispositivo específico en los datos
                    const deviceData = data.data.find(d => d.device_id === device.deviceId);
                    
                    if (deviceData) {
                        // Verificar si hay alarmas activas
                        const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                       deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
                        
                        if (hasAlarm) {
                            status = 'ALARM';
                            statusClass = 'alarm';
                            progressColor = '#e74c3c';
                        } else {
                            // Mantener estado operacional
                        }
                    } else {
                        // Si no se encuentra en la API, mostrar offline
                        status = 'offline';
                        statusClass = 'offline';
                        progressColor = '#2c3e50';
                    }
                    
                    // Actualizar el HTML con el estado correcto
                    const statusBadge = card.querySelector('.status-badge');
                    const progressFill = card.querySelector('.progress-fill');
                    
                    if (statusBadge) {
                        statusBadge.textContent = status;
                        statusBadge.className = `status-badge ${statusClass}`;
                    }
                    
                    // Actualizar progress bar solo si existe (Units)
                    if (progressFill) {
                        progressFill.style.backgroundColor = progressColor;
                    }
                    
                }
            } catch (error) {
                // Mantener estado operacional por defecto si hay error
            }
            
            return card;
        }
        // Función para abrir modal de elevador desde datos de dispositivo
        async function openDeviceElevatorModal(device) {
            const modal = document.getElementById('elevator-modal');
            const title = document.getElementById('elevator-title');
            const timestamp = document.getElementById('elevator-timestamp');
            const statusesContainer = document.getElementById('elevator-statuses');
            
            const elevatorName = device.buildingName || `Building ${device.deviceId}`;
            
            // Actualizar título
            title.textContent = elevatorName;
            
            // Iniciar timestamp dinámico
            startDynamicTimestamp();
            
            // Mostrar indicador de carga
            statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">Loading device status...</div>';
            
            // Mostrar el modal
            modal.style.display = 'flex';
            
            try {
                // Obtener datos en tiempo real de la API con cache
                const data = await getApiDataWithCache();
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    // Buscar el dispositivo específico en los datos
                    const deviceData = data.data.find(d => d.device_id === device.deviceId);
                    
                    if (deviceData) {
                        // El timestamp se actualiza dinámicamente cada segundo
                        
                        // Verificar si el dispositivo está offline (han pasado más de 60 segundos desde su timestamp)
                        const now = new Date();
                        const deviceTime = new Date(deviceData.timestamp);
                        const timeDiff = now - deviceTime;
                        const secondsDiff = timeDiff / 1000;
                        const isOffline = secondsDiff > 60;
                        
                        // Verificar si hay alarmas críticas
                        const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                       deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
                        
                        // Aplicar borde al modal según el estado
                        const modalContent = modal.querySelector('.modal-content');
                        if (isOffline) {
                            modalContent.style.border = '3px solid #95a5a6';
                            modalContent.style.boxShadow = '0 10px 30px rgba(149, 165, 166, 0.4)';
                        } else if (hasAlarm) {
                            modalContent.style.border = '3px solid #e74c3c';
                            modalContent.style.boxShadow = '0 10px 30px rgba(231, 76, 60, 0.4)';
                        } else {
                            modalContent.style.border = '3px solid #27ae60';
                            modalContent.style.boxShadow = '0 10px 30px rgba(39, 174, 96, 0.4)';
                        }
                        
                        // Actualizar estados con datos reales
                        if (isOffline) {
                            // Mostrar todos los estados como OFFLINE
                            statusesContainer.innerHTML = `
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>🚫 Out of Service</span>
                                    <span class="offline" style="color: #95a5a6; font-weight: 600;">📡 OFFLINE</span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>🔥 Fire Service</span>
                                    <span class="offline" style="color: #95a5a6; font-weight: 600;">📡 OFFLINE</span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>📞 Phone Comm</span>
                                    <span class="offline" style="color: #95a5a6; font-weight: 600;">📡 OFFLINE</span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>💧 Pit Flooded</span>
                                    <span class="offline" style="color: #95a5a6; font-weight: 600;">📡 OFFLINE</span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>🏢 Elevator at DZ</span>
                                    <span class="offline" style="color: #95a5a6; font-weight: 600;">📡 OFFLINE</span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>🚀 Elevator Moving</span>
                                    <span class="offline" style="color: #95a5a6; font-weight: 600;">📡 OFFLINE</span>
                                </div>
                            `;
                        } else {
                            // Mostrar estados normales con alarmas si las hay
                            statusesContainer.innerHTML = `
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${deviceData.OUT_OF_SERVICE ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                    <span>🚫 Out of Service</span>
                                    <span class="${deviceData.OUT_OF_SERVICE ? 'true' : 'false'}" style="color: ${deviceData.OUT_OF_SERVICE ? '#e74c3c' : '#27ae60'}; font-weight: 600;">
                                        ${deviceData.OUT_OF_SERVICE ? '🚨 ALARM' : '✅ NORMAL'}
                                    </span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${deviceData.FIRE_SERVICE ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                    <span>🔥 Fire Service</span>
                                    <span class="${deviceData.FIRE_SERVICE ? 'true' : 'false'}" style="color: ${deviceData.FIRE_SERVICE ? '#e74c3c' : '#27ae60'}; font-weight: 600;">
                                        ${deviceData.FIRE_SERVICE ? '🚨 ALARM' : '✅ NORMAL'}
                                    </span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${deviceData.PHONE_COMM ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                    <span>📞 Phone Comm</span>
                                    <span class="${deviceData.PHONE_COMM ? 'true' : 'false'}" style="color: ${deviceData.PHONE_COMM ? '#e74c3c' : '#27ae60'}; font-weight: 600;">
                                        ${deviceData.PHONE_COMM ? '🚨 ALARM' : '✅ NORMAL'}
                                    </span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${deviceData.PIT_FLOODED ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                    <span>💧 Pit Flooded</span>
                                    <span class="${deviceData.PIT_FLOODED ? 'true' : 'false'}" style="color: ${deviceData.PIT_FLOODED ? '#e74c3c' : '#27ae60'}; font-weight: 600;">
                                        ${deviceData.PIT_FLOODED ? '🚨 ALARM' : '✅ NORMAL'}
                                    </span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>🏢 Elevator at DZ</span>
                                    <span class="${deviceData.AT_FLOOR ? 'true' : 'false'}" style="color: ${deviceData.AT_FLOOR ? '#3498db' : '#3498db'}; font-weight: 600;">
                                        ${deviceData.AT_FLOOR ? 'YES' : 'NO'}
                                    </span>
                                </div>
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>🚀 Elevator Moving</span>
                                    <span class="${deviceData.MOVING ? 'true' : 'false'}" style="color: ${deviceData.MOVING ? '#3498db' : '#3498db'}; font-weight: 600;">
                                        ${deviceData.MOVING ? 'YES' : 'NO'}
                                    </span>
                                </div>
                            `;
                        }
                    } else {
                        // Si no se encuentra el dispositivo, mostrar estado offline
                        // El timestamp se actualiza dinámicamente cada segundo
                        
                        // Aplicar contorno gris al modal para dispositivos offline
                        const modalContent = modal.querySelector('.modal-content');
                        modalContent.style.border = '3px solid #2c3e50';
                        modalContent.style.boxShadow = '0 10px 30px rgba(44, 62, 80, 0.4)';
                        
                        statusesContainer.innerHTML = `
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🚫 Out of Service</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🔥 Fire Service</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>📞 Phone Comm</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>💧 Pit Flooded</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🏢 Elevator at DZ</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🚀 Elevator Moving</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                        `;
                    }
                } else {
                    // Si hay error en la respuesta de la API
                    timestamp.textContent = 'Error loading real-time data';
                    statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading device status</div>';
                }
            } catch (error) {
                timestamp.textContent = 'Error loading real-time data';
                statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading device status</div>';
            }
        }

        // Función para crear tarjeta de reporte
        function createReportCard(report) {
            const card = document.createElement('div');
            card.className = 'report-card';
            
            card.innerHTML = `
                <div class="item-card-header">
                    <div class="item-info">
                        <div class="item-icon">📊</div>
                        <div class="item-details">
                            <h4>${report.title}</h4>
                            <p>${report.type}</p>
                        </div>
                    </div>
                    <span class="status-badge ${report.status.toLowerCase()}">${report.status}</span>
                </div>
                <div class="item-meta">
                    <span class="item-location">Date: ${report.date}</span>
                </div>
            `;
            
            return card;
        }

        // Función para crear tarjeta de dispositivo
        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card';
            
            const statusClass = device.status === 'Online' ? 'operational' : 'out-of-service';
            
            card.innerHTML = `
                <div class="item-icon">💻</div>
                <div class="item-details">
                    <h4>${device.name}</h4>
                    <p>${device.type} - ${device.location}</p>
                    <p>Last update: ${device.lastUpdate}</p>
                </div>
                <span class="status-badge ${statusClass}">${device.status}</span>
            `;
            
            return card;
        }

        // Función para crear tarjeta de usuario
        function createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'user-card';
            
            const statusClass = user.status === 'Active' ? 'operational' : 'out-of-service';
            
            card.innerHTML = `
                <div class="user-avatar">${user.name.charAt(0)}</div>
                <div class="item-details">
                    <h4>${user.name}</h4>
                    <p>${user.role} - ${user.email}</p>
                    <p>Last login: ${user.lastLogin}</p>
                </div>
                <span class="status-badge ${statusClass}">${user.status}</span>
            `;
            
            return card;
        }


        // Función para alternar bookmark
        function toggleBookmark(itemId) {
            const bookmarkBtn = event.target.closest('.bookmark-btn');
            bookmarkBtn.classList.toggle('active');
        }

        // Variable para controlar si el modal está abierto
        let isModalOpen = false;

        // Función para actualizar el timestamp con la hora actual
        function updateTimestamp() {
            const timestampElement = document.getElementById('elevator-timestamp');
            if (timestampElement && isModalOpen) {
                const now = new Date();
                const localTime = now.toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                timestampElement.textContent = `Last Update: ${localTime}`;
            }
        }

        // Función para iniciar el timestamp dinámico (solo actualizar una vez al abrir)
        function startDynamicTimestamp() {
            isModalOpen = true;
            updateTimestamp();
        }

        // Función para detener el timestamp dinámico
        function stopDynamicTimestamp() {
            isModalOpen = false;
        }

        // Función para abrir modal del elevador
        function openElevatorModal(elevator) {
            document.getElementById('elevator-title').textContent = elevator.name;
            startDynamicTimestamp();
            document.getElementById('elevator-modal').style.display = 'flex';
        }

        // Función para cerrar modal del elevador
        function closeElevatorModal() {
            stopDynamicTimestamp();
            document.getElementById('elevator-modal').style.display = 'none';
        }

        // Función para filtrar elevadores (versión simplificada eliminada - usando la versión async)

        // Función auxiliar para ordenar dispositivos por alarmas (alarmas primero)
        async function sortDevicesByAlarms(devices) {
            try {
                // Obtener datos de la API para verificar alarmas
                const apiData = await getApiDataWithCache();
                
                if (apiData && apiData.success && apiData.data && Array.isArray(apiData.data)) {
                    const devicesWithAlarms = [];
                    const devicesWithoutAlarms = [];
                    
                    devices.forEach(device => {
                        const deviceData = apiData.data.find(d => d.device_id === device.deviceId);
                        
                        if (deviceData) {
                            const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                           deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
                            
                            if (hasAlarm) {
                                devicesWithAlarms.push(device);
                            } else {
                                devicesWithoutAlarms.push(device);
                            }
                        } else {
                            devicesWithoutAlarms.push(device);
                        }
                    });
                    
                    // Retornar ordenados: alarmas primero, luego el resto
                    return [...devicesWithAlarms, ...devicesWithoutAlarms];
                } else {
                    return devices;
                }
            } catch (error) {
                return devices;
            }
        }
        // Variable para evitar múltiples cargas simultáneas del dashboard
        let isLoadingDashboard = false;
        // Formatea un timestamp a "DD/MM/YYYY, HH:MM:SS (Bermuda Time)"
        function formatBermudaTimestamp(input) {
            try {
                if (input === undefined || input === null) return '';
                // Si ya viene en hora local de Bermuda, no convertir de nuevo
                if (typeof input === 'string' && input.includes('(Bermuda Time)')) {
                    const raw = input.trim();
                    const clean = raw.replace('(Bermuda Time)', '').trim();
                    let datePart = clean;
                    let timePart = '';
                    if (clean.includes(',')) {
                        const pieces = clean.split(',');
                        datePart = (pieces[0] || '').trim();
                        timePart = (pieces[1] || '').trim();
                    } else if (clean.includes(' ')) {
                        const pieces = clean.split(' ');
                        datePart = (pieces[0] || '').trim();
                        timePart = (pieces[1] || '').trim();
                    }
                    const d = datePart.split('/').map(v => v.trim());
                    let dd = d[0] || '';
                    let mm = d[1] || '';
                    let yyyy = d[2] || '';
                    if (dd.length === 1) dd = '0' + dd;
                    if (mm.length === 1) mm = '0' + mm;
                    if (timePart) {
                        // Normalizar HH:MM:SS
                        const t = timePart.split(':');
                        let HH = (t[0] || '00').padStart(2, '0');
                        let MM = (t[1] || '00').padStart(2, '0');
                        let SS = (t[2] || '00').padStart(2, '0');
                        return `${dd}/${mm}/${yyyy}, ${HH}:${MM}:${SS} (Bermuda Time)`;
                    }
                    return `${dd}/${mm}/${yyyy} (Bermuda Time)`;
                }
                let dateObj = null;
                if (typeof input === 'number' || (typeof input === 'string' && /^\d+$/.test(input.trim()))) {
                    dateObj = new Date(Number(input));
                } else if (typeof input === 'string') {
                    const raw = input.trim();
                    let clean = raw.replace('(Bermuda Time)', '').trim();
                    let day, month, year, hour = 0, minute = 0, second = 0;
                    // Intento 1: "DD/MM/YYYY, HH:MM:SS" o "MM/DD/YYYY, HH:MM:SS"
                    if (!dateObj && clean.includes(',')) {
                        const parts = clean.split(',');
                        const datePart = (parts[0] || '').trim();
                        const timePart = (parts[1] || '').trim();
                        const dateBits = datePart.split('/');
                        const timeBits = timePart.split(':');
                        const assumeDDMMYYYY = raw.includes('Bermuda Time');
                        if (dateBits.length === 3) {
                            if (assumeDDMMYYYY) {
                                day = parseInt(dateBits[0], 10);
                                month = parseInt(dateBits[1], 10);
                                year = parseInt(dateBits[2], 10);
                            } else {
                                month = parseInt(dateBits[0], 10);
                                day = parseInt(dateBits[1], 10);
                                year = parseInt(dateBits[2], 10);
                            }
                        }
                        if (timeBits.length >= 2) {
                            hour = parseInt(timeBits[0], 10) || 0;
                            minute = parseInt(timeBits[1], 10) || 0;
                            second = parseInt(timeBits[2], 10) || 0;
                        }
                        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                            dateObj = new Date(year, month - 1, day, hour, minute, second);
                        }
                    }
                    // Intento 2: "DD/MM/YYYY HH:MM:SS" o "MM/DD/YYYY HH:MM:SS"
                    if (!dateObj && clean.includes(' ')) {
                        const parts = clean.split(' ');
                        const datePart = (parts[0] || '').trim();
                        const timePart = (parts[1] || '').trim();
                        const dateBits = datePart.split('/');
                        const timeBits = timePart.split(':');
                        const assumeDDMMYYYY = raw.includes('Bermuda Time');
                        if (dateBits.length === 3) {
                            if (assumeDDMMYYYY) {
                                day = parseInt(dateBits[0], 10);
                                month = parseInt(dateBits[1], 10);
                                year = parseInt(dateBits[2], 10);
                            } else {
                                month = parseInt(dateBits[0], 10);
                                day = parseInt(dateBits[1], 10);
                                year = parseInt(dateBits[2], 10);
                            }
                        }
                        if (timeBits.length >= 2) {
                            hour = parseInt(timePart.split(':')[0], 10) || 0;
                            minute = parseInt(timePart.split(':')[1], 10) || 0;
                            second = parseInt(timePart.split(':')[2], 10) || 0;
                        }
                        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                            dateObj = new Date(year, month - 1, day, hour, minute, second);
                        }
                    }
                    // Intento 3: parseo directo
                    if (!dateObj) {
                        dateObj = new Date(raw);
                    }
                }
                if (!dateObj || isNaN(dateObj.getTime())) {
                    return String(input);
                }
                const formatted = dateObj.toLocaleString('en-GB', {
                    timeZone: 'Atlantic/Bermuda',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                return `${formatted} (Bermuda Time)`;
            } catch (_) {
                return String(input ?? '');
            }
        }
        // Función para cargar datos del dashboard
        async function loadDashboardData(currentUser = null, statusFilter = 'all') {
            const container = document.getElementById('dashboard-listings');
            if (!container) {
                return;
            }
            
            try {
                // Cargar datos de logs
                const logsResponse = await fetch('https://script.google.com/macros/s/AKfycbwmymPhQ89H9I0Mc25PYBYcgLSFANar8FyWbFTF0wCzk8OCbm6IXproy9YFhgKvpOJD_w/exec');
                const logsData = await logsResponse.json();
                
                if (!logsData.success || !logsData.data || !Array.isArray(logsData.data)) {
                    throw new Error('Error al cargar logs de la API');
                }
                
                // Obtener la fecha actual (solo día/mes/año)
                const now = new Date();
                const todayDay = now.getDate();
                const todayMonth = now.getMonth() + 1;
                const todayYear = now.getFullYear();
                
                // Filtrar logs por fecha (solo del día de hoy)
                let todayLogs = logsData.data.filter(log => {
                    const timestamp = log.timestamp || '';
                    
                    // Extraer la fecha del timestamp
                    let logDateStr = '';
                    
                    if (timestamp.includes(',')) {
                        logDateStr = timestamp.split(',')[0].trim();
                    } else if (timestamp.includes(' ')) {
                        logDateStr = timestamp.split(' ')[0].trim();
                    }
                    
                    // Parsear la fecha dependiendo del formato
                    let logDay, logMonth, logYear;
                    
                    if (timestamp.includes('Bermuda Time')) {
                        // Formato: DD/MM/YYYY (Bermuda Time)
                        const parts = logDateStr.split('/');
                        if (parts.length === 3) {
                            logDay = parseInt(parts[0]);
                            logMonth = parseInt(parts[1]);
                            logYear = parseInt(parts[2]);
                        }
                    } else {
                        // Formato: MM/DD/YYYY (estándar)
                        const parts = logDateStr.split('/');
                        if (parts.length === 3) {
                            logMonth = parseInt(parts[0]);
                            logDay = parseInt(parts[1]);
                            logYear = parseInt(parts[2]);
                        }
                    }
                    
                    // Comparar fecha
                    const isToday = (logDay === todayDay && logMonth === todayMonth && logYear === todayYear);
                    
                    return isToday;
                });
                
                // Filtrar logs por usuario
                let userLogs = todayLogs;
                
                if (currentUser && currentUser.email) {
                    if (currentUser.role === 'Admin' || currentUser.role === 'Technician') {
                        // Admin/Technician ve todos los logs
                    } else {
                        userLogs = todayLogs.filter(log => {
                            const logEmail = log.owner_email ? String(log.owner_email).toLowerCase() : '';
                            const userEmail = currentUser.email.toLowerCase();
                            
                            // Extraer la parte del correo antes del guión (si existe)
                            const logEmailBase = logEmail.split('-')[0];
                            const userEmailBase = userEmail.split('-')[0];
                            
                            return logEmailBase === userEmailBase;
                        });
                    }
                }
                
                // Aplicar filtro de estado (operational = logs verdes/resueltos, out-of-service = logs rojos/alarma)
                if (statusFilter === 'operational') {
                    userLogs = userLogs.filter(log => {
                        const newValue = log.new_value;
                        return (newValue === false || newValue === 'false');
                    });
                } else if (statusFilter === 'out-of-service') {
                    userLogs = userLogs.filter(log => {
                        const newValue = log.new_value;
                        const inputChanged = log.input_changed;
                        // Solo mostrar alarmas (newValue = true) y excluir AT_FLOOR y MOVING
                        return (newValue === true || newValue === 'true') && inputChanged !== 'AT_FLOOR' && inputChanged !== 'MOVING';
                    });
                }
                
                // Limpiar y crear tarjetas de logs
                container.innerHTML = '';
                
                if (userLogs.length === 0) {
                    // Crear tarjeta de "sin cambios"
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'toast';
                    emptyCard.innerHTML = `
                        <span class="icon" style="background: #3498db;">ℹ️</span>
                        <span class="msg">
                            <strong>Sin actividad</strong><br>
                            <small>No hay cambios registrados hoy</small>
                        </span>
                        <div class="progress" style="background: #3498db;"></div>
                    `;
                    container.appendChild(emptyCard);
                    return;
                }
                
                // Invertir el orden: más reciente primero
                const sortedLogs = [...userLogs].reverse();
                
                // Crear una tarjeta por cada log (más reciente arriba)
                sortedLogs.forEach(log => {
                    const card = document.createElement('div');
                    card.className = 'toast';
                    
                    const deviceId = log.device_id;
                    const inputChanged = log.input_changed;
                    const oldValue = log.old_value;
                    const newValue = log.new_value;
                    const timestamp = log.timestamp;
                    
                    // Omitir eventos informativos que no deben mostrarse
                    if (inputChanged === 'AT_FLOOR' || inputChanged === 'MOVING') {
                        return; // no crear toast
                    }
                    
                    // Determinar color según el cambio
                    let statusColor, icon, changeText;
                    
                    // Excepciones: AT_FLOOR y MOVING no deben mostrarse como alerta
                    if (inputChanged === 'AT_FLOOR' || inputChanged === 'MOVING') {
                        statusColor = '#3498db';
                        icon = 'ℹ';
                        const oldTxt = (oldValue === true || oldValue === 'true') ? 'ON' : 'OFF';
                        const newTxt = (newValue === true || newValue === 'true') ? 'ON' : 'OFF';
                        changeText = `${inputChanged}: ${oldTxt} → ${newTxt}`;
                    } else if (newValue === true || newValue === 'true') {
                        // Cambió a true = ROJO = ALARMA ACTIVADA
                        statusColor = '#e74c3c';
                        icon = '🚨';
                        changeText = `${inputChanged}: OFF → ON`;
                    } else if (newValue === false || newValue === 'false') {
                        // Cambió a false = VERDE = ALARMA DESACTIVADA
                        statusColor = '#27ae60';
                        icon = '✔';
                        changeText = `${inputChanged}: ON → OFF`;
                    } else {
                        // Otro tipo de cambio
                        statusColor = '#3498db';
                        icon = 'ℹ';
                        changeText = `${inputChanged}: ${oldValue} → ${newValue}`;
                    }
                    
                    card.innerHTML = `
                        <span class="icon" style="background: ${statusColor};">${icon}</span>
                        <span class="msg">
                            <strong>${deviceId}</strong><br>
                            <small>${changeText}</small><br>
                            <small style="opacity: 0.7;">${formatBermudaTimestamp(timestamp)}</small>
                        </span>
                        <div class="progress" style="background: ${statusColor};"></div>
                    `;
                    
                    card.onclick = function() {
                    };
                    
                    container.appendChild(card);
                });
                
            } catch (error) {
                container.innerHTML = '<div style="color: white; padding: 20px;">Error de conexión</div>';
            }
            
            return Promise.resolve();
        }
        // Variable para evitar múltiples cargas simultáneas
        let isLoadingUnits = false;
        // Variable global para mantener el filtro activo en el dashboard
        let currentStatusFilter = 'all';
        // Función para cargar datos de unidades
        async function loadUnitsData(elevatorsToShow = null, currentUser = null) {
            // Evitar múltiples cargas simultáneas
            if (isLoadingUnits) {
                return Promise.resolve();
            }
            
            isLoadingUnits = true;
            
            // Limpiar datos corruptos al inicio
            allDevicesData = [];
            
            const container = document.getElementById('units-grid');
            
            if (!container) {
                isLoadingUnits = false;
                return;
            }
            
            // Si se proporcionan elevadores específicos (para filtros), usar esos
            if (elevatorsToShow) {
                container.innerHTML = '';
                elevatorsToShow.forEach(elevator => {
                const card = createElevatorCard(elevator);
                container.appendChild(card);
            });
                isLoadingUnits = false; // Liberar la bandera
                return;
            }
            
            // Mostrar indicador de carga
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">Cargando dispositivos...</div>';
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    
                    // Filtrar por usuario si está especificado
                    let filteredData = data.data;
                    if (currentUser && currentUser.email) {
                        if (currentUser.role === 'Admin' || currentUser.role === 'Technician') {
                            filteredData = data.data;
                        } else {
                            filteredData = data.data.filter(device => {
                                const deviceEmail = device.clientEmail ? String(device.clientEmail).toLowerCase() : '';
                                const userEmail = currentUser.email.toLowerCase();
                                
                                // Extraer la parte del correo antes del guión (si existe)
                                const deviceEmailBase = deviceEmail.split('-')[0];
                                const userEmailBase = userEmail.split('-')[0];
                                
                                const matches = deviceEmailBase === userEmailBase;
                                return matches;
                            });
                        }
                    }
                    
                    // Limpiar y validar datos antes de guardar
                    allDevicesData = filteredData.filter(device => {
                        return device && 
                               device.deviceId && 
                               device.deviceId !== "Sin ID" && 
                               String(device.deviceId).trim() !== "" &&
                               device.buildingName &&
                               device.unitElevator &&
                               !device.deviceId.includes('console.log') &&
                               !device.deviceId.includes('elevator_control_app.html');
                    });
                    
                    // Guardar en localStorage para búsquedas rápidas
                    try {
                        localStorage.setItem('cachedDevices', JSON.stringify(allDevicesData));
                    } catch (error) {
                    }
                    
                    // Limpiar contenedor
                    container.innerHTML = '';
                    
                    // Filtrar dispositivos válidos (usar filteredData en lugar de data.data)
                    const validDevices = filteredData.filter(device => {
                        const isValid = device.deviceId && 
                                      device.deviceId !== "Sin ID" && 
                                      String(device.deviceId).trim() !== "";
                        return isValid;
                    });
                    
                    // Procesar dispositivos sin verificación de Firebase
                    const devicesWithStatus = validDevices.map(device => ({
                        ...device,
                        firebaseConnected: false
                    }));

                    // Ordenar dispositivos: alarmas activas primero, luego el resto
                    const sortedDevices = await sortDevicesByAlarms(devicesWithStatus);

                    // Mostrar todos los dispositivos válidos ordenados
                    for (let index = 0; index < sortedDevices.length; index++) {
                        const device = sortedDevices[index];
                        const card = await createDeviceElevatorCard(device, index);
                        if (card) {
                            container.appendChild(card);
                        }
                    }
                    
                    // Si no hay dispositivos válidos, mostrar mensaje específico
                    if (validDevices.length === 0) {
                        if (currentUser && currentUser.role === 'Client') {
                            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;"><h3>No tienes dispositivos asignados</h3><p>Contacta al administrador para obtener acceso a tus elevadores.</p></div>';
                        } else {
                            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No hay dispositivos registrados</div>';
                        }
                    }
                    
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar dispositivos</div>';
                }
            } catch (error) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al conectar con el servidor</div>';
            } finally {
                // Liberar la bandera de carga
                isLoadingUnits = false;
            }
        }

        // Función para cargar datos de servicio
        function loadServiceData() {
            // Esta función ya no se usa, el contenido se maneja con el formulario
        }

        // Función para enviar reporte de servicio por email (usando Google Apps Script)
        async function sendServiceReportByEmail(serviceEntry) {
            try {
                // Enviar a un solo correo
                const emailResult = await sendEmailViaForm(SERVICE_REPORT_EMAIL, serviceEntry);
                
                if (emailResult.success) {
                    return { success: true, message: 'Service report sent by email successfully!' };
                } else {
                    return { success: false, message: 'Email failed to send' };
                }
                
            } catch (error) {
                return { success: false, message: 'Error sending service report by email' };
            }
        }
        
        // Función auxiliar para enviar email via formulario
        function sendEmailViaForm(toEmail, serviceEntry) {
            return new Promise((resolve) => {
                try {
                    
                    // Crear formulario para enviar por email
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = 'https://script.google.com/macros/s/AKfycbwSHv8Ygw7oWLImpCYg1JVaqmS8WZCidCmqwEnI4Knp-rCc-D7qvrZYhQbwoIqx6Qpjdw/exec';
                    form.target = 'hiddenIframe_' + Date.now(); // Iframe único para cada envío
                    form.style.display = 'none';
                    
                    // Agregar campos del formulario
                    const fields = {
                        action: 'send_service_report',
                        toEmail: toEmail,
                        deviceId: serviceEntry.deviceId,
                        deviceName: serviceEntry.device,
                        serviceType: serviceEntry.type,
                        serviceNotes: serviceEntry.notes,
                        serviceDate: serviceEntry.date,
                        reportId: serviceEntry.id,
                        companyName: 'BERMUDA ELEVATOR',
                        supportEmail: 'jose@elevator.bm'
                    };
                    
                    Object.keys(fields).forEach(key => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = fields[key];
                        form.appendChild(input);
                    });
                    
                    // Crear iframe oculto para la respuesta
                    const iframe = document.createElement('iframe');
                    iframe.name = form.target;
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                    
                    // Agregar formulario al DOM y enviarlo
                    document.body.appendChild(form);
                    form.submit();
                    
                    // Limpiar formulario e iframe después del envío
                    setTimeout(() => {
                        if (document.body.contains(form)) {
                            document.body.removeChild(form);
                        }
                        if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                        }
                    }, 2000);
                    
                    resolve({ success: true });
                    
                } catch (error) {
                    resolve({ success: false });
                }
            });
        }
        // Function to load devices in reports select
        async function loadReportDevices() {
            const select = document.getElementById('reportDeviceSelect');
            if (!select) {
                return;
            }

            // Show loading state
            select.innerHTML = '<option value="all">Loading devices...</option>';
            select.disabled = true;

            try {
                // Use reports API to get unique devices
                const apiData = await fetchReportsData();
                //console.log(
                // Extract unique devices from reports data
                const uniqueDevices = [...new Set(apiData.map(item => item.device_id))].filter(id => id);
                
                //console.log(
                // Clear existing options
                select.innerHTML = '';
                
                // Add "All devices" option
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All Devices';
                allOption.selected = true;
                select.appendChild(allOption);
                
                if (uniqueDevices.length === 0) {
                    // No valid devices
                    const noDevicesOption = document.createElement('option');
                    noDevicesOption.value = '';
                    noDevicesOption.textContent = 'No devices available';
                    noDevicesOption.disabled = true;
                    select.appendChild(noDevicesOption);
                    //console.log(
                } else {
                    // Add unique devices found
                    uniqueDevices.forEach(deviceId => {
                        const option = document.createElement('option');
                        option.value = deviceId;
                        option.textContent = `Device ${deviceId}`;
                        select.appendChild(option);
                    });
                    
                    //console.log(
                }
                
                // Enable select
                select.disabled = false;
                //console.log(
            } catch (error) {
                //console.error(
                // Show error message
                select.innerHTML = '<option value="all">Error loading devices</option>';
                select.disabled = false;
                
                // Show error message to user
                const reportMsg = document.getElementById('reportMsg');
                if (reportMsg) {
                    reportMsg.textContent = 'Error loading devices. Using default data.';
                    reportMsg.className = 'success-msg error';
                    setTimeout(() => {
                        reportMsg.textContent = '';
                        reportMsg.className = '';
                    }, 5000);
                }
            }
        }

        // Función para cargar edificios desde la API de dispositivos
        async function loadBuildingsFromAPI() {
            //console.log(
            const select = document.getElementById('allowedBuildings');
            if (!select) {
                //console.error(
                return;
            }
            
            select.innerHTML = '<option value="">Loading buildings...</option>';
            select.disabled = true;
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                //console.log(
                const data = await response.json();
                //console.log(
                if (data.success && data.data && Array.isArray(data.data)) {
                    //console.log(
                    select.innerHTML = '';
                    
                    // Extraer edificios únicos de los dispositivos
                    const buildings = [...new Set(data.data
                        .filter(device => device.buildingName && device.buildingName.trim() !== '')
                        .map(device => device.buildingName.trim())
                    )];
                    
                    //console.log(
                    if (buildings.length === 0) {
                        const noBuildingsOption = document.createElement('option');
                        noBuildingsOption.value = '';
                        noBuildingsOption.textContent = 'No buildings available';
                        noBuildingsOption.disabled = true;
                        select.appendChild(noBuildingsOption);
                        //console.log(
                    } else {
                        buildings.forEach(building => {
                            const option = document.createElement('option');
                            option.value = building;
                            option.textContent = building;
                            select.appendChild(option);
                            //console.log(
                        });
                    }
                    
                    select.disabled = false;
                    //console.log(
                } else {
                    //console.error(
                    select.innerHTML = '<option value="">Error loading buildings</option>';
                    select.disabled = false;
                }
            } catch (error) {
                //console.error(
                select.innerHTML = '<option value="">Error connecting to server</option>';
                select.disabled = false;
            }
        }

        // Función para cargar dispositivos en el select de servicio
        async function loadServiceDevices() {
            //console.log(
            // Obtener usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            //console.log(
            const select = document.getElementById('serviceDeviceSelect');
            if (!select) {
                //console.error(
                return;
            }

            // Mostrar estado de carga
            select.innerHTML = '<option value="">Loading devices...</option>';
            select.disabled = true;

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                //console.log(
                const data = await response.json();
                //console.log(
                if (data.success && data.data && Array.isArray(data.data)) {
                    //console.log(
                    // Filtrar por usuario si está especificado
                    let filteredData = data.data;
                    if (currentUser && currentUser.email) {
                        //console.log(
                        //console.log(
                        //console.log(
                        if (currentUser.role === 'Admin' || currentUser.role === 'Technician') {
                            //console.log(
                            filteredData = data.data;
                        } else {
                            //console.log(
                            filteredData = data.data.filter(device => {
                                const deviceEmail = device.clientEmail ? String(device.clientEmail).toLowerCase() : '';
                                const userEmail = currentUser.email.toLowerCase();
                                
                                // Extraer la parte del correo antes del guión (si existe)
                                const deviceEmailBase = deviceEmail.split('-')[0];
                                const userEmailBase = userEmail.split('-')[0];
                                
                                const matches = deviceEmailBase === userEmailBase;
                                //console.log(
                                return matches;
                            });
                            //console.log(
                        }
                    }
                    
                    // Limpiar opciones existentes
                    select.innerHTML = '';
                    
                    // Filtrar dispositivos válidos (usar filteredData)
                    const validDevices = filteredData.filter(device => {
                        const isValid = device.deviceId && 
                                      device.deviceId !== "Sin ID" && 
                                      String(device.deviceId).trim() !== "";
                        return isValid;
                    });
                    
                    //console.log(
                    if (validDevices.length === 0) {
                        // No hay dispositivos válidos
                        const noDevicesOption = document.createElement('option');
                        noDevicesOption.value = '';
                        if (currentUser && currentUser.role === 'Client') {
                            noDevicesOption.textContent = 'No tienes dispositivos asignados';
                        } else {
                            noDevicesOption.textContent = 'No devices available';
                        }
                        noDevicesOption.disabled = true;
                        select.appendChild(noDevicesOption);
                        //console.log(
                    } else {
                        // Agregar opción por defecto
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Select a device...';
                        defaultOption.disabled = true;
                        defaultOption.selected = true;
                        select.appendChild(defaultOption);
                        
                        // Agregar dispositivos válidos
                        validDevices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.deviceId;
                            option.textContent = `${device.buildingName} - ${device.unitElevator} (${device.deviceId})`;
                            select.appendChild(option);
                            //console.log(
                        });
                    }
                    
                    // Habilitar el select
                    select.disabled = false;
                    //console.log(
                } else {
                    //console.error(
                    select.innerHTML = '<option value="">Error loading devices</option>';
                    select.disabled = false;
                }
            } catch (error) {
                //console.error(
                select.innerHTML = '<option value="">Error connecting to server</option>';
                select.disabled = false;
            }
        }

        // Variable global para almacenar todos los dispositivos
        let allDevicesData = [];
        
        // Cache de datos de la API para mejorar rendimiento
        let apiDataCache = null;
        let cacheTimestamp = null;
        const CACHE_DURATION = 30000; // 30 segundos de cache
        
        // Variables para actualización automática
        let autoUpdateInterval = null;
        const AUTO_UPDATE_DELAY = 5000; // 5 segundos antes de comenzar
        const AUTO_UPDATE_INTERVAL = 15000; // 15 segundos entre actualizaciones
        
        // Configuración de emails de destino para reportes de servicio
        const SERVICE_REPORT_EMAIL = 'jose@elevator.bm'; // Email principal

        // Función para obtener datos de la API con cache
        async function getApiDataWithCache() {
            const now = Date.now();
            
            // Verificar si tenemos cache válido
            if (apiDataCache && cacheTimestamp && (now - cacheTimestamp) < CACHE_DURATION) {
                //console.log(
                return apiDataCache;
            }
            
            // Verificar localStorage
            const cachedData = localStorage.getItem('elevatorApiData');
            const cachedTimestamp = localStorage.getItem('elevatorApiTimestamp');
            
            if (cachedData && cachedTimestamp && (now - parseInt(cachedTimestamp)) < CACHE_DURATION) {
                //console.log(
                apiDataCache = JSON.parse(cachedData);
                cacheTimestamp = parseInt(cachedTimestamp);
                return apiDataCache;
            }
            
            try {
                //console.log(
                const response = await fetch('https://script.google.com/macros/s/AKfycbyyoDNlKjoSYVX4fUg8nrYCGkidCt9RIz6mswQcq73oxmb0xkGwkE14Du5XOyP7rzlQ/exec');
                const data = await response.json();
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    // Guardar en cache en memoria
                    apiDataCache = data;
                    cacheTimestamp = now;
                    
                    // Guardar en localStorage
                    localStorage.setItem('elevatorApiData', JSON.stringify(data));
                    localStorage.setItem('elevatorApiTimestamp', now.toString());
                    
                    //console.log(
                    return data;
                } else {
                    //console.error(
                    return null;
                }
            } catch (error) {
                //console.error(
                return null;
            }
        }
        
        // Función para limpiar el cache
        function clearApiCache() {
            apiDataCache = null;
            cacheTimestamp = null;
            localStorage.removeItem('elevatorApiData');
            localStorage.removeItem('elevatorApiTimestamp');
            //console.log(
        }
        
        // Función para forzar actualización de datos
        async function forceRefreshApiData() {
            clearApiCache();
            return await getApiDataWithCache();
        }
        
        // Función para actualizar solo las tarjetas de Units
        async function refreshUnitsOnly() {
            //console.log(
            const button = document.getElementById('refresh-units-btn');
            const svg = button.querySelector('svg');
            
            try {
                // Agregar animación de rotación al SVG
                svg.style.animation = 'spin 1s linear infinite';
                button.disabled = true;
                
                // Limpiar cache para obtener datos frescos
                clearApiCache();
                
                // Obtener usuario actual
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                // Recargar solo Units
                await loadUnitsData(null, currentUser);
                
                //console.log(
            } catch (error) {
                //console.error(
            } finally {
                // Restaurar botón
                svg.style.animation = '';
                button.disabled = false;
            }
        }
        // Función para actualizar solo la información de las tarjetas existentes
        async function updateExistingCards() {
            //console.log(
            // Evitar llamadas si las secciones relevantes no están visibles
            const dashboardScreen = document.getElementById('dashboard-screen');
            const unitsScreen = document.getElementById('units-screen');
            const isDashboardVisible = dashboardScreen && dashboardScreen.classList.contains('active');
            const isUnitsVisible = unitsScreen && unitsScreen.classList.contains('active');
            if (!isDashboardVisible && !isUnitsVisible) {
                //console.log(
                return;
            }
            
            try {
                // Obtener datos frescos de la API
                const data = await getApiDataWithCache();
                
                if (data && data.success && data.data && Array.isArray(data.data)) {
                    //console.log(
                    // Actualizar tarjetas del Dashboard (solo si está visible)
                    const dashboardContainer = document.getElementById('dashboard-listings');
                    if (isDashboardVisible && dashboardContainer) {
                        const dashboardCards = dashboardContainer.querySelectorAll('.item-card');
                        //console.log(
                        dashboardCards.forEach((card, index) => {
                            const deviceId = card.getAttribute('data-device-id');
                            //console.log(
                            if (deviceId) {
                                const deviceData = data.data.find(d => d.device_id === deviceId);
                                if (deviceData) {
                                    //console.log(
                                    updateCardStatus(card, deviceData);
                                } else {
                                    //console.log(
                                }
                            } else {
                                //console.log(
                            }
                        });
                    }
                    
                    // Actualizar tarjetas de Units (solo si está visible)
                    const unitsContainer = document.getElementById('units-grid');
                    if (isUnitsVisible && unitsContainer) {
                        const unitsCards = unitsContainer.querySelectorAll('.item-card');
                        //console.log(
                        unitsCards.forEach((card, index) => {
                            const deviceId = card.getAttribute('data-device-id');
                            //console.log(
                            if (deviceId) {
                                const deviceData = data.data.find(d => d.device_id === deviceId);
                                if (deviceData) {
                                    //console.log(
                                    updateCardStatus(card, deviceData);
                                } else {
                                    //console.log(
                                }
                            } else {
                                //console.log(
                            }
                        });
                    } else if (isUnitsVisible) {
                        //console.log(
                    }
                    
                    //console.log(
                    // Actualizar timestamp si el modal está abierto
                    updateTimestamp();
                }
            } catch (error) {
                //console.error(
            }
        }
        // Función para actualizar el estado de una tarjeta específica
        function updateCardStatus(card, deviceData) {
            const deviceId = deviceData.device_id;
            const deviceTimestamp = deviceData.timestamp;
            
            // Verificar si el dispositivo está offline (han pasado más de 60 segundos desde su timestamp)
            const now = new Date();
            const deviceTime = new Date(deviceTimestamp);
            const timeDiff = now - deviceTime;
            const secondsDiff = timeDiff / 1000;
            
            let isOffline = false;
            // Solo marcar como offline si han pasado más de 60 segundos Y el timestamp es muy antiguo
            if (secondsDiff > 60) {
                isOffline = true;
                //console.log(
            } else {
                //console.log(
            }
            
            //console.log(
            // Verificar si hay alarmas activas
            const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                           deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
            
            let status = 'operational';
            let statusClass = 'operational';
            let progressColor = '#27ae60';
            
            // Prioridad: OFFLINE > ALARM > OPERATIONAL
            if (isOffline) {
                status = 'OFFLINE';
                statusClass = 'offline';
                progressColor = '#95a5a6';
                //console.log(
            } else if (hasAlarm) {
                status = 'ALARM';
                statusClass = 'alarm';
                progressColor = '#e74c3c';
                //console.log(
            }
            
            // Buscar elementos con selectores más específicos
            const statusBadge = card.querySelector('.item-meta .status-badge') ||
                              card.querySelector('.status-badge') ||
                              card.querySelector('[class*="status-badge"]');
            
            const progressFill = card.querySelector('.progress-bar .progress-fill') ||
                               card.querySelector('.progress-fill') ||
                               card.querySelector('[class*="progress-fill"]');
            
            //console.log(
            if (statusBadge) {
                const oldText = statusBadge.textContent;
                const oldClass = statusBadge.className;
                
                statusBadge.textContent = status;
                statusBadge.className = `status-badge ${statusClass}`;
                
                //console.log(
                //console.log(
            } else {
                //console.error(
                //console.log(
                // Búsqueda alternativa más agresiva
                const allSpans = card.querySelectorAll('span');
                const statusSpan = Array.from(allSpans).find(span => 
                    span.textContent === 'operational' || 
                    span.textContent === 'ALARM' ||
                    span.textContent === 'OFFLINE' ||
                    span.className.includes('status-badge')
                );
                
                if (statusSpan) {
                    //console.log(
                    statusSpan.textContent = status;
                    statusSpan.className = `status-badge ${statusClass}`;
                    //console.log(
                } else {
                    //console.error(
                }
            }
            
            if (progressFill) {
                const oldColor = progressFill.style.backgroundColor;
                progressFill.style.backgroundColor = progressColor;
                
                //console.log(
            } else {
                //console.error(
                //console.log(
                // Búsqueda alternativa para progress-fill
                const allDivs = card.querySelectorAll('div');
                const progressDiv = Array.from(allDivs).find(div => 
                    div.className.includes('progress-fill') ||
                    div.style.backgroundColor === 'rgb(39, 174, 96)' ||
                    div.style.backgroundColor === 'rgb(231, 76, 60)' ||
                    div.style.backgroundColor === 'rgb(149, 165, 166)'
                );
                
                if (progressDiv) {
                    //console.log(
                    progressDiv.style.backgroundColor = progressColor;
                    //console.log(
                } else {
                    //console.error(
                }
            }
        }
        
        // Función para iniciar actualización automática
        function startAutoUpdate() {
            //console.log(
            //console.log(
            // Limpiar intervalo existente si hay uno
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
            
            // Esperar 5 segundos antes de comenzar
            setTimeout(() => {
                //console.log(
                // Actualizar inmediatamente
                updateExistingCards();
                
                // También actualizar el Dashboard si está visible
                const dashboardScreen = document.getElementById('dashboard-screen');
                if (dashboardScreen && dashboardScreen.classList.contains('active')) {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    loadDashboardData(currentUser, currentStatusFilter);
                }
                
                // Configurar intervalo cada 15 segundos
                autoUpdateInterval = setInterval(() => {
                    //console.log(
                    updateExistingCards();
                    
                    // También actualizar el Dashboard si está visible
                    const dashboardScreen = document.getElementById('dashboard-screen');
                    if (dashboardScreen && dashboardScreen.classList.contains('active')) {
                        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                        loadDashboardData(currentUser, currentStatusFilter);
                    }
                }, AUTO_UPDATE_INTERVAL);
                
            }, AUTO_UPDATE_DELAY);
        }
        
        // Función para detener actualización automática
        function stopAutoUpdate() {
            //console.log(
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
            }
        }
        // Función para actualizar todas las APIs
        async function refreshAllAPIs() {
            //console.log(
            // Limpiar cache para obtener datos frescos
            clearApiCache();
            
            // Obtener usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            const button = document.getElementById('refresh-all-btn');
            const svg = button.querySelector('svg');
            
            try {
                // Agregar animación de rotación al SVG existente
                svg.style.animation = 'spin 1s linear infinite';
                button.disabled = true;
                
                // Actualizar Dashboard
                //console.log(
                await loadDashboardData(currentUser);
                
                // Actualizar Units
                //console.log(
                await loadUnitsData(null, currentUser);
                
                
                // Actualizar dispositivos si estamos en la pantalla de dispositivos
                if (document.getElementById('devices-screen').classList.contains('active')) {
                    //console.log(
                    await loadDevicesData();
                }
                
                // Actualizar usuarios si estamos en la pantalla de usuarios
                if (document.getElementById('users-screen').classList.contains('active')) {
                    //console.log(
                    await loadRealUsersData();
                }
                
                //console.log(
                // Mostrar mensaje de éxito
                const deviceMsg = document.getElementById('deviceMsg');
                if (deviceMsg) {
                    deviceMsg.textContent = 'Todas las APIs actualizadas exitosamente';
                    deviceMsg.className = 'success';
                    
                    setTimeout(() => {
                        deviceMsg.textContent = '';
                        deviceMsg.className = '';
                    }, 3000);
                }
                
            } catch (error) {
                //console.error(
                // Mostrar mensaje de error
                const deviceMsg = document.getElementById('deviceMsg');
                if (deviceMsg) {
                    deviceMsg.textContent = 'Error actualizando algunas APIs';
                    deviceMsg.className = 'error';
                    
                    setTimeout(() => {
                        deviceMsg.textContent = '';
                        deviceMsg.className = '';
                    }, 3000);
                }
            } finally {
                // Restaurar botón (solo quitar animación y habilitar)
                svg.style.animation = '';
                button.disabled = false;
            }
        }

        // Función para cargar edificios del usuario actual desde la API
        async function loadUserBuildings() {
            try {
                //console.log(
                // Obtener usuario actual
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (!currentUser.email) {
                    //console.log(
                    return;
                }
                
                //console.log(
                // Consultar la API para obtener todos los dispositivos
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                const data = await response.json();
                
                if (data.success && data.data) {
                    //console.log(
                    // Filtrar dispositivos por el email del usuario actual
                    const userDevices = data.data.filter(device => {
                        const deviceEmail = device.clientEmail ? device.clientEmail.toLowerCase() : '';
                        const userEmail = currentUser.email.toLowerCase();
                        
                        // Extraer la parte del correo antes del guión (si existe)
                        const deviceEmailBase = deviceEmail.split('-')[0];
                        const userEmailBase = userEmail.split('-')[0];
                        
                        const matches = deviceEmailBase === userEmailBase;
                        //console.log(
                        return matches;
                    });
                    
                    //console.log(
                    // Extraer edificios únicos del usuario
                    const uniqueBuildings = [...new Set(userDevices.map(device => device.buildingName))];
                    //console.log(
                    // Llenar el select con los edificios del usuario
                    const buildingSelect = document.getElementById('buildingFilter');
                    if (buildingSelect) {
                        // Limpiar opciones existentes (excepto "All Buildings")
                        buildingSelect.innerHTML = '<option value="all">All Buildings</option>';
                        
                        // Agregar edificios del usuario
                        uniqueBuildings.forEach(building => {
                            if (building && building.trim() !== '') {
                                const option = document.createElement('option');
                                option.value = building;
                                option.textContent = building;
                                buildingSelect.appendChild(option);
                            }
                        });
                        
                        //console.log(
                    }
                } else {
                    //console.error(
                }
            } catch (error) {
                //console.error(
            }
        }

        // Función para filtrar dispositivos por edificio y estado
        async function filterDevicesByBuildingAndStatus(building, status) {
            //console.log(
            //console.log(
            //console.log(
            // Navegar a la sección Units
            showScreen('units-screen');
            
            const container = document.getElementById('units-grid');
            if (!container) {
                //console.error(
                return;
            }
            
            // Obtener usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Cargar datos y aplicar filtros
            await loadUnitsData(null, currentUser);
            
            // Filtrar dispositivos por edificio
            let filteredDevices = allDevicesData || [];
            
            if (building !== 'all') {
                filteredDevices = filteredDevices.filter(device => 
                    device.buildingName && device.buildingName.toLowerCase() === building.toLowerCase()
                );
                //console.log(
            }
            
            // Filtrar por estado (si no es 'all')
            if (status !== 'all') {
                try {
                    const apiData = await getApiDataWithCache();
                    if (apiData && apiData.success && apiData.data && Array.isArray(apiData.data)) {
                        if (status === 'out-of-service') {
                            // Filtrar solo dispositivos con alarmas
                            //console.log(
                            //console.log(
                            //console.log(
                            //console.log(
                            filteredDevices = filteredDevices.filter(device => {
                                const deviceData = apiData.data.find(d => d.device_id === device.deviceId);
                                //console.log(
                                if (deviceData) {
                                    const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                                   deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
                                    //console.log(
                                    return hasAlarm;
                                }
                                //console.log(
                                return false;
                            });
                            //console.log(
                        } else if (status === 'operational') {
                            // Filtrar solo dispositivos operacionales
                            filteredDevices = filteredDevices.filter(device => {
                                const deviceData = apiData.data.find(d => d.device_id === device.deviceId);
                                if (deviceData) {
                                    return !(deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                            deviceData.PHONE_COMM || deviceData.PIT_FLOODED);
                                }
                                return true; // Si no hay datos de API, asumir operacional
                            });
                            //console.log(
                        }
                    }
                } catch (error) {
                    //console.error(
                }
            }
            
            // Mostrar dispositivos filtrados
            await displayFilteredDevices(filteredDevices);
        }
        

        // Función para aplicar filtros a la vista actual sin navegar
        async function applyFiltersToCurrentView(building, status) {
            //console.log(
            // Determinar en qué sección estamos
            const currentScreen = getCurrentScreen();
            //console.log(
            if (currentScreen === 'units-screen') {
                // Si ya estamos en Units, aplicar filtros normalmente
                await filterDevicesByBuildingAndStatus(building, status);
            } else {
                // Si estamos en otra sección, solo mostrar mensaje informativo
                //console.log(
                // No hacer nada más para evitar recursión
            }
        }

        // Función para obtener la pantalla actual
        function getCurrentScreen() {
            const screens = ['dashboard-screen', 'units-screen', 'service-screen', 'reports-screen', 'users-screen', 'devices-screen'];
            for (const screen of screens) {
                const element = document.getElementById(screen);
                if (element && element.classList.contains('active')) {
                    return screen;
                }
            }
            return 'dashboard-screen'; // Por defecto
        }
        // Función para aplicar búsqueda con filtros
        async function applySearchWithFilters(searchTerm, navigateToUnits = true) {
            //console.log(
            //console.log(
            const container = document.getElementById('units-grid');
            if (!container) {
                //console.error(
                return;
            }
            
            // Obtener filtros actuales
            const selectedStatus = document.querySelector('input[name="status"]:checked')?.value || 'all';
            const selectedBuilding = document.getElementById('buildingFilter')?.value || 'all';
            
            //console.log(
            // Si no hay término de búsqueda, aplicar solo filtros
            if (!searchTerm || searchTerm.trim() === '') {
                //console.log(
                if (navigateToUnits) {
                    await filterDevicesByBuildingAndStatus(selectedBuilding, selectedStatus);
                } else {
                    // Aplicar filtros sin navegar, solo actualizar la vista actual
                    await applyFiltersToCurrentView(selectedBuilding, selectedStatus);
                }
                return;
            }
            
            // Navegar a la sección Units solo si se especifica
            if (navigateToUnits) {
                showScreen('units-screen');
            }
            
            // Cargar datos si no están disponibles
            if (!allDevicesData || allDevicesData.length === 0) {
                //console.log(
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                await loadUnitsData(null, currentUser);
            }
            
            // Validar que tenemos datos para buscar
            if (!allDevicesData || allDevicesData.length === 0) {
                //console.error(
                container.innerHTML = '<div class="no-data">No hay datos disponibles para buscar</div>';
                return;
            }
            
            // Filtrar por término de búsqueda
            let filteredDevices = allDevicesData.filter(device => {
                if (!device) return false;
                
                const deviceId = String(device.deviceId || '').toLowerCase();
                const building = String(device.buildingName || '').toLowerCase();
                const unit = String(device.unitElevator || '').toLowerCase();
                const email = String(device.clientEmail || '').toLowerCase();
                
                return deviceId.includes(searchTerm) ||
                       building.includes(searchTerm) ||
                       unit.includes(searchTerm) ||
                       email.includes(searchTerm);
            });
            
            //console.log(
            // Aplicar filtro por edificio
            if (selectedBuilding !== 'all') {
                filteredDevices = filteredDevices.filter(device => 
                    device.buildingName && device.buildingName.toLowerCase() === selectedBuilding.toLowerCase()
                );
                //console.log(
            }
            
            // Aplicar filtro por estado (all vs operational vs alarm)
            if (selectedStatus === 'out-of-service') {
                // Filtrar solo dispositivos con alarmas
                try {
                    const apiData = await getApiDataWithCache();
                    if (apiData && apiData.success && apiData.data && Array.isArray(apiData.data)) {
                        //console.log(
                        //console.log(
                        //console.log(
                        //console.log(
                        filteredDevices = filteredDevices.filter(device => {
                            const deviceData = apiData.data.find(d => d.device_id === device.deviceId);
                            //console.log(
                            if (deviceData) {
                                const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                               deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
                                //console.log(
                                return hasAlarm;
                            }
                            //console.log(
                            return false;
                        });
                        //console.log(
                    }
                } catch (error) {
                    //console.error(
                }
            } else if (selectedStatus === 'operational') {
                // Filtrar solo dispositivos operacionales
                try {
                    const apiData = await getApiDataWithCache();
                    if (apiData && apiData.success && apiData.data && Array.isArray(apiData.data)) {
                        filteredDevices = filteredDevices.filter(device => {
                            const deviceData = apiData.data.find(d => d.device_id === device.deviceId);
                            if (deviceData) {
                                return !(deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                        deviceData.PHONE_COMM || deviceData.PIT_FLOODED);
                            }
                            return true; // Si no hay datos de API, asumir operacional
                        });
                        //console.log(
                    }
                } catch (error) {
                    //console.error(
                }
            } else if (selectedStatus === 'all') {
                // No aplicar filtro de estado, mostrar todos los dispositivos
                //console.log(
            }
            
            // Ordenar por alarmas y mostrar resultados
            const sortedFilteredDevices = await sortDevicesByAlarms(filteredDevices);
            //console.log(
            // Limpiar contenedor y mostrar resultados
            container.innerHTML = '';
            
            if (sortedFilteredDevices.length === 0) {
                container.innerHTML = `
                    <div class="no-data" style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>No se encontraron resultados</h3>
                        <p>No hay dispositivos que coincidan con "${searchTerm}"</p>
                        <button onclick="showScreen('dashboard-screen')" class="btn btn-primary" style="margin-top: 15px;">Volver al Dashboard</button>
                    </div>
                `;
                return;
            }
            
            // Mostrar dispositivos filtrados
            sortedFilteredDevices.forEach(async (device, index) => {
                //console.log(
                try {
                    const card = await createDeviceElevatorCard(device, index);
                    if (card && card instanceof Node) {
                        container.appendChild(card);
                    } else {
                        //console.error(
                    }
                } catch (error) {
                    //console.error(
                }
            });
            
            //console.log(
        }

        // Función para filtrar elevadores/dispositivos
        async function filterElevators(searchTerm) {
            //console.log(
            //console.log(
            const container = document.getElementById('units-grid');
            if (!container) {
                //console.error(
                return;
            }

            if (!searchTerm || searchTerm.trim() === '') {
                //console.log(
                // Recarga silenciosa sin navegar a Units
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                await loadUnitsData(null, currentUser);
                return;
            }

            // Navegar a la sección Units solo si hay búsqueda
            //console.log(
            showScreen('units-screen');

            //console.log(
            // 1. PRIMERO: Buscar en localStorage para búsqueda rápida
            const cachedDevices = localStorage.getItem('cachedDevices');
            if (cachedDevices) {
                try {
                    const devices = JSON.parse(cachedDevices);
                    //console.log(
                    const filteredDevices = devices.filter(device => {
                        const deviceId = String(device.deviceId || '').toLowerCase();
                        const building = String(device.buildingName || '').toLowerCase();
                        const unit = String(device.unitElevator || '').toLowerCase();
                        const email = String(device.clientEmail || '').toLowerCase();
                        
                        return deviceId.includes(searchTerm) ||
                               building.includes(searchTerm) ||
                               unit.includes(searchTerm) ||
                               email.includes(searchTerm);
                    });

                    //console.log(
                    if (filteredDevices.length > 0) {
                        // Mostrar resultados inmediatos del cache
                        displayFilteredDevices(filteredDevices);
                        return;
                    }
                } catch (error) {
                    //console.error(
                }
            }
            
            // 2. SEGUNDO: Si no hay cache o no hay resultados, cargar desde API
            //console.log(
            // Verificar si tenemos datos disponibles en memoria
            if (!allDevicesData || allDevicesData.length === 0) {
                //console.log(
                // Mostrar mensaje de carga
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">Cargando dispositivos para búsqueda...</div>';
                
                // Cargar datos y luego filtrar
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                await loadUnitsData(null, currentUser);
                //console.log(
                // Después de cargar, aplicar el filtro recursivamente
                await filterElevators(searchTerm);
                return;
            }
            
            // Filtrar dispositivos que coincidan con el término de búsqueda
            const filteredDevices = allDevicesData.filter(device => {
                const deviceId = String(device.deviceId || '').toLowerCase();
                const building = String(device.buildingName || '').toLowerCase();
                const unit = String(device.unitElevator || '').toLowerCase();
                const email = String(device.clientEmail || '').toLowerCase();
                
                return deviceId.includes(searchTerm) ||
                       building.includes(searchTerm) ||
                       unit.includes(searchTerm) ||
                       email.includes(searchTerm);
            });

            //console.log(
            // Ordenar dispositivos filtrados por alarmas (alarmas primero)
            const sortedFilteredDevices = await sortDevicesByAlarms(filteredDevices);
            //console.log(
            // Limpiar contenedor
            container.innerHTML = '';

            if (sortedFilteredDevices.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No se encontraron dispositivos que coincidan con la búsqueda</div>';
                return;
            }

            // Mostrar dispositivos filtrados ordenados
            sortedFilteredDevices.forEach(async (device, index) => {
                //console.log(
                try {
                    const card = await createDeviceElevatorCard(device, index);
                    if (card && card instanceof Node) {
                        container.appendChild(card);
                    } else {
                        //console.error(
                    }
                } catch (error) {
                    //console.error(
                }
            });

            //console.log(
        }

        // Función para mostrar dispositivos filtrados
        async function displayFilteredDevices(filteredDevices) {
            const container = document.getElementById('units-grid');
            if (!container) {
                //console.error(
                return;
            }

            if (filteredDevices.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No se encontraron dispositivos que coincidan con la búsqueda</div>';
                return;
            }

            // Ordenar dispositivos filtrados por alarmas (alarmas primero)
            const sortedFilteredDevices = await sortDevicesByAlarms(filteredDevices);
            //console.log(
            // Limpiar contenedor
            container.innerHTML = '';

            // Mostrar dispositivos filtrados ordenados
            sortedFilteredDevices.forEach(async (device, index) => {
                //console.log(
                try {
                    const card = await createDeviceElevatorCard(device, index);
                    if (card && card instanceof Node) {
                        container.appendChild(card);
                    } else {
                        //console.error(
                    }
                } catch (error) {
                    //console.error(
                }
            });

            //console.log(
        }


        // Función para agregar entrada de servicio
        async function addServiceEntry() {
            const deviceSelect = document.getElementById('serviceDeviceSelect');
            const serviceType = document.getElementById('serviceType');
            const serviceNotes = document.getElementById('serviceNotes');
            const serviceMsg = document.getElementById('serviceMsg');
            const serviceHistory = document.getElementById('serviceHistory');
            
            // Validar campos requeridos
            if (!deviceSelect.value || deviceSelect.value === '') {
                serviceMsg.textContent = 'Please select a device';
                serviceMsg.className = 'error';
                return;
            }
            
            if (!serviceNotes.value.trim()) {
                serviceMsg.textContent = 'Please enter service notes';
                serviceMsg.className = 'error';
                return;
            }
            
            // Crear entrada de servicio
            const serviceEntry = {
                id: Date.now(),
                device: deviceSelect.options[deviceSelect.selectedIndex].text,
                deviceId: deviceSelect.value,
                type: serviceType.value,
                notes: serviceNotes.value,
                date: new Date().toLocaleString('en-GB', {
                    timeZone: 'Atlantic/Bermuda',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }) + ' (Bermuda Time)',
                photos: 0
            };
            
            // Agregar al historial
            addToServiceHistory(serviceEntry);
            
            // Enviar reporte por email
            //console.log(
            const emailResult = await sendServiceReportByEmail(serviceEntry);
            
            // Limpiar formulario
            deviceSelect.selectedIndex = 0; // Resetear al primer elemento (Select a device...)
            serviceNotes.value = '';
            
            // Mostrar mensaje de éxito
            if (emailResult.success) {
                serviceMsg.textContent = 'Service entry added and report sent by email successfully!';
            serviceMsg.className = 'success';
            } else {
                serviceMsg.textContent = 'Service entry added, but email failed to send.';
                serviceMsg.className = 'error';
            }
            
            // Limpiar mensaje después de 5 segundos
            setTimeout(() => {
                serviceMsg.textContent = '';
                serviceMsg.className = '';
            }, 5000);
        }
        // Función para agregar entrada al historial
        function addToServiceHistory(entry) {
            // Guardar en localStorage para persistencia
            const existingHistory = JSON.parse(localStorage.getItem('serviceHistory') || '[]');
            existingHistory.unshift(entry); // Agregar al inicio
            localStorage.setItem('serviceHistory', JSON.stringify(existingHistory));
            
            // Mostrar en el modal
            displayServiceHistory();
        }
        
        // Función para mostrar el historial de servicios
        function displayServiceHistory() {
            const serviceHistory = document.getElementById('serviceHistory');
            const historyData = JSON.parse(localStorage.getItem('serviceHistory') || '[]');
            
            if (historyData.length === 0) {
                serviceHistory.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No service history yet</p>';
                return;
            }
            
            serviceHistory.innerHTML = '';
            
            historyData.forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'service-history-item';
                historyItem.id = `history-item-${entry.id}`;
                historyItem.style.cssText = `
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 10px;
                    border-left: 4px solid #3498db;
                `;
                historyItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 8px 0; color: #2c3e50;">${entry.device} - ${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)}</h4>
                            <p style="margin: 4px 0; color: #6c757d;"><strong>Date:</strong> ${entry.date}</p>
                            <p style="margin: 4px 0; color: #6c757d;"><strong>Notes:</strong> ${entry.notes}</p>
                            ${entry.photos > 0 ? `<p style="margin: 4px 0; color: #6c757d;"><strong>Photos:</strong> ${entry.photos} uploaded</p>` : ''}
                        </div>
                        <button class="delete-entry-btn" onclick="deleteHistoryEntry(${entry.id})" style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-left: 10px;">
                            Delete
                        </button>
                    </div>
                `;
                
                serviceHistory.appendChild(historyItem);
            });
        }

        // Función para borrar entrada individual
        function deleteHistoryEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry from the history?')) {
                // Remover del localStorage
                const existingHistory = JSON.parse(localStorage.getItem('serviceHistory') || '[]');
                const updatedHistory = existingHistory.filter(entry => entry.id !== entryId);
                localStorage.setItem('serviceHistory', JSON.stringify(updatedHistory));
                
                // Actualizar la visualización
                displayServiceHistory();
            }
        }

        // Función para abrir modal de historial
        function openServiceHistoryModal() {
            document.getElementById('service-history-modal').style.display = 'flex';
            // Cargar y mostrar el historial
            displayServiceHistory();
        }

        // Función para cerrar modal de historial
        function closeServiceHistoryModal() {
            document.getElementById('service-history-modal').style.display = 'none';
        }

        // Función para borrar todo el historial
        function clearServiceHistory() {
            if (confirm('Are you sure you want to delete ALL service history? This action cannot be undone.')) {
                // Limpiar localStorage
                localStorage.removeItem('serviceHistory');
                
                // Actualizar la visualización
                displayServiceHistory();
                
                // Mostrar mensaje de confirmación
                const serviceHistory = document.getElementById('serviceHistory');
                const originalContent = serviceHistory.innerHTML;
                serviceHistory.innerHTML = '<p style="text-align:center;color:#27ae60;padding:20px;font-weight:600;">All service history has been deleted successfully</p>';
                
                // Restaurar mensaje original después de 2 segundos
                setTimeout(() => {
                    serviceHistory.innerHTML = originalContent;
                }, 2000);
            }
        }

        // Función para cargar datos de reportes
        function loadReportsData() {
            // Esta función ya no se usa, el contenido se maneja con el formulario
        }
        // Función para generar reporte
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const deviceSelect = document.getElementById('reportDeviceSelect');
            const reportMsg = document.getElementById('reportMsg');
            
            let startDate, endDate, dateRangeText;
            
            if (reportType === 'summary') {
                // Para Monthly Summary, usar el selector de mes
                const monthValue = document.getElementById('reportMonth').value;
                if (!monthValue) {
                    reportMsg.textContent = 'Please select a month for Monthly Summary';
                    reportMsg.className = 'error';
                    return;
                }
                
                // Convertir mes seleccionado a rango de fechas
                const [year, month] = monthValue.split('-');
                startDate = `${year}-${month}-01`;
                endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;
                dateRangeText = `${monthValue} (${startDate} to ${endDate})`;
            } else {
                // Para otros tipos de reporte, usar date range
                startDate = document.getElementById('reportStartDate').value;
                endDate = document.getElementById('reportEndDate').value;
                
                if (!startDate || !endDate) {
                    reportMsg.textContent = 'Please select both start and end dates';
                    reportMsg.className = 'error';
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    reportMsg.textContent = 'Start date must be before end date';
                    reportMsg.className = 'error';
                    return;
                }
                
                dateRangeText = `${startDate} to ${endDate}`;
            }
            
            // Simular generación de reporte
            reportMsg.textContent = 'Generating report...';
            reportMsg.className = 'success';
            
            setTimeout(() => {
                reportMsg.textContent = `Report generated successfully! Type: ${reportType}, Device: ${deviceSelect.options[deviceSelect.selectedIndex].text}, Date Range: ${dateRangeText}`;
                reportMsg.className = 'success';
                
                // Simular descarga
                const link = document.createElement('a');
                link.href = '#';
                link.download = `report_${reportType}_${new Date().getTime()}.pdf`;
                link.click();
                
                // Limpiar mensaje después de 5 segundos
                setTimeout(() => {
                    reportMsg.textContent = '';
                    reportMsg.className = '';
                }, 5000);
            }, 2000);
        }

        // Función para cargar datos de dispositivos desde la API
        async function loadDevicesData() {
            //console.log(
            //console.log(
            // Mostrar indicador de carga
            const tbody = document.querySelector('#devicesTable tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">Cargando dispositivos...</td></tr>';
            }
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                //console.log(
                //console.log(
                //console.log(
                const data = await response.json();
                //console.log(
                //console.log(
                //console.log(
                //console.log(
                if (data.success && data.data) {
                    //console.log(
                    //console.log(
                    updateDevicesTable(data.data);
                    return data.data;
                } else {
                    //console.error(
                    //console.log(
                    return [];
                }
            } catch (error) {
                //console.error(
                //console.error(
                //console.error(
                //console.error(
                return [];
            }
        }
        // Función para actualizar la tabla de dispositivos
        function updateDevicesTable(devicesData) {
            //console.log(
            //console.log(
            const tbody = document.querySelector('#devicesTable tbody');
            //console.log(
            if (!tbody) {
                //console.error(
                return;
            }

            // Mostrar indicador de carga
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">Cargando dispositivos...</td></tr>';
            //console.log(
            // Simular un pequeño delay para mostrar el indicador de carga
            setTimeout(() => {
                //console.log(
                // Limpiar tabla existente
                tbody.innerHTML = '';
                //console.log(
                if (!devicesData || devicesData.length === 0) {
                    //console.log(
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">No hay dispositivos registrados</td></tr>';
                    return;
                }
                
                // Filtrar dispositivos que no sean "Sin ID" o datos vacíos
                const validDevices = devicesData.filter(device => 
                    device.deviceId && 
                    device.deviceId !== "Sin ID" && 
                    String(device.deviceId).trim() !== ""
                );
                
                if (validDevices.length === 0) {
                    //console.log(
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">No hay dispositivos válidos registrados</td></tr>';
                    return;
                }
                
                //console.log(
                // Agregar cada dispositivo válido
                validDevices.forEach((device, index) => {
                    //console.log(
                    const row = document.createElement('tr');
                    row.setAttribute('data-device-id', device.deviceId);
                    row.setAttribute('data-building', device.buildingName);
                    row.setAttribute('data-unit', device.unitElevator);
                    row.setAttribute('data-email', device.clientEmail || '');
                    
                    row.innerHTML = `
                        <td style="padding:5px;"><strong style="font-size:0.85rem;">${device.deviceId}</strong></td>
                        <td style="padding:5px;font-size:0.8rem;">${device.buildingName}</td>
                        <td style="padding:5px;font-size:0.8rem;">${device.unitElevator}</td>
                        <td style="white-space:nowrap;padding:5px;">
                            <button class="edit-email" data-id="${device.deviceId}" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                            <button class="del btn-delete" data-id="${device.deviceId}" onclick="deleteDevice('${device.deviceId}')" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                    //console.log(
                });

                //console.log(
                //console.log(
            }, 500);
        }

        // Función para agregar dispositivo
        async function addDevice() {
            const deviceId = document.getElementById('newId').value.trim();
            const building = document.getElementById('newBld').value.trim();
            const unit = document.getElementById('newUnit').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const deviceMsg = document.getElementById('deviceMsg');
            
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            // Validar campos requeridos
            if (!deviceId || !building || !unit) {
                deviceMsg.textContent = 'Please fill in all required fields';
                deviceMsg.className = 'error';
                return;
            }
            
            // Obtener el formulario de agregar dispositivo
            const addForm = document.getElementById('addDeviceForm');
            const deviceIdInput = document.getElementById('addDeviceId');
            const buildingInput = document.getElementById('addDeviceBuilding');
            const unitInput = document.getElementById('addDeviceUnit');
            const emailInput = document.getElementById('addDeviceEmail');
            
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            // Verificar si los elementos existen
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            // Verificar que los elementos existen antes de establecer valores
            if (!deviceIdInput || !buildingInput || !unitInput || !emailInput) {
                //console.error(
                deviceMsg.textContent = 'Error: Formulario no encontrado';
                deviceMsg.className = 'error';
                return;
            }
            
            // Generar email único para el dispositivo
            const uniqueEmail = await generateUniqueEmail(email);
            
            // Establecer los valores en el formulario
            deviceIdInput.value = deviceId;
            buildingInput.value = building;
            unitInput.value = unit;
            emailInput.value = uniqueEmail;
            
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            // Log de todos los datos que se van a enviar
            const formData = new FormData(addForm);
            //console.log(
            for (let [key, value] of formData.entries()) {
                //console.log(
            }
            
            // Enviar el formulario
            //console.log(
            addForm.submit();
            
            // Limpiar formulario de entrada
            document.getElementById('newId').value = '';
            document.getElementById('newBld').value = '';
            document.getElementById('newUnit').value = '';
            document.getElementById('newEmail').value = '';
            
            // Mostrar mensaje de éxito con email único
            if (uniqueEmail !== email) {
                deviceMsg.textContent = `Device added successfully! (Unique Email: ${uniqueEmail})`;
            } else {
                deviceMsg.textContent = 'Device added successfully!';
            }
            deviceMsg.className = 'success';
            
            // Limpiar mensaje después de 3 segundos
            setTimeout(() => {
                deviceMsg.textContent = '';
                deviceMsg.className = '';
            }, 3000);
            
            // Recargar datos de Units y Dashboard después de agregar dispositivo
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                //console.log(
                loadUnitsData(null, currentUser).catch(error => {
                    //console.error(
                });
                //console.log(
                loadDashboardData(currentUser).catch(error => {
                    //console.error(
                });
            }, 1000);
            
            //console.log(
        }

        // Función para eliminar dispositivo
        function deleteDevice(deviceId) {
            //console.log(
            //console.log(
            // Buscar el email del dispositivo en la tabla
                const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
            if (!row) {
                //console.error(
                alert('Error: No se encontró el dispositivo');
                return;
            }
            
            const deviceEmail = row.getAttribute('data-email');
            //console.log(
            if (!deviceEmail) {
                //console.error(
                alert('Error: No se encontró el email del dispositivo');
                return;
            }
            
            // Almacenar datos del dispositivo a eliminar
            deviceToDelete = {
                id: deviceId,
                email: deviceEmail,
                row: row
            };
            
            // Mostrar modal de confirmación
            const modal = document.getElementById('delete-device-confirm-modal');
            modal.style.display = 'flex';
            //console.log(
        }

        // Función para editar email
        function editEmail(deviceId) {
            const newEmail = prompt(`Enter new email for device ${deviceId}:`);
            if (newEmail !== null) {
                const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
                if (row) {
                    row.setAttribute('data-email', newEmail || '');
                    const emailCell = row.querySelector('td:nth-child(4)');
                    emailCell.innerHTML = `<em style="color:#999;font-size:0.75rem;">${newEmail || 'Not set'}</em>`;
                }
            }
        }

        // Función para cargar datos de usuarios
        function loadUsersData() {
            // Esta función ya no se usa, el contenido se maneja con el formulario
        }

        // Función para manejar cambio de rol
        function handleRoleChange() {
            const roleType = document.getElementById('roleType').value;
            const buildingsGroup = document.getElementById('buildingsGroup');
            const technicianInfo = document.getElementById('technicianInfo');
            
            if (roleType === 'client') {
                buildingsGroup.style.display = 'block';
                technicianInfo.style.display = 'none';
            } else if (roleType === 'technician') {
                buildingsGroup.style.display = 'none';
                technicianInfo.style.display = 'block';
            } else if (roleType === 'admin') {
                buildingsGroup.style.display = 'none';
                technicianInfo.style.display = 'none';
            }
        }

        // Función para enviar datos al Google Apps Script
        function sendUserDataToGoogleScript(userData) {
            return new Promise((resolve, reject) => {
                // Crear formulario dinámico
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://script.google.com/macros/s/AKfycbwKhq2YbQQxyF1YRuLgRL9Ik8UZ3FtfhGXeLuV2Xn9HlzVd0UpirhIh0FgdTyH3OYaMpg/exec';
                form.target = 'hiddenIframe';
                form.style.display = 'none';
                
                // Agregar campos del formulario
                Object.keys(userData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = userData[key];
                    form.appendChild(input);
                });
                
                // Agregar formulario al DOM y enviarlo
                document.body.appendChild(form);
                form.submit();
                
                // Limpiar formulario después del envío
                setTimeout(() => {
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                }, 1000);
                
                // Simular respuesta exitosa basada en el script de Google Apps
                setTimeout(() => {
                    resolve({ 
                        success: true, 
                        message: `�?Guardado correctamente: ${userData.correo}`,
                        data: userData
                    });
                }, 2000);
            });
        }

        // Función para generar identificador único de email
        async function generateUniqueEmail(baseEmail) {
            let uniqueEmail = baseEmail;
            let counter = 1;
            
            //console.log(
            try {
                // Consultar la API real para obtener todos los dispositivos
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Extraer todos los emails de dispositivos de la API
                    const existingEmails = data.data
                        .map(device => device.clientEmail)
                        .filter(email => email && email !== -1 && email !== '-1');
                    
                    //console.log(
                    // Buscar emails que coincidan con el patrón base-XX
                    const baseEmailPattern = new RegExp(`^${baseEmail.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(-\\d+)?$`);
                    const matchingEmails = existingEmails.filter(email => baseEmailPattern.test(email));
                    
                    //console.log(
                    if (matchingEmails.length > 0) {
                        // Buscar el siguiente número disponible
                        while (matchingEmails.includes(`${baseEmail}-${counter}`)) {
                            counter++;
                        }
                        
                        uniqueEmail = `${baseEmail}-${counter}`;
                        //console.log(
                    } else {
                        //console.log(
                    }
                } else {
                    //console.log(
                }
            } catch (error) {
                //console.error(
                //console.log(
            }
            
            return uniqueEmail;
        }
        // Función para agregar/actualizar usuario (NUEVA VERSIÓN)
        async function addUserNew() {
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('rolePass').value.trim();
            const roleType = document.getElementById('roleType').value;
            const userMsg = document.getElementById('userMsg');
            
            // Validar campos requeridos
            if (!email) {
                userMsg.textContent = 'Please enter an email address';
                userMsg.className = 'error';
                return;
            }
            
            if (!password) {
                userMsg.textContent = 'Please enter a password';
                userMsg.className = 'error';
                return;
            }
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                userMsg.textContent = 'Please enter a valid email address';
                userMsg.className = 'error';
                return;
            }
            
            // Todos los usuarios tienen acceso a todos los edificios
            let buildings = 'All Buildings';
            
            // Mostrar mensaje de carga
            userMsg.textContent = 'Sending user data...';
            userMsg.className = 'info';
            
            try {
                // Usar el email original para usuarios (no necesitan ID único)
                const userData = {
                    nombre: password,
                    correo: email,
                    role: roleType.charAt(0).toUpperCase() + roleType.slice(1),
                    buildings: buildings,
                    action: 'add_user',
                    timestamp: new Date().toISOString()
                };
                
                // Enviar datos al Google Apps Script
                await sendUserDataToGoogleScript(userData);
                
                // Agregar nuevo usuario
                const tbody = document.querySelector('#rolesTable tbody');
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-user', password);
                newRow.setAttribute('data-user-email', email);
                newRow.setAttribute('data-buildings', buildings);
                newRow.innerHTML = `
                    <td><code>${password}</code></td>
                    <td>${roleType.charAt(0).toUpperCase() + roleType.slice(1)}</td>
                    <td><button class="delR btn-delete" data-id="${password}">Delete</button></td>
                `;
                tbody.appendChild(newRow);
                
                // Mostrar mensaje de éxito
                userMsg.textContent = '✅Usuario agregado exitosamente!';
                
                userMsg.className = 'success';
                
                // Limpiar formulario
                document.getElementById('userEmail').value = '';
                document.getElementById('rolePass').value = '';
                
                // Limpiar mensaje después de 5 segundos
                setTimeout(() => {
                    userMsg.textContent = '';
                    userMsg.className = '';
                }, 5000);
                
            } catch (error) {
                //console.error(
                userMsg.textContent = '❌Error enviando datos al servidor. Usuario agregado solo localmente.';
                userMsg.className = 'error';
            }
        }

        // Función para eliminar usuario
        function deleteUser(password) {
            if (confirm(`Are you sure you want to delete user ${password}?`)) {
                const row = document.querySelector(`tr[data-user="${password}"]`);
                if (row) {
                    row.remove();
                }
            }
        }

        // Función para abrir modal de lista de usuarios
        function openUsersListModal() {
            document.getElementById('users-list-modal').style.display = 'flex';
        }

        // Función para cerrar modal de lista de usuarios
        function closeUsersListModal() {
            document.getElementById('users-list-modal').style.display = 'none';
        }

        // Función para abrir modal de detalles de usuario
        async function openUserDetailsModal(password, role, buildings, email) {
            const modal = document.getElementById('user-details-modal');
            const content = document.getElementById('userDetailsContent');
            
            // Obtener edificios reales del usuario desde la API
            let actualBuildings = buildings;
            if (role === 'Client') {
                try {
                    const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                    const data = await response.json();
                    if (data.success && data.data) {
                        const userDevices = data.data.filter(device => {
                            const deviceEmail = device.clientEmail ? device.clientEmail.toLowerCase() : '';
                            const userEmail = email.toLowerCase();
                            const deviceEmailBase = deviceEmail.split('-')[0];
                            const userEmailBase = userEmail.split('-')[0];
                            return deviceEmailBase === userEmailBase;
                        });
                        const uniqueBuildings = [...new Set(userDevices.map(device => device.buildingName))];
                        actualBuildings = uniqueBuildings.length > 0 ? uniqueBuildings.join(', ') : 'Sin edificios asignados';
                    }
                } catch (error) {
                    actualBuildings = buildings;
                }
            }
            
            // Crear contenido detallado del usuario
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 22px; font-weight: 700; text-align: center;">User Information</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                        <!-- Email Section -->
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #3498db; color: white; padding: 6px 10px; border-radius: 50%; margin-right: 12px; font-size: 14px;">📧</span>
                                <strong style="color: #0b3d91; font-size: 16px;">Email Address</strong>
                            </div>
                            <div style="color: #2c3e50; font-size: 15px; font-weight: 500;">${email}</div>
                        </div>
                        
                        <!-- Password Section -->
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #e74c3c; color: white; padding: 6px 10px; border-radius: 50%; margin-right: 12px; font-size: 14px;">🔐</span>
                                <strong style="color: #0b3d91; font-size: 16px;">Password</strong>
                            </div>
                            <code style="background: #f8f9fa; color: #e74c3c; padding: 8px 12px; border-radius: 6px; font-size: 15px; font-weight: 600; display: inline-block;">${password}</code>
                        </div>
                        
                        <!-- Role Section -->
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid ${role === 'Admin' ? '#e74c3c' : role === 'Technician' ? '#f39c12' : '#3498db'}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: ${role === 'Admin' ? '#e74c3c' : role === 'Technician' ? '#f39c12' : '#3498db'}; color: white; padding: 6px 10px; border-radius: 50%; margin-right: 12px; font-size: 14px;">${role === 'Admin' ? '👑' : role === 'Technician' ? '🔧' : '👤'}</span>
                                <strong style="color: #0b3d91; font-size: 16px;">User Role</strong>
                            </div>
                            <span style="background: ${role === 'Admin' ? '#e74c3c' : role === 'Technician' ? '#f39c12' : '#3498db'}; color: white; padding: 8px 16px; border-radius: 25px; font-size: 15px; font-weight: 600; display: inline-block;">${role}</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Access Permissions</h4>
                    <div>
                        <strong style="color: #0b3d91;">Buildings Access:</strong><br>
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #3498db;">
                            ${actualBuildings}
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Role Description</h4>
                    <div style="line-height: 1.6;">
                        ${role === 'Admin' ? 
                            '<p><strong>Full Access:</strong> Can view, edit, and manage all aspects of the elevator system including users, devices, reports, and service logs.</p>' :
                            role === 'Technician' ? 
                            '<p><strong>Technical Access:</strong> Can access all buildings and perform maintenance tasks, view service logs, and update device status.</p>' :
                            '<p><strong>Client Access:</strong> View-only access to specific buildings assigned to this user. Can view elevator status and basic information.</p>'
                        }
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Función para cerrar modal de detalles de usuario
        function closeUserDetailsModal() {
            document.getElementById('user-details-modal').style.display = 'none';
        }

        // Función para abrir modal de lista de dispositivos
        function openDevicesListModal() {
            //console.log(
            document.getElementById('devices-list-modal').style.display = 'flex';
            
            // Siempre cargar datos frescos
            //console.log(
            loadDevicesData();
        }

        // Función para cerrar modal de lista de dispositivos
        function closeDevicesListModal() {
            document.getElementById('devices-list-modal').style.display = 'none';
        }

        // Función para abrir modal de detalles de dispositivo
        function openDeviceDetailsModal(deviceId, building, unit, email) {
            const modal = document.getElementById('device-details-modal');
            const content = document.getElementById('deviceDetailsContent');
            
            // Crear contenido detallado del dispositivo
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 20px;">Device Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: #0b3d91;">Device ID:</strong><br>
                            <code style="font-size: 16px; padding: 8px 12px;">${deviceId}</code>
                        </div>
                        <div>
                            <strong style="color: #0b3d91;">Status:</strong><br>
                            <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">Online</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Location Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: #0b3d91;">Building:</strong><br>
                            <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #3498db;">
                                ${building}
                            </div>
                        </div>
                        <div>
                            <strong style="color: #0b3d91;">Unit/Elevator:</strong><br>
                            <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #e74c3c;">
                                ${unit}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Contact Information</h4>
                    <div>
                        <strong style="color: #0b3d91;">Client Email:</strong><br>
                        <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #f39c12;">
                            ${email || '<em style="color: #999;">Not set</em>'}
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Device Capabilities</h4>
                    <div style="line-height: 1.6;">
                        <p><strong>Monitoring:</strong> Real-time elevator status, floor position, door status, and operational state.</p>
                        <p><strong>Alerts:</strong> Automatic notifications for maintenance needs, safety issues, and system errors.</p>
                        <p><strong>Control:</strong> Remote diagnostics, emergency stop, and maintenance mode activation.</p>
                        <p><strong>Data:</strong> Usage statistics, performance metrics, and maintenance history tracking.</p>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Función para cerrar modal de detalles de dispositivo
        function closeDeviceDetailsModal() {
            document.getElementById('device-details-modal').style.display = 'none';
        }

        // Función para manejar filtros
        function handleFilterClick(event) {
            const filterPills = document.querySelectorAll('.filter-pill');
            filterPills.forEach(pill => pill.classList.remove('active'));
            event.target.classList.add('active');
        }
        // Variable para rastrear si se presionó el botón de búsqueda
        let searchButtonPressed = false;
        // Función para agregar event listeners de búsqueda
        function addSearchEventListeners() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            if (searchInput && !searchInput.hasAttribute('data-listener-added')) {
                // Event listener para Enter en el input
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const searchTerm = this.value.trim().toLowerCase();
                        if (searchTerm) {
                            //console.log(
                            applySearchWithFilters(searchTerm, false); // false = no navegar a Units
                            // Limpiar el input después de buscar
                            this.value = '';
                        }
                    }
                });
                
                // Event listener para búsqueda en tiempo real (opcional)
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    // Solo buscar si hay al menos 2 caracteres, pero SIN navegar a Units
                    if (searchTerm.length >= 2) {
                        //console.log(
                        applySearchWithFilters(searchTerm, false); // false = no navegar a Units
                    } else if (searchTerm.length === 0) {
                        // Si se borra todo, volver al dashboard
                        //console.log(
                        showScreen('dashboard-screen');
                        loadDashboardData();
                    }
                });
                
                searchInput.setAttribute('data-listener-added', 'true');
                //console.log(
            }

            if (searchBtn && !searchBtn.hasAttribute('data-listener-added')) {
                searchBtn.addEventListener('click', function() {
                    const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
                    if (searchTerm) {
                        //console.log(
                        applySearchWithFilters(searchTerm, true); // true = navegar a Units
                        // Limpiar el input después de buscar
                        document.getElementById('search-input').value = '';
                    } else {
                        //console.log(
                        // Si no hay término de búsqueda, mostrar todos los dispositivos con el status seleccionado
                        applySearchWithFilters('', true); // true = navegar a Units, '' = sin término
                    }
                });
                searchBtn.setAttribute('data-listener-added', 'true');
                //console.log(
            }
        }
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            
            // Filtros de estado
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.addEventListener('click', handleFilterClick);
            });
            
            // Agregar event listeners de búsqueda inicialmente
            addSearchEventListeners();
            
            // Event listener para cambio de tipo de reporte
            const reportTypeSelect = document.getElementById('reportType');
            if (reportTypeSelect) {
                reportTypeSelect.addEventListener('change', function() {
                    const reportType = this.value;
                    const dateRangeContainer = document.getElementById('dateRangeContainer');
                    const monthSelectorContainer = document.getElementById('monthSelectorContainer');
                    
                    if (reportType === 'summary') {
                        // Mostrar selector de mes y ocultar date range
                        dateRangeContainer.style.display = 'none';
                        monthSelectorContainer.style.display = 'block';
                        //console.log(
                    } else {
                        // Mostrar date range y ocultar selector de mes
                        dateRangeContainer.style.display = 'grid';
                        monthSelectorContainer.style.display = 'none';
                        //console.log(
                    }
                });
                //console.log(
            }
            
            // Botón de filtro - abrir modal (primer botón del header-right)
            document.querySelector('.header-right .icon-btn').addEventListener('click', function() {
                document.getElementById('filter-modal').style.display = 'flex';
                // Cargar edificios del usuario cuando se abre el modal
                loadUserBuildings();
            });
            
            // Cerrar modal
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('filter-modal').style.display = 'none';
            });
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('filter-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });

            // Cerrar modal del elevador
            document.getElementById('close-elevator-modal').addEventListener('click', function() {
                document.getElementById('elevator-modal').style.display = 'none';
            });
            
            // Cerrar modal del elevador al hacer clic fuera
            document.getElementById('elevator-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // Aplicar filtros
            document.getElementById('apply-filters').addEventListener('click', function() {
                const selectedStatus = document.querySelector('input[name="status"]:checked').value;
                const selectedBuilding = document.getElementById('buildingFilter').value;
                
                //console.log(
                // Guardar el filtro activo en la variable global
                currentStatusFilter = selectedStatus;
                
                // Obtener el término de búsqueda actual
                const currentSearchTerm = document.getElementById('search-input').value.toLowerCase();
                
                // Aplicar filtros a la búsqueda actual (sin navegar a Units)
                applySearchWithFilters(currentSearchTerm, false);
                
                // Aplicar filtros también al dashboard de logs
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                loadDashboardData(currentUser, selectedStatus);
                
                document.getElementById('filter-modal').style.display = 'none';
            });
            
            // Limpiar filtros
            document.getElementById('clear-filters').addEventListener('click', function() {
                document.querySelector('input[name="status"][value="all"]').checked = true;
                document.getElementById('buildingFilter').value = 'all';
                
                // Resetear el filtro activo en la variable global
                currentStatusFilter = 'all';
                
                // Mostrar todos los dispositivos y logs sin filtros
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                loadUnitsData(null, currentUser);
                loadDashboardData(currentUser, 'all');
            });

            // Service form functionality
            
            // Add service entry button
            document.getElementById('addServiceBtn').addEventListener('click', addServiceEntry);
            
            // Generate report button (handled by generateReportPDF listener below)
            
            // Add device button
            document.getElementById('addDeviceBtn').addEventListener('click', addDevice);
            
            // Device table event delegation
            document.getElementById('devicesTable').addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-delete')) {
                    const deviceId = e.target.getAttribute('data-id');
                    deleteDevice(deviceId);
                } else if (e.target.classList.contains('edit-email')) {
                    const deviceId = e.target.getAttribute('data-id');
                    editEmail(deviceId);
                } else if (e.target.tagName === 'TD' || e.target.tagName === 'STRONG') {
                    // Click en cualquier celda para ver detalles
                    const row = e.target.closest('tr');
                    if (row) {
                        const deviceId = row.getAttribute('data-device-id');
                        const building = row.getAttribute('data-building');
                        const unit = row.getAttribute('data-unit');
                        const email = row.getAttribute('data-email');
                        openDeviceDetailsModal(deviceId, building, unit, email);
                    }
                }
            });
            
            // View devices button
            document.getElementById('viewDevicesBtn').addEventListener('click', openDevicesListModal);
            

            // Refresh All APIs button
            document.getElementById('refresh-all-btn').addEventListener('click', function() {
                //console.log(
                refreshAllAPIs();
            });
            
            // Refresh Units Only button
            document.getElementById('refresh-units-btn').addEventListener('click', function() {
                //console.log(
                refreshUnitsOnly();
            });
            
            // Close devices list modal
            document.getElementById('close-devices-modal').addEventListener('click', closeDevicesListModal);
            document.getElementById('devices-list-modal').addEventListener('click', function(e) {
                if (e.target === this) closeDevicesListModal();
            });
            
            // Close device details modal
            document.getElementById('close-device-details-modal').addEventListener('click', closeDeviceDetailsModal);
            document.getElementById('device-details-modal').addEventListener('click', function(e) {
                if (e.target === this) closeDeviceDetailsModal();
            });
            
            // User management functionality
            document.getElementById('roleType').addEventListener('change', handleRoleChange);
            document.getElementById('addRoleBtn').addEventListener('click', addUserNew);
            
            // User table event delegation
            document.getElementById('rolesTable').addEventListener('click', function(e) {
                if (e.target.classList.contains('delR')) {
                    const password = e.target.getAttribute('data-id');
                    deleteUser(password);
                } else if (e.target.tagName === 'TD' || e.target.tagName === 'CODE') {
                    // Click en cualquier celda para ver detalles
                    const row = e.target.closest('tr');
                    if (row) {
                        const password = row.getAttribute('data-user') || row.querySelector('code').textContent;
                        const role = row.cells[1].textContent;
                        const buildings = row.getAttribute('data-buildings') || 'All Buildings';
                        const email = row.getAttribute('data-user-email') || 'Not set';
                        openUserDetailsModal(password, role, buildings, email);
                    }
                }
            });
            
            // View users button
            document.getElementById('viewUsersBtn').addEventListener('click', openUsersListModal);
            
            // Close users list modal
            document.getElementById('close-users-modal').addEventListener('click', closeUsersListModal);
            document.getElementById('users-list-modal').addEventListener('click', function(e) {
                if (e.target === this) closeUsersListModal();
            });
            
            // Close user details modal
            document.getElementById('close-user-details-modal').addEventListener('click', closeUserDetailsModal);
            document.getElementById('user-details-modal').addEventListener('click', function(e) {
                if (e.target === this) closeUserDetailsModal();
            });
            
            // View history button
            document.getElementById('viewHistoryBtn').addEventListener('click', openServiceHistoryModal);
            
            // Close history modal
            document.getElementById('close-history-modal').addEventListener('click', closeServiceHistoryModal);
            
            // Close history modal when clicking outside
            document.getElementById('service-history-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeServiceHistoryModal();
                }
            });

            // Event listeners para el modal de confirmación de eliminación de usuario
            document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
            document.getElementById('cancel-delete').addEventListener('click', cancelDelete);
            
            // Event listeners para el modal de confirmación de eliminación de dispositivo
            document.getElementById('confirm-delete-device').addEventListener('click', confirmDeleteDevice);
            document.getElementById('cancel-delete-device').addEventListener('click', cancelDeleteDevice);
            
            // Event listeners para el modal de confirmación de logout
            document.getElementById('confirm-logout').addEventListener('click', confirmLogout);
            document.getElementById('cancel-logout').addEventListener('click', closeLogoutModal);
            
            // Cerrar modal de confirmación de usuario al hacer clic fuera
            document.getElementById('delete-confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelDelete();
                }
            });
            
            // Cerrar modal de confirmación de dispositivo al hacer clic fuera
            document.getElementById('delete-device-confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelDeleteDevice();
                }
            });

        });

        // Cargar datos cuando se cambie de pantalla
        function showScreen(screenId) {
            // Verificar si la pantalla está permitida para el usuario actual
            if (!isScreenAllowed(screenId)) {
                //console.log(
                // Redirigir a la primera pantalla permitida
                const allowedScreen = getFirstAllowedScreen();
                //console.log(
                showScreen(allowedScreen);
                return;
            }
            
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Activar el botón de navegación correspondiente
            const navButtons = document.querySelectorAll(`[onclick="showScreen('${screenId}')"]`);
            navButtons.forEach(button => button.classList.add('active'));
            
            // Cargar datos cuando sea necesario
            switch(screenId) {
                case 'dashboard-screen':
                    //console.log(
                    // Los datos ya están cargados desde el inicio de la página
                    // Agregar event listeners de búsqueda
                    addSearchEventListeners();
                    break;
                case 'units-screen':
                    //console.log(
                    //console.log(
                    // Solo recargar si se presionó el botón de búsqueda antes
                    if (searchButtonPressed) {
                        //console.log(
                        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                        loadUnitsData(null, currentUser);
                        // Resetear la bandera DESPUÉS de recargar
                        searchButtonPressed = false;
                        //console.log(
                    } else {
                        //console.log(
                    }
                    break;
                case 'service-screen':
                    //console.log(
                    //console.log(
                    // Resetear bandera de búsqueda al salir de Units
                    searchButtonPressed = false;
                    // Cargar dispositivos para el select
                    loadServiceDevices();
                    break;
                case 'reports-screen':
                    //console.log(
                    // Resetear bandera de búsqueda al salir de Units
                    searchButtonPressed = false;
                    // Cargar dispositivos para el select de reportes
                    loadReportDevices();
                    const reportsList = document.getElementById('reports-list');
                    if (reportsList && reportsList.children.length === 0) {
                        loadReportsData();
                    }
                    break;
                case 'devices-screen':
                    //console.log(
                    // Resetear bandera de búsqueda al salir de Units
                    searchButtonPressed = false;
                    // No cargar datos automáticamente, solo cuando se abra el modal
                    break;
                case 'users-screen':
                    //console.log(
                    // Resetear bandera de búsqueda al salir de Units
                    searchButtonPressed = false;
                    // Verificar qué elementos existen en la pantalla de usuarios
                    const usersListElement = document.getElementById('users-list');
                    const rolesTableElement = document.getElementById('rolesTable');
                    //console.log(
                    //console.log(
                    if (usersListElement && usersListElement.children.length === 0) {
                        //console.log(
                        loadUsersData();
                    }
                    // Cargar datos reales cuando se abra la pantalla de usuarios
                    //console.log(
                    loadRealUsersData();
                    
                    // Cargar edificios desde la API
                    //console.log(
                    loadBuildingsFromAPI();
                    break;
            }
        }

        // Los datos se cargan a través de checkAuthentication() y loadAppData()

        // Función de prueba para verificar la API
        async function testAPI() {
            //console.log(
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbyvJDE1qb-qULHBpeSnWDs88KH-PZhlmzRxQKV2be2aR2oD-f48-MDLwSz0xil2NIKl/exec');
                //console.log(
                const data = await response.json();
                //console.log(
                return data;
            } catch (error) {
                //console.error(
                return null;
            }
        }

        // Ejecutar prueba de API al cargar la página
        testAPI();

        // Función para cargar datos reales de usuarios desde la API
        async function loadRealUsersData() {
            try {
                //console.log(
                //console.log(
                // Cargar datos del localStorage primero
                const cachedData = localStorage.getItem('usersData');
                const cacheTimestamp = localStorage.getItem('usersDataTimestamp');
                const now = Date.now();
                const cacheAge = cacheTimestamp ? now - parseInt(cacheTimestamp) : Infinity;
                
                //console.log(
                //console.log(
                // Si hay datos en caché y son recientes (menos de 5 minutos), usarlos
                if (cachedData && cacheAge < 300000) {
                    //console.log(
                    const data = JSON.parse(cachedData);
                    updateUsersTable(data);
                    return data;
                }
                
                // Mostrar indicador de carga solo si no hay datos en caché
                const tbody = document.querySelector('#rolesTable tbody');
                if (tbody && !cachedData) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6c757d;">Cargando usuarios...</td></tr>';
                }
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbyvJDE1qb-qULHBpeSnWDs88KH-PZhlmzRxQKV2be2aR2oD-f48-MDLwSz0xil2NIKl/exec');
                //console.log(
                //console.log(
                //console.log(
                const data = await response.json();
                //console.log(
                //console.log(
                //console.log(
                //console.log(
                if (data.success && data.data) {
                    //console.log(
                    //console.log(
                    // Guardar en localStorage
                    localStorage.setItem('usersData', JSON.stringify(data.data));
                    localStorage.setItem('usersDataTimestamp', now.toString());
                    //console.log(
                    updateUsersTable(data.data);
                    return data.data;
                } else {
                    //console.error(
                    //console.log(
                    // Si hay error en la API pero hay datos en caché, usarlos
                    if (cachedData) {
                        //console.log(
                        const fallbackData = JSON.parse(cachedData);
                        updateUsersTable(fallbackData);
                        return fallbackData;
                    }
                    
                    return [];
                }
            } catch (error) {
                //console.error(
                //console.error(
                //console.error(
                //console.error(
                // Si hay error en la API pero hay datos en caché, usarlos
                const cachedData = localStorage.getItem('usersData');
                if (cachedData) {
                    //console.log(
                    const fallbackData = JSON.parse(cachedData);
                    updateUsersTable(fallbackData);
                    return fallbackData;
                }
                
                return [];
            }
        }

        // Función para actualizar la tabla de usuarios con datos reales
        function updateUsersTable(usersData) {
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            const tbody = document.querySelector('#rolesTable tbody');
            //console.log(
            if (!tbody) {
                //console.error(
                return;
            }

            // Mostrar indicador de carga
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6c757d;">Cargando usuarios...</td></tr>';
            //console.log(
            // Simular un pequeño delay para mostrar el indicador de carga
            setTimeout(() => {
                //console.log(
                // Limpiar tabla existente
                tbody.innerHTML = '';
                //console.log(
                if (!usersData || usersData.length === 0) {
                    //console.log(
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6c757d;">No hay usuarios registrados</td></tr>';
                    return;
                }

                //console.log(
                // Agregar cada usuario
                usersData.forEach((user, index) => {
                    //console.log(
                    const row = document.createElement('tr');
                    row.setAttribute('data-user', user.Contraseña);
                    row.setAttribute('data-user-email', user.Email);
                    row.setAttribute('data-buildings', user.builds);
                    
                    // Determinar si es admin (protegido)
                    const isAdmin = user.role === 'Admin';
                    const actionButton = isAdmin 
                        ? '<span style="color:#999;font-size:0.85rem;">Protected</span>'
                        : `<button class="delR btn-delete" data-id="${user.Contraseña}" onclick="deleteUser('${user.Contraseña}')">Delete</button>`;
                    
                    row.innerHTML = `
                        <td><code>${user.Email}</code></td>
                        <td>${user.role}</td>
                        <td style="white-space: nowrap;">
                            ${actionButton}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                    //console.log(
                });

                //console.log(
                //console.log(
            }, 500);
        }
        // Función para mostrar detalles de usuario con datos reales
        function showUserDetails(userId) {
            //console.log(
            //console.log(
            //console.log(
            // Mostrar modal inmediatamente con indicador de carga
            const modal = document.getElementById('user-details-modal');
            const content = document.getElementById('userDetailsContent');
            
            //console.log(
            //console.log(
            if (!modal || !content) {
                //console.error(
                return;
            }

            // Mostrar indicador de carga
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 18px; margin-bottom: 10px;">Cargando detalles del usuario...</div>
                    <div style="font-size: 14px;">Por favor espera</div>
                </div>
            `;
            
            modal.style.display = 'flex';
            //console.log(
            // Buscar el usuario en la tabla
            const userRow = document.querySelector(`tr[data-user="${userId}"]`);
            //console.log(
            if (!userRow) {
                //console.error(
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Usuario no encontrado</div>';
                return;
            }

            const userEmail = userRow.getAttribute('data-user-email');
            const userBuildings = userRow.getAttribute('data-buildings');
            //console.log(
            //console.log(
            // Obtener datos completos del usuario desde la API
            //console.log(
            loadRealUsersData().then(usersData => {
                //console.log(
                //console.log(
                const user = usersData.find(u => u.Contraseña === userId);
                //console.log(
                if (user) {
                    //console.log(
                    displayUserDetails(user);
                } else {
                    //console.error(
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">No se encontraron datos del usuario</div>';
                }
            }).catch(error => {
                //console.error(
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar datos del usuario</div>';
            });
        }
        // Función para mostrar los detalles del usuario en el modal
        function displayUserDetails(user) {
            //console.log(
            //console.log(
            //console.log(
            const modal = document.getElementById('user-details-modal');
            const content = document.getElementById('userDetailsContent');
            
            //console.log(
            //console.log(
            if (!modal || !content) {
                //console.error(
                return;
            }

            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            //console.log(
            // Crear contenido HTML con los datos del usuario
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Información Personal</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Contraseña:</strong><br>
                            <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px;">${user.Contraseña}</code>
                        </div>
                        <div>
                            <strong>Email:</strong><br>
                            <span style="color: #2980b9;">${user.Email}</span>
                        </div>
                        <div>
                            <strong>Rol:</strong><br>
                            <span style="background: ${user.role === 'Admin' ? '#e74c3c' : user.role === 'Client' ? '#27ae60' : '#f39c12'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;">
                                ${user.role}
                            </span>
                        </div>
                        <div>
                            <strong>Proyecto:</strong><br>
                            <span>${user.proyecto || 'Sin proyecto'}</span>
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Edificios Asignados</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                        ${user.builds || 'Sin edificios asignados'}
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Plan de Mantenimiento</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Fecha de Inicio:</strong><br>
                            <span style="color: ${user.fecha_inicio_de_plan ? '#27ae60' : '#e74c3c'};">
                                ${user.fecha_inicio_de_plan || 'Sin fecha'}
                            </span>
                        </div>
                        <div>
                            <strong>Fecha de Fin:</strong><br>
                            <span style="color: ${user.fecha_fin_de_plan ? '#27ae60' : '#e74c3c'};">
                                ${user.fecha_fin_de_plan || 'Sin fecha'}
                            </span>
                        </div>
                    </div>
                </div>
            `;

            // Mostrar el modal
            modal.style.display = 'flex';
            //console.log(
            //console.log(
        }
        // Variable global para almacenar el usuario a eliminar
        let userToDelete = null;
        
        // Variable global para almacenar el dispositivo a eliminar
        let deviceToDelete = null;

        // Función para eliminar usuario
        function deleteUser(userId) {
            //console.log(
            //console.log(
            // Buscar el correo real del usuario en la tabla
            const userRow = document.querySelector(`tr[data-user="${userId}"]`);
            let userEmail = userId; // Por defecto usar el userId
            
            if (userRow) {
                // Buscar si hay un atributo data-user-email
                const emailAttr = userRow.getAttribute('data-user-email');
                if (emailAttr) {
                    userEmail = emailAttr;
                    //console.log(
                } else {
                    // Si no hay data-user-email, buscar en la tabla de usuarios dinámicos
                    const dynamicUserRow = document.querySelector(`tr[data-user-email="${userId}"]`);
                    if (dynamicUserRow) {
                        userEmail = dynamicUserRow.getAttribute('data-user-email');
                        //console.log(
                    } else {
                        //console.log(
                    }
                }
            } else {
                //console.log(
            }
            
            // Almacenar datos del usuario a eliminar
            userToDelete = {
                id: userId,
                email: userEmail
            };
            
            // Mostrar modal de confirmación
            const modal = document.getElementById('delete-confirm-modal');
            modal.style.display = 'flex';
            //console.log(
        }

        // Función para confirmar eliminación
        function confirmDelete() {
            if (!userToDelete) {
                //console.error(
                return;
            }
            
            //console.log(
            //console.log(
            // Obtener el formulario de eliminación
            const deleteForm = document.getElementById('deleteUserForm');
            const emailInput = document.getElementById('deleteUserEmail');
            
            //console.log(
            //console.log(
            //console.log(
            // Establecer el correo del usuario
            emailInput.value = userToDelete.email;
            
            //console.log(
            //console.log(
            // Log de todos los datos que se van a enviar
            const formData = new FormData(deleteForm);
            //console.log(
            for (let [key, value] of formData.entries()) {
                //console.log(
            }
            
            // Enviar el formulario
            //console.log(
            deleteForm.submit();
            
            // Cerrar modal de confirmación
            const modal = document.getElementById('delete-confirm-modal');
            modal.style.display = 'none';
            
            //console.log(
            // Mostrar indicador de actualización
            const tbody = document.querySelector('#rolesTable tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6c757d;">Actualizando lista de usuarios...</td></tr>';
            }
            
            // Esperar un momento para que el servidor procese la eliminación
            setTimeout(() => {
                //console.log(
                // Limpiar caché para forzar recarga desde API
                localStorage.removeItem('usersData');
                localStorage.removeItem('usersDataTimestamp');
                loadRealUsersData().then(usersData => {
                    //console.log(
                    //console.log(
                }).catch(error => {
                    //console.error(
                    // En caso de error, mostrar mensaje
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #e74c3c;">Error al actualizar la lista</td></tr>';
                    }
                });
            }, 2000); // Esperar 2 segundos para que el servidor procese
            
            //console.log(
            // Limpiar variable
            userToDelete = null;
        }

        // Función para cancelar eliminación
        function cancelDelete() {
            //console.log(
            const modal = document.getElementById('delete-confirm-modal');
            modal.style.display = 'none';
            userToDelete = null;
        }

        // Función para confirmar eliminación de dispositivo
        function confirmDeleteDevice() {
            if (!deviceToDelete) {
                //console.error(
                return;
            }
            
            //console.log(
            //console.log(
            // Obtener el formulario de eliminar dispositivo
            const deleteForm = document.getElementById('deleteDeviceForm');
            const emailInput = document.getElementById('deleteDeviceEmail');
            
            //console.log(
            //console.log(
            // Establecer el email del dispositivo
            emailInput.value = deviceToDelete.email;
            
            //console.log(
            //console.log(
            // Log de todos los datos que se van a enviar
            const formData = new FormData(deleteForm);
            //console.log(
            for (let [key, value] of formData.entries()) {
                //console.log(
            }
            
            // Enviar el formulario
            //console.log(
            deleteForm.submit();
            
            // Cerrar modal de confirmación
            const modal = document.getElementById('delete-device-confirm-modal');
            modal.style.display = 'none';
            
            // Cerrar modal de All Devices
            const devicesModal = document.getElementById('devices-list-modal');
            devicesModal.style.display = 'none';
            
            // Mostrar indicador de eliminación en la tabla
            if (deviceToDelete.row) {
                deviceToDelete.row.innerHTML = '<td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">Eliminando dispositivo...</td>';
                //console.log(
            }
            
            // Recargar lista de dispositivos después de eliminar
            setTimeout(() => {
                //console.log(
                loadDevicesData();
            }, 2000);
            
            // Recargar datos de Units y Dashboard después de eliminar dispositivo
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                //console.log(
                loadUnitsData(null, currentUser).catch(error => {
                    //console.error(
                });
                //console.log(
                loadDashboardData(currentUser).catch(error => {
                    //console.error(
                });
            }, 1000);
            
            //console.log(
            // Limpiar variable
            deviceToDelete = null;
        }

        // Función para cancelar eliminación de dispositivo
        function cancelDeleteDevice() {
            //console.log(
            const modal = document.getElementById('delete-device-confirm-modal');
            modal.style.display = 'none';
            deviceToDelete = null;
        }


        // Function to get data from reports API
        async function fetchReportsData() {
            const API_URL = 'https://script.google.com/macros/s/AKfycbwmymPhQ89H9I0Mc25PYBYcgLSFANar8FyWbFTF0wCzk8OCbm6IXproy9YFhgKvpOJD_w/exec';
            
            try {
                //console.log(
                //console.log(
                //console.log(
                const response = await fetch(API_URL);
                //console.log(
                //console.log(
                //console.log(
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                //console.log(
                let data;
                try {
                    data = JSON.parse(responseText);
                    //console.log(
                } catch (parseError) {
                    //console.error(
                    //console.log(
                    throw new Error('API returned invalid JSON response');
                }
                
                if (data.success && data.data) {
                    //console.log(
                    return data.data;
                } else {
                    //console.error(
                    throw new Error(`API returned unsuccessful response: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                //console.error(
                throw error;
            }
        }
        // Function to filter data by device and date range
        function filterReportsData(data, deviceId, startDate, endDate, reportType = 'all') {
            let filteredData = data;
            
            // Filter by device if not "all"
            if (deviceId !== 'all') {
                filteredData = filteredData.filter(item => item.device_id === deviceId);
            }
            
            // Filter out AT_FLOOR and MOVING events (these should not appear in reports)
            const excludedEvents = ['AT_FLOOR', 'MOVING'];
            filteredData = filteredData.filter(item => {
                const inputChanged = item.input_changed || '';
                const shouldExclude = excludedEvents.includes(inputChanged);
                if (shouldExclude) {
                    //console.log(
                }
                return !shouldExclude;
            });
            
            // Filter by report type and state changes
            if (reportType === 'service') {
                // Service Log: Show when events go from true to false (problem resolved)
                filteredData = filteredData.filter(item => {
                    const oldValue = item.old_value;
                    const newValue = item.new_value;
                    
                    // Show when going from true to false (problem resolved)
                    const isServiceResolution = oldValue === true && newValue === false;
                    
                    if (isServiceResolution) {
                        //console.log(
                    }
                    
                    return isServiceResolution;
                });
            } else if (reportType === 'alarms') {
                // Alarm: Show when events go from false to true (alarm activated)
                filteredData = filteredData.filter(item => {
                    const oldValue = item.old_value;
                    const newValue = item.new_value;
                    
                    // Show when going from false to true (alarm activated)
                    const isAlarmActivation = oldValue === false && newValue === true;
                    
                    if (isAlarmActivation) {
                        //console.log(
                    }
                    
                    return isAlarmActivation;
                });
            }
            // For 'summary' and other types, show all events (no additional filtering)
            
            // Filter by date range
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                filteredData = filteredData.filter(item => {
                    // Parse the timestamp correctly - format: "DD/MM/YYYY HH:MM:SS"
                    const timestamp = item.timestamp || '';
                    let itemDate = null;
                    
                    try {
                        if (timestamp.includes(',')) {
                            // Format: "DD/MM/YYYY, HH:MM:SS (Bermuda Time)" or "DD/MM/YYYY, HH:MM:SS"
                            const dateTimePart = timestamp.split(',')[0].trim();
                            let timePart = timestamp.split(',')[1].trim();
                            
                            // Remove "(Bermuda Time)" if present
                            if (timePart.includes('(Bermuda Time)')) {
                                timePart = timePart.replace('(Bermuda Time)', '').trim();
                            }
                            
                            const [day, month, year] = dateTimePart.split('/');
                            const [hour, minute, second] = timePart.split(':');
                            itemDate = new Date(year, month - 1, day, hour, minute, second);
                        } else if (timestamp.includes(' ')) {
                            // Format: "DD/MM/YYYY HH:MM:SS" or "DD/MM/YYYY HH:MM:SS (Bermuda Time)"
                            let cleanTimestamp = timestamp;
                            if (cleanTimestamp.includes('(Bermuda Time)')) {
                                cleanTimestamp = cleanTimestamp.replace('(Bermuda Time)', '').trim();
                            }
                            
                            const [datePart, timePart] = cleanTimestamp.split(' ');
                            const [day, month, year] = datePart.split('/');
                            const [hour, minute, second] = timePart.split(':');
                            itemDate = new Date(year, month - 1, day, hour, minute, second);
                        } else {
                            // Try direct parsing as fallback
                            itemDate = new Date(timestamp);
                        }
                        
                        // Check if date is valid
                        if (isNaN(itemDate.getTime())) {
                            console.warn('Invalid timestamp format:', timestamp);
                            return false;
                        }
                        
                        // Add one day to end date to include the entire day
                        const endDateInclusive = new Date(end);
                        endDateInclusive.setDate(endDateInclusive.getDate() + 1);
                        
                        return itemDate >= start && itemDate < endDateInclusive;
                    } catch (error) {
                        console.warn('Error parsing timestamp:', timestamp, error);
                        return false;
                    }
                });
            }
            
            return filteredData;
        }
        // Function to generate and download PDF reports
        async function generateReportPDF() {
            //console.log(
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    //console.error(
                    alert('Error: jsPDF library not loaded. Please refresh the page.');
                    return;
                }
                
                // Show loading message
                const reportMsg = document.getElementById('reportMsg');
                reportMsg.textContent = 'Fetching data from API...';
                reportMsg.className = 'success-msg';
                
                // Get form data
                const reportType = document.getElementById('reportType').value;
                const deviceSelect = document.getElementById('reportDeviceSelect');
                const selectedDevice = deviceSelect.value;
                const comments = document.getElementById('reportComments').value;
                
                let startDate, endDate, dateRangeText;
                
                if (reportType === 'summary') {
                    // For Monthly Summary, use month selector
                    const monthValue = document.getElementById('reportMonth').value;
                    if (!monthValue) {
                        reportMsg.textContent = 'Please select a month for Monthly Summary';
                        reportMsg.className = 'success-msg error';
                        return;
                    }
                    
                    // Convert selected month to date range
                    const [year, month] = monthValue.split('-');
                    startDate = `${year}-${month}-01`;
                    endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;
                    dateRangeText = `${monthValue} (${startDate} to ${endDate})`;
                } else {
                    // For other report types, use date range
                    startDate = document.getElementById('reportStartDate').value;
                    endDate = document.getElementById('reportEndDate').value;
                    
                    if (!startDate || !endDate) {
                        reportMsg.textContent = 'Please select both start and end dates';
                        reportMsg.className = 'success-msg error';
                        return;
                    }
                    
                    // Validate date format and range
                    const startDateObj = new Date(startDate);
                    const endDateObj = new Date(endDate);
                    
                    if (isNaN(startDateObj.getTime()) || isNaN(endDateObj.getTime())) {
                        reportMsg.textContent = 'Invalid date format. Please select valid dates.';
                        reportMsg.className = 'success-msg error';
                        return;
                    }
                    
                    if (startDateObj > endDateObj) {
                        reportMsg.textContent = 'Start date must be before end date';
                        reportMsg.className = 'success-msg error';
                        return;
                    }
                    
                    // Check if date range is not too far in the future
                    const today = new Date();
                    today.setHours(23, 59, 59, 999); // End of today
                    if (startDateObj > today) {
                        reportMsg.textContent = 'Start date cannot be in the future';
                        reportMsg.className = 'success-msg error';
                        return;
                    }
                    
                    dateRangeText = `${startDate} to ${endDate}`;
                }
                
                // Get data from API
                reportMsg.textContent = 'Processing data...';
                let apiData;
                try {
                    apiData = await fetchReportsData();
                    //console.log(
                } catch (error) {
                    //console.error(
                    reportMsg.textContent = 'Error: Could not fetch data from API. Please try again.';
                    reportMsg.className = 'success-msg error';
                    return;
                }
                
                // Check if API returned valid data
                if (!apiData || !Array.isArray(apiData)) {
                    reportMsg.textContent = 'Error: Invalid data received from API';
                    reportMsg.className = 'success-msg error';
                    return;
                }
                
                // Filter data according to selected criteria
                const filteredData = filterReportsData(apiData, selectedDevice, startDate, endDate, reportType);
                
                //console.log(
                //console.log(
                if (filteredData.length === 0) {
                    reportMsg.textContent = `No data found for the selected criteria. Total records in API: ${apiData.length}`;
                    reportMsg.className = 'success-msg error';
                    return;
                }
                
                reportMsg.textContent = 'Generating PDF...';
                
                //console.log(
                // Create new PDF document
                let doc;
                try {
                    const { jsPDF } = window.jspdf;
                    doc = new jsPDF();
                } catch (error) {
                    //console.error(
                    reportMsg.textContent = 'Error: Could not create PDF document. Please refresh the page.';
                    reportMsg.className = 'success-msg error';
                    return;
                }
                
                // Configure font and sizes
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPosition = margin;
                
                // Function to add text with wrap
                function addText(text, x, y, maxWidth, fontSize = 10) {
                    doc.setFontSize(fontSize);
                    const lines = doc.splitTextToSize(text, maxWidth);
                    doc.text(lines, x, y);
                    return y + (lines.length * fontSize * 0.4);
                }
                
                // Function to add new page if needed
                function checkNewPage(requiredSpace) {
                    if (yPosition + requiredSpace > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                }
                
                // Report header
                doc.setFillColor(11, 61, 145);
                doc.rect(0, 0, pageWidth, 30, 'F');
                
                doc.setTextColor(255, 255, 255);
                yPosition = addText('BERMUDA ELEVATOR - SYSTEM REPORT', margin, 20, pageWidth - 2 * margin, 16);
                
                doc.setTextColor(0, 0, 0);
                yPosition += 10;
                
                // Report information
                const reportTypeText = {
                    'alarms': 'Alarm History Report',
                    'service': 'Service Log Report',
                    'summary': 'Monthly Summary Report'
                };
                
                yPosition = addText(`Report Type: ${reportTypeText[reportType]}`, margin, yPosition, pageWidth - 2 * margin, 12);
                yPosition = addText(`Device: ${selectedDevice === 'all' ? 'All Devices' : selectedDevice}`, margin, yPosition, pageWidth - 2 * margin, 12);
                yPosition = addText(`Date Range: ${dateRangeText}`, margin, yPosition, pageWidth - 2 * margin, 12);
                yPosition = addText(`Total Records: ${filteredData.length}`, margin, yPosition, pageWidth - 2 * margin, 12);
                const bermudaNow = new Date().toLocaleString('en-US', { timeZone: 'Atlantic/Bermuda' });
                yPosition = addText(`Generated: ${bermudaNow} (Bermuda Time)`, margin, yPosition, pageWidth - 2 * margin, 12);
                
                yPosition += 15;
                
                // Technician comments if provided
                if (comments && comments.trim()) {
                    checkNewPage(30);
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin, yPosition - 5, pageWidth - 2 * margin, 25, 'F');
                    yPosition = addText('Technician Comments:', margin, yPosition, pageWidth - 2 * margin, 10);
                    yPosition = addText(comments, margin, yPosition, pageWidth - 2 * margin, 9);
                    yPosition += 10;
                }
                
                // Data table
                checkNewPage(50);
                
                // Table headers
                const tableHeaders = ['Timestamp', 'Device', 'Event', 'Previous Value', 'New Value'];
                const colWidths = [45, 30, 40, 30, 30];
                const colPositions = [margin];
                
                for (let i = 1; i < colWidths.length; i++) {
                    colPositions.push(colPositions[i-1] + colWidths[i-1]);
                }
                
                // Draw headers
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, pageWidth - 2 * margin, 15, 'F');
                
                tableHeaders.forEach((header, index) => {
                    doc.setFontSize(8);
                    doc.text(header, colPositions[index], yPosition + 10);
                });
                
                yPosition += 20;
                
                // Add table data
                filteredData.forEach((item, index) => {
                    checkNewPage(15);
                    
                    // Alternate row color
                    if (index % 2 === 0) {
                        doc.setFillColor(255, 255, 255);
                    } else {
                        doc.setFillColor(248, 249, 250);
                    }
                    doc.rect(margin, yPosition - 5, pageWidth - 2 * margin, 15, 'F');
                    
                    // Row data
                    const normalizeBoolean = (value) => {
                        const s = String(value).trim().toLowerCase();
                        return s === 'true' || value === true;
                    };
                    const rowData = [
                        item.timestamp,
                        item.device_id,
                        item.input_changed,
                        normalizeBoolean(item.old_value) ? 'TRUE' : 'FALSE',
                        normalizeBoolean(item.new_value) ? 'TRUE' : 'FALSE'
                    ];
                    
                    rowData.forEach((data, colIndex) => {
                        doc.setFontSize(7);
                        const text = String(data).substring(0, 15); // Truncate long text
                        doc.text(text, colPositions[colIndex], yPosition + 5);
                    });
                    
                    yPosition += 15;
                });
                
                // Statistical summary
                yPosition += 20;
                checkNewPage(60);
                
                doc.setFontSize(12);
                doc.text('STATISTICAL SUMMARY', margin, yPosition);
                yPosition += 15;
                
                // Count events by type
                const eventCounts = {};
                const deviceCounts = {};
                
                filteredData.forEach(item => {
                    eventCounts[item.input_changed] = (eventCounts[item.input_changed] || 0) + 1;
                    deviceCounts[item.device_id] = (deviceCounts[item.device_id] || 0) + 1;
                });
                
                doc.setFontSize(10);
                yPosition = addText('Events by Type:', margin, yPosition, pageWidth - 2 * margin, 10);
                
                Object.entries(eventCounts).forEach(([event, count]) => {
                    yPosition = addText(`  • ${event}: ${count} occurrences`, margin + 10, yPosition, pageWidth - 2 * margin, 9);
                });
                
                yPosition += 5;
                yPosition = addText('Events by Device:', margin, yPosition, pageWidth - 2 * margin, 10);
                
                Object.entries(deviceCounts).forEach(([device, count]) => {
                    yPosition = addText(`  • ${device}: ${count} events`, margin + 10, yPosition, pageWidth - 2 * margin, 9);
                });
                
                // Footer
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
                    doc.text('Generated by Bermuda Elevator System', margin, pageHeight - 10);
                }
                
                // Generate filename
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const deviceSuffix = selectedDevice === 'all' ? 'all' : selectedDevice;
                const filename = `bermuda_report_${reportType}_${deviceSuffix}_${timestamp}.pdf`;
                
                // Download PDF
                doc.save(filename);
                
                reportMsg.textContent = `Report generated successfully: ${filename}`;
                reportMsg.className = 'success-msg success';
                
                //console.log(
            } catch (error) {
                //console.error(
                const reportMsg = document.getElementById('reportMsg');
                reportMsg.textContent = `Error generating report: ${error.message}`;
                reportMsg.className = 'success-msg error';
            }
        }

        // Función de prueba para verificar la API de reportes
        window.testReportsAPI = async function() {
            //console.log(
            try {
                const data = await fetchReportsData();
                //console.log(
                //console.log(
                //console.log(
                if (data.length > 0) {
                    //console.log(
                    //console.log(
                }
                
                return data;
            } catch (error) {
                //console.error(
                return null;
            }
        };
        // Función de prueba para verificar el filtrado de fechas
        window.testDateFiltering = async function() {
            //console.log(
            try {
                const data = await fetchReportsData();
                //console.log(
                // Contar eventos por tipo antes del filtrado
                const eventCounts = {};
                data.forEach(item => {
                    const event = item.input_changed || 'UNKNOWN';
                    eventCounts[event] = (eventCounts[event] || 0) + 1;
                });
                //console.log(
                // Probar filtrado para hoy (29/10/2025)
                const today = '2025-10-29';
                
                //console.log(
                const filteredToday = filterReportsData(data, 'all', today, today);
                //console.log(
                // Contar eventos por tipo después del filtrado
                const filteredEventCounts = {};
                filteredToday.forEach(item => {
                    const event = item.input_changed || 'UNKNOWN';
                    filteredEventCounts[event] = (filteredEventCounts[event] || 0) + 1;
                });
                //console.log(
                // Verificar que AT_FLOOR y MOVING no están presentes
                const hasAT_FLOOR = filteredToday.some(item => item.input_changed === 'AT_FLOOR');
                const hasMOVING = filteredToday.some(item => item.input_changed === 'MOVING');
                
                //console.log(
                //console.log(
                if (filteredToday.length > 0) {
                    //console.log(
                }
                
                return {
                    totalRecords: data.length,
                    filteredRecords: filteredToday.length,
                    hasAT_FLOOR: hasAT_FLOOR,
                    hasMOVING: hasMOVING,
                    eventCounts: eventCounts,
                    filteredEventCounts: filteredEventCounts
                };
            } catch (error) {
                //console.error(
                return null;
            }
        };

        // Función de prueba para verificar los diferentes tipos de reportes
        window.testReportTypes = async function() {
            //console.log(
            try {
                const data = await fetchReportsData();
                //console.log(
                const today = '2025-10-29';
                
                // Probar Service Log (true -> false)
                //console.log(
                const serviceData = filterReportsData(data, 'all', today, today, 'service');
                //console.log(
                serviceData.forEach(item => {
                    //console.log(
                });
                
                // Probar Alarm Report (false -> true)
                //console.log(
                const alarmData = filterReportsData(data, 'all', today, today, 'alarms');
                //console.log(
                alarmData.forEach(item => {
                    //console.log(
                });
                
                // Probar Summary Report (todos los eventos)
                //console.log(
                const summaryData = filterReportsData(data, 'all', today, today, 'summary');
                //console.log(
                return {
                    totalRecords: data.length,
                    serviceRecords: serviceData.length,
                    alarmRecords: alarmData.length,
                    summaryRecords: summaryData.length,
                    serviceData: serviceData,
                    alarmData: alarmData
                };
            } catch (error) {
                //console.error(
                return null;
            }
        };

        // Event listener para el botón de generar PDF
        document.addEventListener('DOMContentLoaded', function() {
            const generateReportBtn = document.getElementById('generateReportBtn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    //console.log(
                    // Usar la función completa de reporte
                    generateReportPDF();
                });
                //console.log(
            } else {
                //console.error(
            }
            
            // Event listener para el select de edificios
            const allowedBuildingsSelect = document.getElementById('allowedBuildings');
            if (allowedBuildingsSelect) {
                allowedBuildingsSelect.addEventListener('change', function() {
                    const selectedBuilding = this.value;
                    //console.log(
                });
            }
        });

        // Login functionality
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // Validación básica
            if (!email || !password) {
                showLoginError('Please complete all fields');
                return;
            }
            
            // Validación de formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showLoginError('Please enter a valid email');
                return;
            }
            
            try {
                // Mostrar indicador de carga
                showLoginLoading(true);
                
                // Obtener Device ID
                const deviceId = getDeviceId();
                
                // PASO 1: Obtener token de un solo uso
                const tokenUrl = SECURE_API_URL + '?action=getToken&deviceId=' + deviceId;
                const tokenResponse = await fetch(tokenUrl);
                const tokenData = await tokenResponse.json();
                
                if (!tokenData.success) {
                    showLoginError(tokenData.message || 'Error obteniendo token de seguridad');
                    return;
                }
                
                const otp = tokenData.token;
                
                // PASO 2: Usar el token para autenticar
                const loginUrl = SECURE_API_URL + '?action=login&deviceId=' + deviceId + '&otp=' + otp + '&email=' + encodeURIComponent(email) + '&password=' + encodeURIComponent(password);
                
                const loginResponse = await fetch(loginUrl);
                const loginData = await loginResponse.json();
                
                if (!loginData.success) {
                    showLoginError(loginData.message || 'Email or password incorrect');
                    return;
                }
                
                // LOGIN EXITOSO
                const user = loginData.user;
                
                // Guardar información del usuario en localStorage para persistencia
                localStorage.setItem('currentUser', JSON.stringify({
                    email: user.Email,
                    password: user.Contraseña,
                    role: user.Rol,
                    buildings: user.Edificios
                }));
                
                // Guardar timestamp de la sesión para control de expiración
                localStorage.setItem('sessionTimestamp', Date.now().toString());
                
                // Ocultar login y mostrar pantalla de carga
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('loading-screen').style.display = 'flex';
                
                // Configurar permisos de navegación
                setupNavigationPermissions();
                
                // Cargar datos de la aplicación con pantalla de carga
                await loadAppData();
                
                // Verificar rol de admin después del login con un pequeño delay
                setTimeout(() => {
                    checkAdminRole();
                }, 1000);
                
            } catch (error) {
                showLoginError('Connection error. Please try again.');
            } finally {
                showLoginLoading(false);
            }
        }

        // Función para mostrar errores de login
        function showLoginError(message) {
            // Crear o actualizar elemento de error
            let errorElement = document.getElementById('login-error');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = 'login-error';
                errorElement.style.cssText = `
                    color: #e74c3c;
                    background: #fdf2f2;
                    border: 1px solid #fecaca;
                    border-radius: 8px;
                    padding: 12px;
                    margin-top: 15px;
                    font-size: 14px;
                    text-align: center;
                `;
                
                const loginForm = document.getElementById('loginForm');
                loginForm.appendChild(errorElement);
            }
            
            errorElement.textContent = message;
            
            // Ocultar error después de 5 segundos
            setTimeout(() => {
                if (errorElement) {
                    errorElement.remove();
                }
            }, 5000);
        }

        // Función para mostrar/ocultar indicador de carga
        function showLoginLoading(show) {
            const loginBtn = document.querySelector('.login-btn');
            if (show) {
                loginBtn.textContent = 'Verifying...';
                loginBtn.disabled = true;
                loginBtn.style.opacity = '0.7';
            } else {
                loginBtn.textContent = 'Sign in';
                loginBtn.disabled = false;
                loginBtn.style.opacity = '1';
            }
        }
        // Función para cargar datos de la aplicación con pantalla de carga
        // Función para configurar opciones de servicio según el rol del usuario
        function configureServiceOptions(currentUser) {
            const serviceTypeSelect = document.getElementById('serviceType');
            if (!serviceTypeSelect) return;
            
            // Limpiar opciones existentes
            serviceTypeSelect.innerHTML = '';
            
            // Opciones básicas para todos los usuarios
            const basicOptions = [
                { value: 'emergency', text: 'Emergency Call' },
                { value: 'inspection', text: 'Inspection' }
            ];
            
            // Opciones adicionales para Admin y Technician
            const advancedOptions = [
                { value: 'maintenance', text: 'Routine Maintenance' },
                { value: 'repair', text: 'Repair Service' },
                { value: 'cleaning', text: 'Cleaning Service' },
                { value: 'testing', text: 'System Testing' },
                { value: 'software', text: 'Software Update' },
                { value: 'upgrade', text: 'System Upgrade' },
                { value: 'preventive', text: 'Pre-inspection' },
                { value: 'diagnostic', text: 'Diagnostic Check' }
            ];
            
            // Agregar opciones según el rol
            let optionsToShow = basicOptions;
            if (currentUser.role === 'Admin' || currentUser.role === 'Technician') {
                optionsToShow = [...basicOptions, ...advancedOptions];
            }
            
            // Crear opciones en el select
            optionsToShow.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                serviceTypeSelect.appendChild(optionElement);
            });
            
            //console.log(
        }

        async function loadAppData() {
            //console.log(
            const loadingText = document.querySelector('.loading-text');
            
            try {
                // Limpiar cache antes de cargar datos para evitar problemas con usuarios anteriores
                clearApiCache();
                //console.log(
                // Obtener información del usuario actual
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                //console.log(
                // Actualizar texto de carga
                if (loadingText) {
                    loadingText.textContent = 'Connecting to server...';
                }
                
                // Cargar datos de Dashboard PRIMERO (filtrados por usuario)
                //console.log(
                if (loadingText) {
                    loadingText.textContent = 'Loading personalized dashboard...';
                }
                await loadDashboardData(currentUser);
                
                // Esperar a que la tarjeta del dashboard se renderice completamente
                //console.log(
                if (loadingText) {
                    loadingText.textContent = 'Finalizing dashboard...';
                }
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // QUITAR PANTALLA DE CARGA INMEDIATAMENTE DESPUÉS DEL DASHBOARD
                //console.log(
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                
                // Cargar datos de Units EN SEGUNDO PLANO (sin bloquear la UI)
                //console.log(
                loadUnitsData(null, currentUser).then(() => {
                    //console.log(
                    // Iniciar actualización automática después de que Units esté cargado
                    startAutoUpdate();
                }).catch(error => {
                    //console.error(
                    // Iniciar actualización automática incluso si hay error
                    startAutoUpdate();
                });
                
                // Configurar opciones de servicio según el rol del usuario
                configureServiceOptions(currentUser);
                
                //console.log(
            } catch (error) {
                //console.error(
                if (loadingText) {
                    loadingText.textContent = 'Error loading, continuing...';
                }
                
                // Esperar un poco antes de mostrar la app
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // En caso de error, mostrar app de todas formas
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
            }
        }

        // Función para verificar si el usuario es admin y mostrar/ocultar botón View History
        function checkAdminRole() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const viewHistoryContainer = document.getElementById('viewHistoryContainer');
                
                //console.log(
                if (viewHistoryContainer) {
                    if (currentUser.role === 'Admin' || currentUser.role === 'admin') {
                        viewHistoryContainer.style.display = 'block';
                        //console.log(
                    } else {
                        viewHistoryContainer.style.display = 'none';
                        //console.log(
                    }
                } else {
                    //console.log(
                }
            } catch (error) {
                //console.error(
                // En caso de error, ocultar el botón por seguridad
                const viewHistoryContainer = document.getElementById('viewHistoryContainer');
                if (viewHistoryContainer) {
                    viewHistoryContainer.style.display = 'none';
                }
            }
        }

        // Event listeners para login
        document.addEventListener('DOMContentLoaded', function() {
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
            }
            
            // Social login buttons
            const socialBtns = document.querySelectorAll('.social-btn');
            socialBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const provider = this.classList.contains('google-btn') ? 'Google' : 
                                   this.classList.contains('facebook-btn') ? 'Facebook' : 'Twitter';
                    //console.log(
                    // Simular login social
                    handleLogin();
                });
            });
            
            // Sign up link
            const signupLink = document.getElementById('signupLink');
            if (signupLink) {
                signupLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('Registration functionality coming soon');
                });
            }
            
            // Verificar rol de admin para mostrar/ocultar botón View History
            checkAdminRole();
            
            // Profile buttons
            const profileBtns = document.querySelectorAll('.profile-btn');
            profileBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    openProfileModal();
                });
            });
        });

        // Profile Modal Functions
        function openProfileModal() {
            const modal = document.getElementById('profile-modal');
            
            // Obtener información del usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Actualizar información del usuario en el modal
            const userName = document.getElementById('profile-user-name');
            const userEmail = document.getElementById('profile-user-email');
            
            if (userName && userEmail) {
                // Mostrar el rol del usuario
                const roleText = getRoleDisplayText(currentUser.role);
                userName.textContent = roleText;
                
                // Mostrar el email del usuario actual
                userEmail.textContent = currentUser.email || 'No email available';
            }
            
            modal.style.display = 'flex';
        }
        // Función para obtener el texto de visualización del rol
        function getRoleDisplayText(role) {
            switch (role) {
                case 'Admin':
                    return 'Administrator';
                case 'Technician':
                    return 'Technician';
                case 'Client':
                    return 'Client';
                default:
                    return 'User';
            }
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'none';
        }

        function showProfileSettings() {
            closeProfileModal();
            // Profile functionality not implemented yet
        }

        function showAccountSettings() {
            closeProfileModal();
            // Settings functionality not implemented yet
        }

        function showNotifications() {
            closeProfileModal();
            // Notifications functionality not implemented yet
        }

        // Mostrar modal de confirmación de logout
        function showLogoutModal() {
            closeProfileModal();
            document.getElementById('logout-confirm-modal').style.display = 'flex';
        }

        // Cerrar modal de confirmación de logout
        function closeLogoutModal() {
            document.getElementById('logout-confirm-modal').style.display = 'none';
        }

        // Confirmar logout
        function confirmLogout() {
            // Limpiar información del usuario
            localStorage.removeItem('currentUser');
            localStorage.removeItem('sessionTimestamp');
            
            // Limpiar caché de datos de usuarios para forzar recarga en próximo login
            localStorage.removeItem('usersData');
            localStorage.removeItem('usersDataTimestamp');
            
            // Limpiar cache de la API para evitar problemas al cambiar de usuario
            clearApiCache();
            
            // Limpiar historial de servicios (opcional - comentado para mantener historial)
            // localStorage.removeItem('serviceHistory');
            
            // Ocultar app y mostrar login
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            
            // Limpiar formulario de login
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            // Limpiar cualquier mensaje de error
            const errorElement = document.getElementById('login-error');
            if (errorElement) {
                errorElement.remove();
            }
            
            // Cerrar modal de logout
            closeLogoutModal();
            
            //console.log(
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(event) {
            const profileModal = document.getElementById('profile-modal');
            const logoutModal = document.getElementById('logout-confirm-modal');
            
            if (event.target === profileModal) {
                closeProfileModal();
            }
            
            if (event.target === logoutModal) {
                closeLogoutModal();
            }
        });

        // Función para controlar la visibilidad de elementos de navegación basada en el rol
        function setupNavigationPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            //console.log(
            // Obtener todos los elementos de navegación
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(navItem => {
                const onclick = navItem.getAttribute('onclick');
                if (!onclick) return;
                
                // Extraer el nombre de la pantalla del onclick
                const screenName = onclick.match(/showScreen\('([^']+)'\)/);
                if (!screenName) return;
                
                const screen = screenName[1];
                let shouldShow = false;
                
                // Definir permisos por rol
                switch (currentUser.role) {
                    case 'Admin':
                        // Admin ve todo
                        shouldShow = true;
                        break;
                    case 'Technician':
                        // Técnico ve: Dashboard, Units, Service, Reports (sin Devices y Users)
                        shouldShow = ['dashboard-screen', 'units-screen', 'service-screen', 'reports-screen'].includes(screen);
                        break;
                    case 'Client':
                        // Cliente ve: Dashboard, Units, Service
                        shouldShow = ['dashboard-screen', 'units-screen', 'service-screen'].includes(screen);
                        break;
                    default:
                        shouldShow = false;
                }
                
                // Mostrar u ocultar elemento
                if (shouldShow) {
                    navItem.style.display = 'flex';
                    //console.log(
                } else {
                    navItem.style.display = 'none';
                    //console.log(
                }
            });
        }

        // Función para verificar si una pantalla está permitida para el usuario actual
        function isScreenAllowed(screenName) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            switch (currentUser.role) {
                case 'Admin':
                    return true; // Admin ve todo
                case 'Technician':
                    return ['dashboard-screen', 'units-screen', 'service-screen', 'reports-screen'].includes(screenName);
                case 'Client':
                    return ['dashboard-screen', 'units-screen', 'service-screen'].includes(screenName);
                default:
                    return false;
            }
        }

        // Función para obtener la primera pantalla permitida para el usuario
        function getFirstAllowedScreen() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            switch (currentUser.role) {
                case 'Admin':
                    return 'dashboard-screen';
                case 'Technician':
                    return 'dashboard-screen';
                case 'Client':
                    return 'dashboard-screen';
                default:
                    return 'dashboard-screen';
            }
        }

        // Verificar si la sesión ha expirado (DESHABILITADO - sesión permanente)
        function isSessionExpired() {
            // La sesión nunca expira - siempre retorna false
            return false;
        }

        // Verificar autenticación al cargar la página
        function checkAuthentication() {
            //console.log(
            const currentUser = localStorage.getItem('currentUser');
            
            if (currentUser) {
                //console.log(
                // Usuario ya está logueado, mostrar la app directamente
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('loading-screen').style.display = 'flex';
                
                // Configurar permisos de navegación
                setupNavigationPermissions();
                
                // Cargar datos de la aplicación
                //console.log(
                loadAppData();
            } else {
                //console.log(
                // Usuario no está logueado, mostrar login
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        // Inicializar verificación de autenticación
        checkAuthentication();

    </script>

    <!-- Cache Management -->
    <script>
        // Función para limpiar completamente el cache del navegador
        function clearAllCache() {
            //console.log(
            // Limpiar cache del navegador
            if ('caches' in window) {
                caches.keys().then((cacheNames) => {
                    return Promise.all(
                        cacheNames.map((cacheName) => {
                            //console.log(
                            return caches.delete(cacheName);
                        })
                    );
                }).then(() => {
                    //console.log(
                    // Recargar la página después de limpiar el cache
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1000);
                });
            }
        }

        // Función para forzar recarga sin cache
        function hardReload() {
            //console.log(
            // Limpiar cache y recargar
            clearAllCache();
        }

        // Exponer funciones globalmente para uso manual
        window.clearAllCache = clearAllCache;
        window.hardReload = hardReload;

        // Instalar PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            //console.log(
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar notificación de instalación elegante
            const installNotification = document.createElement('div');
            installNotification.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    right: 20px;
                    background: #f8f9fa;
                    border-radius: 16px;
                    padding: 16px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                    z-index: 1000;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                ">
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 12px;
                    ">
                        <div style="
                            width: 48px;
                            height: 48px;
                            background: #0b3d91;
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 20px;
                            color: white;
                            font-weight: bold;
                            flex-shrink: 0;
                        ">
                            📱
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="
                                font-size: 16px;
                                font-weight: 600;
                                color: #2c3e50;
                                line-height: 1.2;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            ">
                                Bermuda Elevator
                            </div>
                            <div style="
                                font-size: 14px;
                                color: #7f8c8d;
                                line-height: 1.3;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            ">
                                Descarga La app Ahora
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button id="notification-dismiss" style="
                            background: transparent;
                            border: 1px solid #dee2e6;
                            color: #6c757d;
                            padding: 8px 12px;
                            border-radius: 8px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        ">
                            Cerrar
                        </button>
                        <button id="notification-install" style="
                            background: #0b3d91;
                            border: none;
                            color: white;
                            padding: 8px 16px;
                            border-radius: 8px;
                            font-size: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        ">
                            Instalar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(installNotification);
            
            // Event listeners
            document.getElementById('notification-dismiss').addEventListener('click', () => {
                installNotification.remove();
            });
            
            document.getElementById('notification-install').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            //console.log(
                        } else {
                            //console.log(
                        }
                        deferredPrompt = null;
                        installNotification.remove();
                    });
                } else {
                    //console.log(
                    installNotification.remove();
                }
            });
        });

        // PWA instalada
        window.addEventListener('appinstalled', (evt) => {
            //console.log(
        });
    </script>
</body>
</html>