<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bermuda Elevators - Elevator Management System</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b3d91">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bermuda Elevators">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Evitar pull-to-refresh y scroll no deseado */
        html, body {
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
            -webkit-overflow-scrolling: touch;
        }

        body {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            color: #333;
            min-height: 100vh;
        }

        .app-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            overflow: hidden;
            position: relative;
            flex-direction: column;
            position: relative;
        }

        .screen {
            width: 100%;
            height: calc(100vh - 80px);
            display: none;
            flex-direction: column;
            background: #f8f9fa;
            padding-bottom: 20px;
        }

        .screen.active {
            display: flex;
        }

        /* Header Styles */
        .header {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-center {
            flex: 1;
            text-align: center;
            font-weight: 700;
            font-size: 20px;
            color: #2c3e50;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .icon-btn:hover {
            background: #dee2e6;
            transform: scale(1.05);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 40px 20px;
            text-align: center;
        }

        .login-logo h1 {
            font-size: 32px;
            font-weight: 700;
            color: #4285F4;
            margin-bottom: 40px;
            letter-spacing: -0.5px;
        }

        .login-form h2 {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 30px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form input {
            width: 100%;
            padding: 15px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: #ffffff;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #4285F4;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 20px;
        }

        .login-btn:hover {
            background: #3367d6;
        }

        .login-separator {
            margin: 20px 0;
            color: #666;
            font-size: 14px;
        }

        .social-login {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .social-btn {
            width: 50px;
            height: 50px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .social-btn:hover {
            border-color: #4285F4;
            transform: translateY(-2px);
        }

        .signup-link {
            color: #666;
            font-size: 14px;
        }

        .signup-link a {
            color: #4285F4;
            text-decoration: none;
            font-weight: 500;
        }

        .signup-link a:hover {
            text-decoration: underline;
        }

        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1e3a8a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-logo {
            font-size: 36px;
            font-weight: 700;
            color: white;
            margin-bottom: 20px;
            letter-spacing: -1px;
        }

        .loading-logo .highlight {
            color: #10b981;
        }

        .loading-dots {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #60a5fa;
            border-radius: 50%;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .loading-dot:nth-child(4) {
            animation-delay: 0.6s;
        }

        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: 500;
            opacity: 0.9;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #60a5fa, #10b981);
            border-radius: 2px;
            animation: loadingProgress 3s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% {
                opacity: 0.4;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        @keyframes loadingProgress {
            0% {
                width: 0%;
            }
            50% {
                width: 70%;
            }
            100% {
                width: 100%;
            }
        }


        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e74c3c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .profile-pic:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .profile-pic svg {
            color: white;
            opacity: 0.8;
        }

        .profile-pic:hover svg {
            opacity: 1;
        }

        /* Profile Modal Styles */
        .profile-modal-content {
            max-width: 400px;
            width: 90%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .profile-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .profile-pic-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .profile-modal-info h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .profile-modal-info p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .profile-modal-body {
            padding: 20px 0;
        }

        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
        }

        .profile-menu-item:hover {
            background: #f8f9fa;
            color: #667eea;
        }

        .profile-menu-item svg {
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .profile-menu-item:hover svg {
            color: #667eea;
        }

        .profile-menu-divider {
            height: 1px;
            background: #e9ecef;
            margin: 10px 0;
        }

        .logout-item {
            color: #e74c3c;
        }

        .logout-item:hover {
            background: #fdf2f2;
            color: #c0392b;
        }

        .logout-item svg {
            color: #e74c3c;
        }

        .logout-item:hover svg {
            color: #c0392b;
        }

        /* Modal Base Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            position: absolute;
            top: 15px;
            right: 20px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            /* Sin margin-top para que no se vea afectado */
            margin-top: 0;
            /* Scroll interno */
            overflow-y: auto;
            overflow-x: hidden;
            height: 100vh;
            /* Evitar pull-to-refresh */
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
            -webkit-overflow-scrolling: touch;
        }

        /* Dashboard Styles */
        .hero-section {
            text-align: left;
            margin-bottom: 30px;
            position: fixed;
            top: 12%;
            left: 0;
            right: 0;
            z-index: 100;
            background: transparent;
            padding: 20px;
            margin-top: 0;
            /* Evitar pull-to-refresh */
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }

        .hero-title {
            font-size: 43px !important;
            font-weight: 400;
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.2;
            margin-top: -20px;
        }

        .hero-title strong {
            font-weight: 800;
        }

        .hero-subtitle {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 20px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 500;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #27ae60;
        }

        .stat-change.negative {
            color: #e74c3c;
        }

        /* Search Container */
        .search-container {
            background: white;
            border-radius: 15px;
            padding: 8px 15px;
            margin-bottom: 25px;
            position: fixed;
            top: 207px;
            left: 20px;
            right: 20px;
            z-index: 50;
        }

        .fixed-background {
            position: fixed;
            top: -11px;
            left: -50px;
            width: calc(100vw + 100px);
            height: 376px;
            background: #f8f9fa;
            z-index: 30;
            display: none;
        }

        #dashboard-screen.active .fixed-background {
            display: block;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin: 0 auto;
            max-width: 100%;
        }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            outline: none;
            color: #333;
        }

        .search-input::placeholder {
            color: #999;
        }

        .filter-btn {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn {
            background: #1e1e1e;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .search-btn:hover {
            background: #2a2a2a;
        }

        .filter-btn:hover {
            background: #5a6268;
        }

        .status-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-pill {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #e9ecef;
            color: #495057;
        }

        .filter-pill.active {
            background: #2c3e50;
            color: white;
        }

        .filter-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Section Lists */
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: fixed;
            top: 288px;
            left: 20px;
            right: 20px;
            background: #f8f9fa;
            padding: 15px 20px;
            z-index: 45;
            border-radius: 10px;
            transform: translateY(35%);
        }

        .section-title h3 {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
        }

        .view-all {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
        }

        .item-card {
            background: #1e1e1e;
            border-radius: 15px;
            padding: 20px !important;
            margin-bottom: 9px !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            color: white;
            min-height: 160px !important;
            /* Eliminar fondo azul de selección */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-focus-ring-color: transparent;
            outline: none;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Eliminar fondo azul de selección en todas las tarjetas */
        .item-card:active,
        .item-card:focus {
            -webkit-tap-highlight-color: transparent;
            -webkit-focus-ring-color: transparent;
            outline: none;
            background: #1e1e1e !important;
        }

        .item-card.dark {
            background: #1e1e1e;
            color: white;
        }

        /* Estilos adicionales para eliminar selección en elementos clickeables */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* Eliminar fondo azul en botones y elementos interactivos */
        button:active,
        button:focus,
        .btn:active,
        .btn:focus {
            -webkit-tap-highlight-color: transparent;
            -webkit-focus-ring-color: transparent;
            outline: none;
        }

        /* Control de cursor para diferentes elementos */
        
        /* Elementos clickeables - cursor pointer */
        .item-card,
        .item-card *,
        button,
        .btn,
        .profile-pic,
        .search-btn,
        .bookmark-btn,
        .close-btn,
        .nav-item,
        .status-badge,
        .item-icon,
        .item-details,
        .item-title,
        .item-meta,
        .item-location,
        .progress-bar,
        .progress-fill {
            cursor: pointer !important;
        }

        /* Elementos de texto no editables - cursor default */
        h1, h2, h3, h4, h5, h6,
        p, span, div:not(.item-card):not(.btn):not(button),
        .item-info,
        .item-card-header,
        .loading-text,
        .hero-section,
        .card h2,
        .form-group label {
            cursor: default !important;
        }

        /* Inputs y textareas - cursor text */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            cursor: text !important;
        }

        /* Elementos específicos que no deben tener cursor pointer */
        .item-card .item-title,
        .item-card .item-meta,
        .item-card .item-location,
        .item-card .status-badge {
            cursor: inherit !important;
        }

        /* BLOQUEAR CURSOR DE TEXTO SOLO EN TEXTOS */
        
        /* Solo inputs y textareas pueden tener cursor de texto */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="search"],
        textarea,
        select,
        [contenteditable="true"] {
            cursor: text !important;
        }

        /* BLOQUEAR CURSOR DE TEXTO EN TODOS LOS TEXTOS */
        h1, h2, h3, h4, h5, h6,
        p, span, div, label,
        .item-details,
        .item-title,
        .item-meta,
        .item-location,
        .loading-text,
        .hero-section,
        .card h2,
        .form-group label,
        .item-card .item-details h4,
        .item-card .item-details p,
        .item-card .item-title,
        .item-card .item-meta span,
        .item-card .item-location,
        .status-badge,
        .item-icon,
        .progress-bar,
        .progress-fill,
        .profile-pic,
        .search-btn,
        .close-btn,
        .bookmark-btn,
        .nav-item,
        .item-card-header,
        .item-info,
        .item-card * {
            cursor: default !important;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Elementos clickeables mantienen pointer */
        .item-card,
        button,
        .btn,
        a,
        [onclick],
        [role="button"] {
            cursor: pointer !important;
        }

        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 9px !important;
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .item-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: #3498db;
        }

        .item-card.dark .item-icon {
            background: #2a2a2a;
            color: #3498db;
        }

        .item-details h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: white;
        }

        .item-details p {
            font-size: 14px;
            color: #bdc3c7;
            margin-bottom: 2px;
        }

        .item-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }

        .item-location {
            font-size: 14px;
            color: #bdc3c7;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.operational {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.maintenance {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.out-of-service {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.offline {
            background: #ffeaa7 !important;
            color: #d63031 !important;
        }

        .status-badge.alarm {
            background: #f8d7da !important;
            color: #721c24 !important;
            border: 2px solid #e74c3c !important;
            font-weight: 700 !important;
        }

        .item-card.dark .status-badge.operational {
            background: #2d5a2d;
            color: #90ee90;
        }

        .item-card.dark .status-badge.maintenance {
            background: #5a4a00;
            color: #ffd700;
        }

        .item-card.dark .status-badge.out-of-service {
            background: #5a1a1a;
            color: #ff6b6b;
        }

        .item-card.dark .status-badge.offline {
            background: #8b4513 !important;
            color: #ffa500 !important;
        }

        .item-card.dark .status-badge.alarm {
            background: #5a1a1a !important;
            color: #ff6b6b !important;
            border: 2px solid #e74c3c !important;
            font-weight: 700 !important;
        }

        .bookmark-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #ddd;
            transition: all 0.3s ease;
        }

        .bookmark-btn.active {
            color: #e74c3c;
        }

        .item-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 9px !important;
        }

        .item-location {
            font-size: 14px;
            color: #7f8c8d;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #495057;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px !important;
        }

        .progress-fill {
            height: 100%;
            background: #27ae60;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .item-card.dark .progress-bar {
            background: #495057;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 12px;
            transition: all 0.3s ease;
            border-radius: 12px;
            color: #7f8c8d;
            min-width: 60px;
        }

        .nav-item.active {
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .nav-item:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
        }

        .nav-item.active .nav-label {
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 28px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .status-filters {
                flex-wrap: wrap;
            }
            
            .filter-pill {
                flex: 1;
                min-width: 100px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen.active {
            display: flex;
        }


        /* Specific section styles */
        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .service-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }


        .report-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        /* Service Log Styles */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin: 20px auto;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-group select,
        .form-group textarea,
        .form-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        #addServiceBtn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #addServiceBtn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        #serviceMsg {
            font-size: 14px;
            font-weight: 500;
        }

        #serviceMsg.success {
            color: #27ae60;
        }

        #serviceMsg.error {
            color: #e74c3c;
        }

        .photo-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .service-history-item {
            background: #1e1e1e;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }

        .service-history-item h4 {
            margin: 0 0 8px 0;
            color: white;
            font-size: 16px;
        }

        .service-history-item p {
            margin: 4px 0;
            color: #bdc3c7;
            font-size: 14px;
        }

        #viewHistoryBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }


        .delete-entry-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }

        /* Report Generation Styles */
        #generateReportBtn {
            background: #0b3d91;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #generateReportBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        .success-msg {
            font-size: 14px;
            font-weight: 500;
        }

        .success-msg.success {
            color: #27ae60;
        }

        .success-msg.error {
            color: #e74c3c;
        }

        /* Device Management Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
        }

        .table td {
            border-bottom: 1px solid #e9ecef;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .edit-email:hover {
            background: #1f4e79;
            transform: translateY(-1px);
        }

        #addDeviceBtn {
            background: #0b3d91;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #addDeviceBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        /* User Management Styles */
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #1565c0;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .info-box p {
            margin: 0;
            font-size: 14px;
        }


        #addRoleBtn {
            background: #0b3d91;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #addRoleBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        .delR {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .delR:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }

        #viewUsersBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        #viewDevicesBtn:hover {
            background: #0a2d6b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
        }

        #userEmail {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        #userEmail:focus {
            outline: none;
            border-color: #0b3d91;
            box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
        }

        #rolePass {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        #rolePass:focus {
            outline: none;
            border-color: #0b3d91;
            box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
        }

        /* Message styles */
        .success {
            color: #27ae60;
            font-weight: 600;
        }

        .error {
            color: #e74c3c;
            font-weight: 600;
        }

        .info {
            color: #3498db;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <h1>Bermuda Elevators</h1>
            </div>
            
            <div class="login-form">
                <h2>Login to your Account</h2>
                
                <form id="loginForm">
                    <div class="form-group">
                        <input type="email" id="loginEmail" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="loginPassword" placeholder="Password" required>
                    </div>
                    
                    <button type="submit" class="login-btn">Sign in</button>
                    
                    <div class="login-separator">
                        <span>- Or sign in with -</span>
                    </div>
                    
                    <div class="social-login">
                        <button type="button" class="social-btn google-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                        </button>
                        <button type="button" class="social-btn facebook-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#1877F2">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </button>
                        <button type="button" class="social-btn twitter-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#1DA1F2">
                                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                            </svg>
                        </button>
                    </div>
                </form>
                
                <div class="signup-link">
                    <span>Don't have an account? <a href="#" id="signupLink">Sign up</a></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="loading-logo">
            Bermuda<span class="highlight">Elevators</span>
        </div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <div class="loading-text">Cargando sistema...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content profile-modal-content">
            <div class="profile-modal-header">
                <div class="profile-modal-avatar">
                    <div class="profile-pic-large">A</div>
                </div>
                <div class="profile-modal-info">
                    <h3 id="profile-user-name">User</h3>
                    <p id="profile-user-email">user@example.com</p>
                </div>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            
            <div class="profile-modal-body">
                <div class="profile-menu-item" onclick="showProfileSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Profile</span>
                </div>
                
                <div class="profile-menu-item" onclick="showAccountSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                    </svg>
                    <span>Settings</span>
                </div>
                
                <div class="profile-menu-item" onclick="showNotifications()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span>Notifications</span>
                </div>
                
                <div class="profile-menu-divider"></div>
                
                <div class="profile-menu-item logout-item" onclick="showLogoutModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16,17 21,12 16,7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Logout</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logout-confirm-modal" class="modal" style="display: none;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #e74c3c; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16,17 21,12 16,7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </div>
                <h2 style="margin: 0; color: #2c3e50; font-size: 24px;">Confirm Logout</h2>
                <p style="color: #7f8c8d; margin: 10px 0 0 0; font-size: 16px;">Are you sure you want to logout from your account?</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button id="cancel-logout" style="flex: 1; background: #95a5a6; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Cancel
                </button>
                <button id="confirm-logout" style="flex: 1; background: #e74c3c; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <div class="app-container" id="main-app" style="display: none;">
        <!-- Dashboard Screen -->
        <div class="screen active" id="dashboard-screen">
            <!-- Fondo fijo para elementos superiores -->
            <div class="fixed-background"></div>
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn" id="refresh-all-btn" title="Actualizar todas las APIs">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 2v6h-6M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M3 22v-6h6M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        </svg>
                    </button>
                </div>
                <div class="header-right">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="4" y1="21" x2="4" y2="14"></line>
                            <line x1="4" y1="10" x2="4" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12" y2="3"></line>
                            <line x1="20" y1="21" x2="20" y2="16"></line>
                            <line x1="20" y1="12" x2="20" y2="3"></line>
                            <line x1="1" y1="14" x2="7" y2="14"></line>
                            <line x1="9" y1="8" x2="15" y2="8"></line>
                            <line x1="17" y1="16" x2="23" y2="16"></line>
                        </svg>
                    </button>
                    <button class="icon-btn" id="notification-header-btn" title="Mostrar notificación de instalación">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="hero-section">
                    <h1 class="hero-title">Hello! <strong>User</strong></h1>
                    <p class="hero-subtitle">Monitor and manage all elevator operations</p>
                </div>


                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Search elevators..." id="search-input">
                        <button class="search-btn" id="search-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                    </div>

                </div>

                <div class="section-title">
                    <h3>Recent Activity</h3>
                    <a href="#" class="view-all" onclick="showScreen('units-screen'); return false;">View All</a>
                </div>

                <div class="item-listings" id="dashboard-listings" style="margin-top: 366px; position: fixed; top: 7px; left: 20px; right: 20px; z-index: 40;">
                    <!-- Activity items will be populated by JavaScript -->
                </div>

            </div>
        </div>

        <!-- Units Screen -->
        <div class="screen" id="units-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn" id="refresh-units-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">Elevator Units</div>
                <div class="header-right">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="units-grid" id="units-grid">
                    <!-- Units will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Service Screen -->
        <div class="screen" id="service-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">Service & Maintenance</div>
                <div class="header-right">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="card" id="serviceCard" style="display: block; max-width: 90%; width: 90%; margin: -3% auto 20px auto;">
                    <h2>Service Log</h2>
                    <div style="margin-bottom:20px;">
                      <label style="display:block;margin-bottom:8px;font-weight:600;color:#0b3d91;font-size:0.9rem;">Select Device</label>
                        <select id="serviceDeviceSelect" style="padding:8px;font-size:0.95rem;border-radius:8px;width:100%;border:2px solid #ddd;">
                          <option value="">Loading devices...</option>
                        </select>
                </div>
                    
                    <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                      <h3 style="margin:0 0 10px 0;color:#0b3d91;font-size:1rem;">Add Service Entry</h3>
                      <div class="form-group">
                        <label>Service Type *</label>
                        <select id="serviceType" style="width:100%;padding:8px;font-size:0.9rem;">
                          <option value="maintenance">Routine Maintenance</option>
                          <option value="repair">Repair</option>
                          <option value="troubleshooting">Troubleshooting</option>
                          <option value="inspection">Inspection</option>
                          <option value="emergency">Emergency Call</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Notes/Description *</label>
                        <textarea id="serviceNotes" placeholder="Describe the work performed..." style="width:100%;min-height:80px;padding:8px;font-size:0.9rem;border:1px solid #ccc;border-radius:8px;resize:vertical;box-sizing:border-box;"></textarea>
                      </div>
                      <button id="addServiceBtn" style="width:100%;padding:10px;font-size:0.95rem;margin-top:10px;">Add Service Entry</button>
                      <p id="serviceMsg" style="margin:8px 0;"></p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;" id="viewHistoryContainer">
                        <button id="viewHistoryBtn" style="background: #0b3d91; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            View History
                        </button>
                    </div>
                  </div>
            </div>
        </div>

        <!-- Reports Screen -->
        <div class="screen" id="reports-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">Reports & Analytics</div>
                <div class="header-right">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                  <h3 style="margin:0 0 15px 0;color:#0b3d91;font-size:1rem;">Generate Report</h3>
                  
                  <div class="form-group">
                    <label>Report Type</label>
                    <select id="reportType" style="width:100%;padding:8px;font-size:0.9rem;">
                      <option value="alarms">Alarm History Report</option>
                      <option value="service">Service Log Report</option>
                      <option value="summary">Monthly Summary</option>
                    </select>
                </div>
                  
                  <div class="form-group">
                    <label>Select Device</label>
                        <select id="reportDeviceSelect" style="width:100%;padding:8px;font-size:0.9rem;">
                          <option value="all">Loading devices...</option>
                        </select>
                  </div>
                  
                  <div class="form-group">
                    <label>Date Range</label>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                      <input type="date" id="reportStartDate" style="width:100%;padding:8px;font-size:0.85rem;">
                      <input type="date" id="reportEndDate" style="width:100%;padding:8px;font-size:0.85rem;">
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label>Technician Comments</label>
                    <textarea id="reportComments" placeholder="Enter your observations, findings, or recommendations..." style="width:100%;padding:8px;font-size:0.85rem;border:1px solid #ddd;border-radius:4px;resize:vertical;min-height:80px;font-family:inherit;"></textarea>
                  </div>
                  
                  <button id="generateReportBtn" style="width:100%;padding:10px;font-size:0.95rem;margin-top:10px;">Generate &amp; Download PDF</button>
                  <p id="reportMsg" style="margin: 8px 0px; color: rgb(41, 128, 185);" class="success-msg"></p>
                </div>
            </div>
        </div>

        <!-- Devices Screen -->
        <div class="screen" id="devices-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">Connected Devices</div>
                <div class="header-right">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="card" id="devicesCard" style="display: block; max-width: 450px;">
                    <h2 style="font-size:1.2rem;margin-bottom:12px;">Manage Devices</h2>
                    <div class="form-group">
                      <label>Device ID *</label>
                      <input id="newId" placeholder="e.g., ID09" style="padding:7px;font-size:0.85rem;">
                </div>
                    <div class="form-group">
                      <label>Building Name *</label>
                      <input id="newBld" placeholder="e.g., Hamilton Tower" style="padding:7px;font-size:0.85rem;">
            </div>
                    <div class="form-group">
                      <label>Unit/Elevator *</label>
                      <input id="newUnit" placeholder="e.g., Elevator A" style="padding:7px;font-size:0.85rem;">
                    </div>
                    <div class="form-group">
                      <label>Client Email</label>
                      <input id="newEmail" type="email" placeholder="client@example.com" style="padding:7px;font-size:0.85rem;">
                    </div>
                    <button id="addDeviceBtn" style="width:100%;padding:8px;font-size:0.9rem;margin-top:5px;">Add Device</button>
                    <p id="deviceMsg" style="margin:8px 0;"></p>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="viewDevicesBtn" style="background: #0b3d91; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-right: 10px;">
                            View All Devices
                        </button>
                    </div>
                  </div>
            </div>
        </div>

        <!-- Users Screen -->
        <div class="screen" id="users-screen">
            <div class="header">
                <div class="header-left">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
                <div class="header-center">User Management</div>
                <div class="header-right">
                    <button class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="profile-pic profile-btn" title="Perfil de usuario" style="cursor: pointer;">
                        A
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="card" id="usersCard" style="display: block;">
                    <h2>Manage Users</h2>
                    <div class="form-group">
                      <label>Email *</label>
                      <input id="userEmail" type="email" placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                      <label>Password *</label>
                      <input id="rolePass" placeholder="User's password">
                </div>
                    <div class="form-group">
                      <label>Role Type *</label>
                      <select id="roleType" style="width:100%;padding:10px;">
                        <option value="client">Client (View Only)</option>
                        <option value="technician">Technician (All Buildings)</option>
                        <option value="admin">Admin (Full Access)</option>
                      </select>
            </div>
                    <div class="form-group" id="buildingsGroup">
                      <label>Allowed Buildings (Clients only)</label>
                            <select id="allowedBuildings" style="width:100%;padding:10px;">
                                <option value="">Loading buildings...</option>
                            </select>
                    </div>
                    <div class="info-box" id="technicianInfo" style="display:none;">
                      <strong>Technician Access</strong>
                      <p>Technicians automatically have access to all buildings.</p>
                    </div>
                    <button id="addRoleBtn" style="width:100%;">Add/Update User</button>
                    <p id="userMsg"></p>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="viewUsersBtn" style="background: #0b3d91; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            View All Users
                        </button>
                    </div>
                  </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('dashboard-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </div>
                <div class="nav-label">Dashboard</div>
            </div>
            <div class="nav-item" onclick="showScreen('units-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9,22 9,12 15,12 15,22"></polyline>
                    </svg>
                </div>
                <div class="nav-label">Units</div>
            </div>
            <div class="nav-item" onclick="showScreen('service-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                    </svg>
                </div>
                <div class="nav-label">Service</div>
            </div>
            <div class="nav-item" onclick="showScreen('reports-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"></path>
                        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                    </svg>
                </div>
                <div class="nav-label">Reports</div>
            </div>
            <div class="nav-item" onclick="showScreen('devices-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                </div>
                <div class="nav-label">Devices</div>
            </div>
            <div class="nav-item" onclick="showScreen('users-screen')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="nav-label">Users</div>
            </div>
        </div>
    </div>

    <!-- Modal de Elevador -->
    <div id="elevator-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="elevator-title" style="margin: 0; color: #2c3e50; font-size: 24px;">Elevator A-01</h2>
            </div>
            <p id="elevator-timestamp" class="timestamp" style="color: #7f8c8d; margin-bottom: 20px;">Last Update: 23/10/2025, 15:41:14</p>
            <div id="elevator-statuses" style="margin-bottom: 20px;">
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Out of Service</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">NORMAL</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Fire Service</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">NORMAL</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Phone Comm</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">NORMAL</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Pit Flooded</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">NORMAL</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Elevator at DZ</span>
                    <span class="blue" style="color: #3498db; font-weight: 600;">NO</span>
                </div>
                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>Elevator Moving</span>
                    <span class="blue" style="color: #3498db; font-weight: 600;">NO</span>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="close-elevator-modal" style="background: #000000; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Filtros -->
    <div id="filter-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 20px;">Advanced Filters</h3>
                <button id="close-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div class="modal-filters">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;">Elevator Status:</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="status" value="all" checked style="margin: 0;">
                            <span>All Status</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="status" value="operational" style="margin: 0;">
                            <span>Operational</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="status" value="maintenance" style="margin: 0;">
                            <span>Maintenance</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="status" value="out-of-service" style="margin: 0;">
                            <span>Out of Service</span>
                        </label>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;">Building:</label>
                    <select id="buildingFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="all">All Buildings</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="apply-filters" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Apply Filters</button>
                    <button id="clear-filters" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Historial de Servicios -->
    <div id="service-history-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">Service History</h3>
                <button id="close-history-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div id="serviceHistory" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <p style="text-align:center;color:#999;padding:20px;">No service history yet</p>
            </div>
        </div>
    </div>

    <!-- Modal de Lista de Usuarios -->
    <div id="users-list-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 900px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">All Users</h3>
                <button id="close-users-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <table class="table" id="rolesTable">
                    <thead><tr><th>Password</th><th>Role</th><th>Actions</th></tr></thead>
                    <tbody>
                        <!-- Los datos se cargarán dinámicamente desde la API -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles de Usuario -->
    <div id="user-details-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">User Details</h3>
                <button id="close-user-details-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div id="userDetailsContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- Los detalles del usuario se cargarán dinámicamente desde la API -->
            </div>
        </div>
    </div>

    <!-- Modal de Lista de Dispositivos -->
    <div id="devices-list-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">All Devices</h3>
                <button id="close-devices-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <table class="table" id="devicesTable" style="font-size:0.8rem;">
                    <thead><tr><th style="padding:5px;">ID</th><th style="padding:5px;">Building</th><th style="padding:5px;">Unit</th><th style="padding:5px;">Actions</th></tr></thead>
                    <tbody>
                        <tr data-device-id="ID00" data-building="N/A" data-unit="N/A" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">ID00</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">N/A</td>
                            <td style="padding:5px;font-size:0.8rem;">N/A</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="ID00" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="ID00" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                        <tr data-device-id="ID01" data-building="test tower house" data-unit="1" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">ID01</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">test tower house</td>
                            <td style="padding:5px;font-size:0.8rem;">1</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="ID01" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="ID01" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                        <tr data-device-id="ID02" data-building="Seon Place" data-unit="Elevator 1" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">ID02</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">Seon Place</td>
                            <td style="padding:5px;font-size:0.8rem;">Elevator 1</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="ID02" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="ID02" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                        <tr data-device-id="ID08" data-building="Continental Building" data-unit="Elevator 1" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">ID08</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">Continental Building</td>
                            <td style="padding:5px;font-size:0.8rem;">Elevator 1</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="ID08" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="ID08" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                        <tr data-device-id="Id01" data-building="Hamilton tower" data-unit="Elevator 2" data-email="">
                            <td style="padding:5px;"><strong style="font-size:0.85rem;">Id01</strong></td>
                            <td style="padding:5px;font-size:0.8rem;">Hamilton tower</td>
                            <td style="padding:5px;font-size:0.8rem;">Elevator 2</td>
                            <td style="white-space:nowrap;padding:5px;">
                                <button class="edit-email" data-id="Id01" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                                <button class="del btn-delete" data-id="Id01" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles de Dispositivo -->
    <div id="device-details-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 700;">Device Details</h3>
                <button id="close-device-details-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
            </div>
            <div id="deviceDetailsContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- Device details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Hidden iframe for form submission -->
    <iframe id="hiddenIframe" name="hiddenIframe" style="display: none;"></iframe>

    <!-- Hidden form for deleting users -->
    <form id="deleteUserForm" action="https://script.google.com/macros/s/AKfycbxUleHuPBZ9FxPX8_p2bZz63NFTpI7oUWd8qX6dP2ktH6LonR7YULPLoCPW28Avv-KArQ/exec" method="post" target="hiddenIframe" style="display: none;">
        <input type="email" name="correo" id="deleteUserEmail" placeholder="Correo del usuario a eliminar" required="">
        <input type="hidden" name="action" value="delete_user">
    </form>

    <!-- Hidden form for adding devices -->
    <form id="addDeviceForm" action="https://script.google.com/macros/s/AKfycbyEyIQFBkpPRfo31BPKX0neg3k8ufj-M_unbtYM2xKI0yL6QBNdokHD0bghSNxpS2Hm/exec" method="post" target="hiddenIframe" style="display: none;">
        <input type="text" name="deviceId" id="addDeviceId" required="">
        <input type="text" name="buildingName" id="addDeviceBuilding" required="">
        <input type="text" name="unitElevator" id="addDeviceUnit" required="">
        <input type="email" name="clientEmail" id="addDeviceEmail">
        <input type="hidden" name="action" value="add_device">
    </form>

    <!-- Hidden form for deleting devices -->
    <form id="deleteDeviceForm" action="https://script.google.com/macros/s/AKfycbyEyIQFBkpPRfo31BPKX0neg3k8ufj-M_unbtYM2xKI0yL6QBNdokHD0bghSNxpS2Hm/exec" method="post" target="hiddenIframe" style="display: none;">
        <input type="email" name="clientEmail" id="deleteDeviceEmail" required="">
        <input type="hidden" name="action" value="delete_device">
    </form>

    <!-- Modal de Confirmación de Eliminación de Usuario -->
    <div id="delete-confirm-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #e74c3c; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
                <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 20px; font-weight: 700;">¿Estás seguro?</h3>
                <p style="margin: 0; color: #6c757d; font-size: 14px;">Esta acción no se puede deshacer</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="cancel-delete" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Cancelar
                </button>
                <button id="confirm-delete" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación de Dispositivo -->
    <div id="delete-device-confirm-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #e74c3c; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                    </svg>
                </div>
                <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 20px; font-weight: 700;">¿Eliminar Dispositivo?</h3>
                <p style="margin: 0; color: #6c757d; font-size: 14px;">Esta acción no se puede deshacer</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="cancel-delete-device" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Cancelar
                </button>
                <button id="confirm-delete-device" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Datos de ejemplo para elevadores
        const elevatorData = [
            {
                id: 1,
                name: "Elevator A-01",
                location: "Building A - Floor 1-10",
                status: "operational",
                lastService: "2024-01-15",
                nextService: "2024-02-15",
                isDark: false,
                progress: 100
            },
            {
                id: 2,
                name: "Elevator A-02",
                location: "Building A - Floor 11-20",
                status: "maintenance",
                lastService: "2024-01-10",
                nextService: "2024-01-25",
                isDark: true,
                progress: 100
            },
            {
                id: 3,
                name: "Elevator B-01",
                location: "Building B - Floor 1-8",
                status: "operational",
                lastService: "2024-01-12",
                nextService: "2024-02-12",
                isDark: false,
                progress: 100
            },
            {
                id: 4,
                name: "Elevator B-02",
                location: "Building B - Floor 9-16",
                status: "operational",
                lastService: "2024-01-08",
                nextService: "2024-02-08",
                isDark: true,
                progress: 100
            }
        ];

        const serviceData = [
            {
                id: 1,
                elevator: "Elevator A-02",
                type: "Routine Maintenance",
                status: "In Progress",
                technician: "John Smith",
                scheduledDate: "2024-01-25",
                priority: "Medium"
            },
            {
                id: 2,
                elevator: "Elevator B-01",
                type: "Safety Inspection",
                status: "Scheduled",
                technician: "Mike Johnson",
                scheduledDate: "2024-01-30",
                priority: "High"
            },
            {
                id: 3,
                elevator: "Elevator A-01",
                type: "Software Update",
                status: "Completed",
                technician: "Sarah Wilson",
                scheduledDate: "2024-01-20",
                priority: "Low"
            }
        ];

        const reportData = [
            {
                id: 1,
                title: "Monthly Performance Report",
                type: "Performance",
                date: "2024-01-01",
                status: "Generated"
            },
            {
                id: 2,
                title: "Maintenance Cost Analysis",
                type: "Financial",
                date: "2024-01-05",
                status: "Generated"
            },
            {
                id: 3,
                title: "Safety Compliance Report",
                type: "Safety",
                date: "2024-01-10",
                status: "Pending"
            }
        ];

        const deviceData = [
            {
                id: 1,
                name: "Control Panel A-01",
                type: "Main Controller",
                status: "Online",
                location: "Building A - Basement",
                lastUpdate: "2 minutes ago"
            },
            {
                id: 2,
                name: "Sensor Network B-01",
                type: "IoT Sensors",
                status: "Online",
                location: "Building B - All Floors",
                lastUpdate: "1 minute ago"
            },
            {
                id: 3,
                name: "Emergency System",
                type: "Safety Device",
                status: "Offline",
                location: "Building A - Floor 5",
                lastUpdate: "5 minutes ago"
            }
        ];

        const userData = [
            {
                id: 1,
                name: "Admin User",
                role: "Administrator",
                email: "admin@elevator.com",
                status: "Active",
                lastLogin: "2024-01-20"
            },
            {
                id: 2,
                name: "Technician 1",
                role: "Maintenance",
                email: "tech1@elevator.com",
                status: "Active",
                lastLogin: "2024-01-19"
            },
            {
                id: 3,
                name: "Operator 1",
                role: "Operator",
                email: "op1@elevator.com",
                status: "Inactive",
                lastLogin: "2024-01-15"
            }
        ];


        // Función para crear tarjeta de elevador
        function createElevatorCard(elevator) {
            const card = document.createElement('div');
            card.className = `item-card ${elevator.isDark ? 'dark' : ''}`;
            card.style.marginBottom = '18px';
            card.onclick = function() { openElevatorModal(elevator); };
            
            const statusClass = elevator.status === 'operational' ? 'operational' : 
                              elevator.status === 'maintenance' ? 'maintenance' : 'out-of-service';
            
            card.innerHTML = `
                <div class="item-card-header">
                    <div class="item-info">
                        <div class="item-icon">🏢</div>
                        <div class="item-details">
                            <h4>${elevator.name}</h4>
                            <p>${elevator.location}</p>
                        </div>
                    </div>
                    <button class="bookmark-btn" onclick="toggleBookmark(${elevator.id}); event.stopPropagation();">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                </div>
                <div class="item-title">${elevator.id}</div>
                <div class="item-meta">
                    <span class="item-location">${elevator.location}</span>
                    <span class="status-badge ${statusClass}">${elevator.status}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${elevator.progress}%"></div>
                </div>
            `;
            
            return card;
        }

        // Función para crear tarjeta de servicio
        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'item-card';
            
            card.innerHTML = `
                <div class="item-card-header">
                    <div class="item-info">
                        <div class="item-icon">🔧</div>
                        <div class="item-details">
                            <h4>${service.elevator}</h4>
                            <p>${service.type}</p>
                        </div>
                    </div>
                    <span class="status-badge ${service.status.toLowerCase().replace(' ', '-')}">${service.status}</span>
                </div>
                <div class="item-title">${service.type}</div>
                <div class="item-meta">
                    <span class="item-location">Technician: ${service.technician}</span>
                    <span class="item-location">Date: ${service.scheduledDate}</span>
                </div>
            `;
            
            return card;
        }

        // Función para crear tarjeta de elevador desde datos de dispositivo
        async function createDeviceElevatorCard(device, index) {
            // Validar que el dispositivo no tenga datos corruptos
            if (!device || 
                !device.deviceId || 
                device.deviceId.includes('console.log') || 
                device.deviceId.includes('elevator_control_app.html') ||
                device.deviceId.includes('Dispositivos disponibles')) {
                console.error('Dispositivo corrupto detectado:', device);
                return null;
            }
            
            const card = document.createElement('div');
            card.className = `item-card ${index % 2 === 1 ? 'dark' : ''}`;
            card.style.cssText = `
                margin-bottom: 18px !important;
                min-height: 180px !important;
                padding: 24px !important;
            `;
            card.onclick = function() { openDeviceElevatorModal(device); };
            
            // Crear nombre del elevador basado en el edificio
            const elevatorName = device.buildingName || `Building ${device.deviceId}`;
            const location = `${device.buildingName} - ${device.unitElevator}`;
            
            // Mostrar estado inicial (operational por defecto)
            let status = 'operational';
            let statusClass = 'operational';
            let progressColor = '#27ae60';
            
            // Agregar atributo data-device-id para identificación
            card.setAttribute('data-device-id', device.deviceId);
            
            // Crear HTML inicial
            card.innerHTML = `
                <div class="item-card-header" style="margin-bottom: 18px !important;">
                    <div class="item-info">
                        <div class="item-icon">🏢</div>
                        <div class="item-details">
                            <h4>${elevatorName}</h4>
                            <p>${location}</p>
                        </div>
                    </div>
                    <button class="bookmark-btn" onclick="toggleBookmark('${device.deviceId}'); event.stopPropagation();">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                </div>
                <div class="item-title">${device.deviceId} - ${device.unitElevator}</div>
                <div class="item-meta" style="margin-bottom: 18px !important;">
                    <span class="item-location">${location}</span>
                    <span class="status-badge ${statusClass}">${status}</span>
                </div>
                <div class="progress-bar" style="margin-top: 12px !important;">
                    <div class="progress-fill" style="width: 100%; background-color: ${progressColor};"></div>
                </div>
            `;
            
            // Consultar la API con cache para obtener datos de alarmas en tiempo real
            try {
                const data = await getApiDataWithCache();
                
                if (data && data.success && data.data && Array.isArray(data.data)) {
                    // Buscar el dispositivo específico en los datos
                    const deviceData = data.data.find(d => d.device_id === device.deviceId);
                    
                    if (deviceData) {
                        // Verificar si hay alarmas activas
                        const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                       deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
                        
                        if (hasAlarm) {
                            status = 'ALARM';
                            statusClass = 'alarm';
                            progressColor = '#e74c3c';
                        }
                    } else {
                        // Si no se encuentra en la API, mostrar offline
                        status = 'offline';
                        statusClass = 'offline';
                        progressColor = '#e67e22';
                    }
                    
                    // Actualizar el HTML con el estado correcto
                    const statusBadge = card.querySelector('.status-badge');
                    const progressFill = card.querySelector('.progress-fill');
                    
                    statusBadge.textContent = status;
                    statusBadge.className = `status-badge ${statusClass}`;
                    progressFill.style.backgroundColor = progressColor;
                    
                }
            } catch (error) {
                console.error('Error consultando API para alarmas:', error);
                // Mantener estado operacional por defecto si hay error
            }
            
            return card;
        }

        // Función para abrir modal de elevador desde datos de dispositivo
        async function openDeviceElevatorModal(device) {
            const modal = document.getElementById('elevator-modal');
            const title = document.getElementById('elevator-title');
            const timestamp = document.getElementById('elevator-timestamp');
            const statusesContainer = document.getElementById('elevator-statuses');
            
            const elevatorName = device.buildingName || `Building ${device.deviceId}`;
            
            // Actualizar título
            title.textContent = elevatorName;
            
            // Iniciar timestamp dinámico
            startDynamicTimestamp();
            
            // Mostrar indicador de carga
            statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">Loading device status...</div>';
            
            // Mostrar el modal
            modal.style.display = 'flex';
            
            try {
                // Obtener datos en tiempo real de la API con cache
                const data = await getApiDataWithCache();
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    // Buscar el dispositivo específico en los datos
                    const deviceData = data.data.find(d => d.device_id === device.deviceId);
                    
                    if (deviceData) {
                        // El timestamp se actualiza dinámicamente cada segundo
                        
                        // Verificar si hay alarmas críticas
                        const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                       deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
                        
                        // Aplicar borde rojo al modal si hay alarmas
                        const modalContent = modal.querySelector('.modal-content');
                        if (hasAlarm) {
                            modalContent.style.border = '3px solid #e74c3c';
                            modalContent.style.boxShadow = '0 10px 30px rgba(231, 76, 60, 0.4)';
                        } else {
                            modalContent.style.border = 'none';
                            modalContent.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
                        }
                        
                        // Actualizar estados con datos reales
                        statusesContainer.innerHTML = `
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${deviceData.OUT_OF_SERVICE ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                <span>🚫 Out of Service</span>
                                <span class="${deviceData.OUT_OF_SERVICE ? 'true' : 'false'}" style="color: ${deviceData.OUT_OF_SERVICE ? '#e74c3c' : '#27ae60'}; font-weight: 600;">
                                    ${deviceData.OUT_OF_SERVICE ? '🚨 ALARM' : '✅ NORMAL'}
                                </span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${deviceData.FIRE_SERVICE ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                <span>🔥 Fire Service</span>
                                <span class="${deviceData.FIRE_SERVICE ? 'true' : 'false'}" style="color: ${deviceData.FIRE_SERVICE ? '#e74c3c' : '#27ae60'}; font-weight: 600;">
                                    ${deviceData.FIRE_SERVICE ? '🚨 ALARM' : '✅ NORMAL'}
                                </span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${deviceData.PHONE_COMM ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                <span>📞 Phone Comm</span>
                                <span class="${deviceData.PHONE_COMM ? 'true' : 'false'}" style="color: ${deviceData.PHONE_COMM ? '#e74c3c' : '#27ae60'}; font-weight: 600;">
                                    ${deviceData.PHONE_COMM ? '🚨 ALARM' : '✅ NORMAL'}
                                </span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${deviceData.PIT_FLOODED ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                <span>💧 Pit Flooded</span>
                                <span class="${deviceData.PIT_FLOODED ? 'true' : 'false'}" style="color: ${deviceData.PIT_FLOODED ? '#e74c3c' : '#27ae60'}; font-weight: 600;">
                                    ${deviceData.PIT_FLOODED ? '🚨 ALARM' : '✅ NORMAL'}
                                </span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🏢 Elevator at DZ</span>
                                <span class="${deviceData.AT_FLOOR ? 'true' : 'false'}" style="color: ${deviceData.AT_FLOOR ? '#3498db' : '#3498db'}; font-weight: 600;">
                                    ${deviceData.AT_FLOOR ? '✅ YES' : '❌ NO'}
                                </span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🚀 Elevator Moving</span>
                                <span class="${deviceData.MOVING ? 'true' : 'false'}" style="color: ${deviceData.MOVING ? '#3498db' : '#3498db'}; font-weight: 600;">
                                    ${deviceData.MOVING ? '✅ YES' : '❌ NO'}
                                </span>
                            </div>
                        `;
                    } else {
                        // Si no se encuentra el dispositivo, mostrar estado offline
                        // El timestamp se actualiza dinámicamente cada segundo
                        
                        statusesContainer.innerHTML = `
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🚫 Out of Service</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🔥 Fire Service</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>📞 Phone Comm</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>💧 Pit Flooded</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🏢 Elevator at DZ</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                            <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <span>🚀 Elevator Moving</span>
                                <span class="offline" style="color: #e67e22; font-weight: 600;">📡 OFFLINE</span>
                            </div>
                        `;
                    }
                } else {
                    // Si hay error en la respuesta de la API
                    timestamp.textContent = 'Error loading real-time data';
                    statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading device status</div>';
                }
            } catch (error) {
                console.error('Error loading device data:', error);
                timestamp.textContent = 'Error loading real-time data';
                statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading device status</div>';
            }
        }

        // Función para crear tarjeta de reporte
        function createReportCard(report) {
            const card = document.createElement('div');
            card.className = 'report-card';
            
            card.innerHTML = `
                <div class="item-card-header">
                    <div class="item-info">
                        <div class="item-icon">📊</div>
                        <div class="item-details">
                            <h4>${report.title}</h4>
                            <p>${report.type}</p>
                        </div>
                    </div>
                    <span class="status-badge ${report.status.toLowerCase()}">${report.status}</span>
                </div>
                <div class="item-meta">
                    <span class="item-location">Date: ${report.date}</span>
                </div>
            `;
            
            return card;
        }

        // Función para crear tarjeta de dispositivo
        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card';
            
            const statusClass = device.status === 'Online' ? 'operational' : 'out-of-service';
            
            card.innerHTML = `
                <div class="item-icon">💻</div>
                <div class="item-details">
                    <h4>${device.name}</h4>
                    <p>${device.type} - ${device.location}</p>
                    <p>Last update: ${device.lastUpdate}</p>
                </div>
                <span class="status-badge ${statusClass}">${device.status}</span>
            `;
            
            return card;
        }

        // Función para crear tarjeta de usuario
        function createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'user-card';
            
            const statusClass = user.status === 'Active' ? 'operational' : 'out-of-service';
            
            card.innerHTML = `
                <div class="user-avatar">${user.name.charAt(0)}</div>
                <div class="item-details">
                    <h4>${user.name}</h4>
                    <p>${user.role} - ${user.email}</p>
                    <p>Last login: ${user.lastLogin}</p>
                </div>
                <span class="status-badge ${statusClass}">${user.status}</span>
            `;
            
            return card;
        }


        // Función para alternar bookmark
        function toggleBookmark(itemId) {
            const bookmarkBtn = event.target.closest('.bookmark-btn');
            bookmarkBtn.classList.toggle('active');
        }

        // Variable para controlar si el modal está abierto
        let isModalOpen = false;

        // Función para actualizar el timestamp con la hora actual
        function updateTimestamp() {
            const timestampElement = document.getElementById('elevator-timestamp');
            if (timestampElement && isModalOpen) {
                const now = new Date();
                const localTime = now.toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                timestampElement.textContent = `Last Update: ${localTime}`;
            }
        }

        // Función para iniciar el timestamp dinámico (solo actualizar una vez al abrir)
        function startDynamicTimestamp() {
            isModalOpen = true;
            updateTimestamp();
        }

        // Función para detener el timestamp dinámico
        function stopDynamicTimestamp() {
            isModalOpen = false;
        }

        // Función para abrir modal del elevador
        function openElevatorModal(elevator) {
            document.getElementById('elevator-title').textContent = elevator.name;
            startDynamicTimestamp();
            document.getElementById('elevator-modal').style.display = 'flex';
        }

        // Función para cerrar modal del elevador
        function closeElevatorModal() {
            stopDynamicTimestamp();
            document.getElementById('elevator-modal').style.display = 'none';
        }

        // Función para filtrar elevadores
        function filterElevators(searchTerm) {
            const filteredElevators = elevatorData.filter(elevator => 
                elevator.name.toLowerCase().includes(searchTerm) ||
                elevator.location.toLowerCase().includes(searchTerm) ||
                elevator.status.toLowerCase().includes(searchTerm)
            );
            
            // Si hay búsqueda, cambiar a Units y mostrar resultados
            if (searchTerm.length > 0) {
                showScreen('units-screen');
                loadUnitsData(filteredElevators);
            } else {
                // Si no hay búsqueda, volver al dashboard
                showScreen('dashboard-screen');
                loadDashboardData();
            }
        }

        // Variable para evitar múltiples cargas simultáneas del dashboard
        let isLoadingDashboard = false;

        // Función para cargar datos del dashboard
        async function loadDashboardData(currentUser = null) {
            // Evitar múltiples cargas simultáneas
            if (isLoadingDashboard) {
                console.log('loadDashboardData ya está ejecutándose, omitiendo...');
                return Promise.resolve();
            }
            
            isLoadingDashboard = true;
            const container = document.getElementById('dashboard-listings');
            if (!container) {
                isLoadingDashboard = false;
                return;
            }
            
            // Mostrar indicador de carga
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">Cargando dispositivos...</div>';
            
            try {
                console.log('=== CARGANDO DATOS DEL DASHBOARD ===');
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                console.log('Respuesta de la API recibida:', response);
                
                const data = await response.json();
                console.log('Datos JSON parseados:', data);
                
                if (data.success && data.data) {
                    console.log('Datos válidos encontrados, cantidad:', data.data.length);
                    
                    // Filtrar por usuario si está especificado
                    let filteredData = data.data;
                    if (currentUser && currentUser.email) {
                        console.log('=== FILTRANDO DASHBOARD POR USUARIO ===');
                        console.log('Email del usuario:', currentUser.email);
                        console.log('Role del usuario:', currentUser.role);
                        
                        if (currentUser.role === 'Admin' || currentUser.role === 'Technician') {
                            console.log(`Usuario ${currentUser.role} - Mostrando todos los dispositivos en dashboard`);
                            filteredData = data.data;
                        } else {
                            console.log('Usuario Client - Filtrando dashboard por email del cliente');
                            filteredData = data.data.filter(device => {
                                const deviceEmail = device.clientEmail ? String(device.clientEmail).toLowerCase() : '';
                                const userEmail = currentUser.email.toLowerCase();
                                
                                // Extraer la parte del correo antes del guión (si existe)
                                const deviceEmailBase = deviceEmail.split('-')[0];
                                const userEmailBase = userEmail.split('-')[0];
                                
                                const matches = deviceEmailBase === userEmailBase;
                                console.log(`Dashboard - Dispositivo ${device.deviceId}: ${deviceEmail} (base: ${deviceEmailBase}) === ${userEmail} (base: ${userEmailBase}) = ${matches}`);
                                return matches;
                            });
                            console.log(`Dispositivos filtrados para dashboard: ${filteredData.length}`);
                        }
                    }
                    
                    // Limpiar contenedor
            container.innerHTML = '';
            
                    // Filtrar dispositivos válidos
                    const validDevices = filteredData.filter(device => 
                        device.deviceId && 
                        device.deviceId !== "Sin ID" && 
                        String(device.deviceId).trim() !== ""
                    );
                    
                    // Procesar dispositivos sin verificación de Firebase
                    const devicesWithStatus = validDevices.map(device => ({
                        ...device,
                        firebaseConnected: false
                    }));
                    
                    console.log(`Procesando ${devicesWithStatus.length} dispositivos para Dashboard dinámico`);
                    
                    // Lógica dinámica para seleccionar tarjeta del Dashboard
                    let selectedDevice = null;
                    
                    try {
                        // Obtener datos de la API para verificar alarmas
                        const apiData = await getApiDataWithCache();
                        
                        if (apiData && apiData.success && apiData.data && Array.isArray(apiData.data)) {
                            console.log('=== VERIFICANDO ALARMAS PARA DASHBOARD DINÁMICO ===');
                            
                            // Buscar dispositivos con alarmas activas
                            const devicesWithAlarms = [];
                            const devicesWithoutAlarms = [];
                            
                            devicesWithStatus.forEach(device => {
                                const deviceData = apiData.data.find(d => d.device_id === device.deviceId);
                                
                                if (deviceData) {
                                    const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                                                   deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
                                    
                                    if (hasAlarm) {
                                        devicesWithAlarms.push(device);
                                        console.log(`🔥 Dispositivo con alarma: ${device.deviceId}`);
                                    } else {
                                        devicesWithoutAlarms.push(device);
                                    }
                                } else {
                                    devicesWithoutAlarms.push(device);
                                }
                            });
                            
                            // Seleccionar dispositivo según prioridad
                            if (devicesWithAlarms.length > 0) {
                                // Prioridad 1: Dispositivo con alarma (tomar el primero)
                                selectedDevice = devicesWithAlarms[0];
                                console.log(`✅ Dashboard: Mostrando dispositivo con ALARMA - ${selectedDevice.deviceId}`);
                            } else if (devicesWithoutAlarms.length > 0) {
                                // Prioridad 2: Dispositivo al azar sin alarma
                                const randomIndex = Math.floor(Math.random() * devicesWithoutAlarms.length);
                                selectedDevice = devicesWithoutAlarms[randomIndex];
                                console.log(`✅ Dashboard: Mostrando dispositivo al AZAR - ${selectedDevice.deviceId}`);
                            }
                        }
                    } catch (error) {
                        console.error('Error verificando alarmas para Dashboard:', error);
                        // Fallback: tomar el primer dispositivo
                        if (devicesWithStatus.length > 0) {
                            selectedDevice = devicesWithStatus[0];
                            console.log(`⚠️ Dashboard: Fallback al primer dispositivo - ${selectedDevice.deviceId}`);
                        }
                    }
                    
                    // Mostrar el dispositivo seleccionado
                    if (selectedDevice) {
                        console.log(`Dashboard - Creando tarjeta dinámica para: ${selectedDevice.deviceId}`);
                        
                        const card = await createDeviceElevatorCard(selectedDevice, 0);
                        if (card) {
                            container.appendChild(card);
                            console.log(`Dashboard - Tarjeta dinámica agregada al contenedor`);
                            
                            // Pequeño delay para asegurar que la tarjeta se renderice completamente
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } else {
                            console.log(`Dashboard - Error creando tarjeta dinámica`);
                        }
                    } else {
                        console.log(`Dashboard - No hay dispositivos disponibles para mostrar`);
                    }
                    
                    console.log('Dashboard - Carga de tarjeta dinámica completada, continuando con otras secciones...');
                    
                    // Si no hay dispositivos válidos, mostrar mensaje específico
                    if (validDevices.length === 0) {
                        if (currentUser && currentUser.role === 'Client') {
                            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;"><h3>No tienes dispositivos asignados</h3><p>Contacta al administrador para obtener acceso a tus elevadores.</p></div>';
                        } else {
                            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No hay dispositivos registrados</div>';
                        }
                    }
                } else {
                    console.error('Error en la respuesta de la API:', data);
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar dispositivos</div>';
                }
            } catch (error) {
                console.error('Error al cargar datos del dashboard:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al conectar con el servidor</div>';
            } finally {
                // Liberar la bandera de carga
                isLoadingDashboard = false;
            }
        }


        // Variable para evitar múltiples cargas simultáneas
        let isLoadingUnits = false;

        // Función para cargar datos de unidades
        async function loadUnitsData(elevatorsToShow = null, currentUser = null) {
            // Evitar múltiples cargas simultáneas
            if (isLoadingUnits) {
                console.log('loadUnitsData ya está ejecutándose, omitiendo...');
                return Promise.resolve();
            }
            
            isLoadingUnits = true;
            console.log('=== INICIANDO loadUnitsData ===');
            
            // Limpiar datos corruptos al inicio
            allDevicesData = [];
            
            const container = document.getElementById('units-grid');
            console.log('Container encontrado:', container);
            
            if (!container) {
                console.error('No se encontró el contenedor units-grid');
                isLoadingUnits = false;
                return;
            }
            
            // Si se proporcionan elevadores específicos (para filtros), usar esos
            if (elevatorsToShow) {
                console.log('Usando elevadores específicos proporcionados');
                container.innerHTML = '';
                elevatorsToShow.forEach(elevator => {
                const card = createElevatorCard(elevator);
                container.appendChild(card);
            });
                isLoadingUnits = false; // Liberar la bandera
                return;
            }
            
            // Mostrar indicador de carga
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">Cargando dispositivos...</div>';
            console.log('Indicador de carga mostrado');
            
            try {
                console.log('=== CARGANDO DATOS DE UNIDADES ===');
                console.log('URL de la API:', 'https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                console.log('Respuesta de la API recibida:', response);
                console.log('Status:', response.status);
                console.log('OK:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos JSON parseados:', data);
                console.log('Tipo de datos:', typeof data);
                console.log('¿Tiene success?', 'success' in data);
                console.log('¿Tiene data?', 'data' in data);
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    console.log('Datos válidos encontrados, cantidad:', data.data.length);
                    
                    // Filtrar por usuario si está especificado
                    let filteredData = data.data;
                    if (currentUser && currentUser.email) {
                        console.log('=== FILTRANDO POR USUARIO ===');
                        console.log('Email del usuario:', currentUser.email);
                        console.log('Role del usuario:', currentUser.role);
                        
                        if (currentUser.role === 'Admin' || currentUser.role === 'Technician') {
                            console.log(`Usuario ${currentUser.role} - Mostrando todos los dispositivos`);
                            filteredData = data.data;
                        } else {
                            console.log('Usuario Client - Filtrando por email del cliente');
                            filteredData = data.data.filter(device => {
                                const deviceEmail = device.clientEmail ? String(device.clientEmail).toLowerCase() : '';
                                const userEmail = currentUser.email.toLowerCase();
                                
                                // Extraer la parte del correo antes del guión (si existe)
                                const deviceEmailBase = deviceEmail.split('-')[0];
                                const userEmailBase = userEmail.split('-')[0];
                                
                                const matches = deviceEmailBase === userEmailBase;
                                console.log(`Dispositivo ${device.deviceId}: ${deviceEmail} (base: ${deviceEmailBase}) === ${userEmail} (base: ${userEmailBase}) = ${matches}`);
                                return matches;
                            });
                            console.log(`Dispositivos filtrados para el usuario: ${filteredData.length}`);
                        }
                    }
                    
                    // Limpiar y validar datos antes de guardar
                    allDevicesData = filteredData.filter(device => {
                        return device && 
                               device.deviceId && 
                               device.deviceId !== "Sin ID" && 
                               String(device.deviceId).trim() !== "" &&
                               device.buildingName &&
                               device.unitElevator &&
                               !device.deviceId.includes('console.log') &&
                               !device.deviceId.includes('elevator_control_app.html');
                    });
                    console.log('Datos limpios guardados en allDevicesData para búsqueda');
                    
                    // Limpiar contenedor
                    container.innerHTML = '';
                    console.log('Contenedor limpiado');
                    
                    // Filtrar dispositivos válidos (usar filteredData en lugar de data.data)
                    const validDevices = filteredData.filter(device => {
                        const isValid = device.deviceId && 
                                      device.deviceId !== "Sin ID" && 
                                      String(device.deviceId).trim() !== "";
                        console.log(`Dispositivo ${device.deviceId} es válido:`, isValid);
                        return isValid;
                    });
                    
                    console.log(`Mostrando ${validDevices.length} dispositivos en la sección Units`);
                    
                    // Procesar dispositivos sin verificación de Firebase
                    const devicesWithStatus = validDevices.map(device => ({
                        ...device,
                        firebaseConnected: false
                    }));

                    // Mostrar todos los dispositivos válidos
                    for (let index = 0; index < devicesWithStatus.length; index++) {
                        const device = devicesWithStatus[index];
                        console.log(`Creando tarjeta para dispositivo ${index + 1}:`, device);
                        const card = await createDeviceElevatorCard(device, index);
                        if (card) {
                            container.appendChild(card);
                            console.log(`Tarjeta ${index + 1} agregada al contenedor`);
                        } else {
                            console.log(`Tarjeta ${index + 1} omitida por datos corruptos`);
                        }
                    }
                    
                    // Si no hay dispositivos válidos, mostrar mensaje específico
                    if (validDevices.length === 0) {
                        console.log('No hay dispositivos válidos, mostrando mensaje');
                        if (currentUser && currentUser.role === 'Client') {
                            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;"><h3>No tienes dispositivos asignados</h3><p>Contacta al administrador para obtener acceso a tus elevadores.</p></div>';
                        } else {
                            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No hay dispositivos registrados</div>';
                        }
                    }
                    
                    console.log('=== loadUnitsData COMPLETADO EXITOSAMENTE ===');
                } else {
                    console.error('Error en la respuesta de la API:', data);
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar dispositivos</div>';
                }
            } catch (error) {
                console.error('Error al cargar datos de unidades:', error);
                console.error('Tipo de error:', error.name);
                console.error('Mensaje de error:', error.message);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al conectar con el servidor</div>';
            } finally {
                // Liberar la bandera de carga
                isLoadingUnits = false;
            }
        }

        // Función para cargar datos de servicio
        function loadServiceData() {
            // Esta función ya no se usa, el contenido se maneja con el formulario
        }

        // Función para enviar reporte de servicio por email
        async function sendServiceReportByEmail(serviceEntry) {
            console.log('=== ENVIANDO REPORTE DE SERVICIO POR EMAIL ===');
            console.log('Datos del reporte:', serviceEntry);
            
            try {
                // Crear formulario para enviar por email
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://script.google.com/macros/s/AKfycbzi3b979z6iM93hIGavhnSeX2LPSzc6CIhZrngZT2K2Nriw5tBUZuIjjRNYNw3P3wynAg/exec';
                form.target = 'hiddenIframe';
                form.style.display = 'none';
                
                console.log('Email de destino:', SERVICE_REPORT_EMAIL);
                
                // Agregar campos del formulario
                const fields = {
                    action: 'send_service_report',
                    toEmail: SERVICE_REPORT_EMAIL,
                    deviceId: serviceEntry.deviceId,
                    deviceName: serviceEntry.device,
                    serviceType: serviceEntry.type,
                    serviceNotes: serviceEntry.notes,
                    serviceDate: serviceEntry.date,
                    reportId: serviceEntry.id
                };
                
                Object.keys(fields).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    form.appendChild(input);
                });
                
                // Agregar formulario al DOM y enviarlo
                document.body.appendChild(form);
                form.submit();
                
                // Limpiar formulario después del envío
                setTimeout(() => {
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                }, 1000);
                
                console.log('Reporte enviado por email exitosamente');
                return { success: true, message: 'Service report sent by email successfully!' };
                
            } catch (error) {
                console.error('Error al enviar reporte por email:', error);
                return { success: false, message: 'Error sending service report by email' };
            }
        }

        // Función para cargar dispositivos en el select de reportes
        async function loadReportDevices() {
            console.log('=== CARGANDO DISPOSITIVOS PARA REPORTES ===');
            const select = document.getElementById('reportDeviceSelect');
            if (!select) {
                console.error('No se encontró el select de dispositivos de reportes');
                return;
            }

            // Mostrar estado de carga
            select.innerHTML = '<option value="all">Loading devices...</option>';
            select.disabled = true;

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                console.log('Respuesta de la API recibida:', response);
                
                const data = await response.json();
                console.log('Datos JSON parseados:', data);
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    console.log('Datos válidos encontrados, cantidad:', data.data.length);
                    
                    // Limpiar opciones existentes
                    select.innerHTML = '';
                    
                    // Agregar opción "All Devices"
                    const allOption = document.createElement('option');
                    allOption.value = 'all';
                    allOption.textContent = 'All Devices';
                    allOption.selected = true;
                    select.appendChild(allOption);
                    
                    // Filtrar dispositivos válidos
                    const validDevices = data.data.filter(device => {
                        const isValid = device.deviceId && 
                                      device.deviceId !== "Sin ID" && 
                                      String(device.deviceId).trim() !== "";
                        return isValid;
                    });
                    
                    console.log(`Cargando ${validDevices.length} dispositivos válidos en el select de reportes`);
                    
                    if (validDevices.length === 0) {
                        // No hay dispositivos válidos
                        const noDevicesOption = document.createElement('option');
                        noDevicesOption.value = '';
                        noDevicesOption.textContent = 'No devices available';
                        noDevicesOption.disabled = true;
                        select.appendChild(noDevicesOption);
                        console.log('No hay dispositivos válidos disponibles');
                    } else {
                        // Agregar dispositivos válidos
                        validDevices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.deviceId;
                            option.textContent = `${device.buildingName} - ${device.unitElevator} (${device.deviceId})`;
                            select.appendChild(option);
                            console.log(`Dispositivo agregado al select de reportes: ${device.deviceId}`);
                        });
                    }
                    
                    // Habilitar el select
                    select.disabled = false;
                    console.log('=== DISPOSITIVOS CARGADOS EN SELECT DE REPORTES ===');
                } else {
                    console.error('Error en la respuesta de la API:', data);
                    select.innerHTML = '<option value="all">Error loading devices</option>';
                    select.disabled = false;
                }
            } catch (error) {
                console.error('Error al cargar dispositivos para reportes:', error);
                select.innerHTML = '<option value="all">Error connecting to server</option>';
                select.disabled = false;
            }
        }

        // Función para cargar edificios desde la API de dispositivos
        async function loadBuildingsFromAPI() {
            console.log('=== CARGANDO EDIFICIOS DESDE API ===');
            const select = document.getElementById('allowedBuildings');
            if (!select) {
                console.error('No se encontró el select de edificios');
                return;
            }
            
            select.innerHTML = '<option value="">Loading buildings...</option>';
            select.disabled = true;
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                console.log('Respuesta de la API recibida:', response);
                const data = await response.json();
                console.log('Datos JSON parseados:', data);
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    console.log('Datos válidos encontrados, cantidad:', data.data.length);
                    
                    select.innerHTML = '';
                    
                    // Extraer edificios únicos de los dispositivos
                    const buildings = [...new Set(data.data
                        .filter(device => device.buildingName && device.buildingName.trim() !== '')
                        .map(device => device.buildingName.trim())
                    )];
                    
                    console.log(`Encontrados ${buildings.length} edificios únicos:`, buildings);
                    
                    if (buildings.length === 0) {
                        const noBuildingsOption = document.createElement('option');
                        noBuildingsOption.value = '';
                        noBuildingsOption.textContent = 'No buildings available';
                        noBuildingsOption.disabled = true;
                        select.appendChild(noBuildingsOption);
                        console.log('No hay edificios disponibles');
                    } else {
                        buildings.forEach(building => {
                            const option = document.createElement('option');
                            option.value = building;
                            option.textContent = building;
                            select.appendChild(option);
                            console.log(`Edificio agregado al select: ${building}`);
                        });
                    }
                    
                    select.disabled = false;
                    console.log('=== EDIFICIOS CARGADOS EN SELECT ===');
                } else {
                    console.error('Error en la respuesta de la API:', data);
                    select.innerHTML = '<option value="">Error loading buildings</option>';
                    select.disabled = false;
                }
            } catch (error) {
                console.error('Error al cargar edificios:', error);
                select.innerHTML = '<option value="">Error connecting to server</option>';
                select.disabled = false;
            }
        }

        // Función para cargar dispositivos en el select de servicio
        async function loadServiceDevices() {
            console.log('=== CARGANDO DISPOSITIVOS PARA SERVICIO ===');
            
            // Obtener usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            console.log('Usuario actual para Service:', currentUser);
            
            const select = document.getElementById('serviceDeviceSelect');
            if (!select) {
                console.error('No se encontró el select de dispositivos de servicio');
                return;
            }

            // Mostrar estado de carga
            select.innerHTML = '<option value="">Loading devices...</option>';
            select.disabled = true;

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                console.log('Respuesta de la API recibida:', response);
                
                const data = await response.json();
                console.log('Datos JSON parseados:', data);
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    console.log('Datos válidos encontrados, cantidad:', data.data.length);
                    
                    // Filtrar por usuario si está especificado
                    let filteredData = data.data;
                    if (currentUser && currentUser.email) {
                        console.log('=== FILTRANDO SERVICE POR USUARIO ===');
                        console.log('Email del usuario:', currentUser.email);
                        console.log('Role del usuario:', currentUser.role);
                        
                        if (currentUser.role === 'Admin' || currentUser.role === 'Technician') {
                            console.log(`Usuario ${currentUser.role} - Mostrando todos los dispositivos en Service`);
                            filteredData = data.data;
                        } else {
                            console.log('Usuario Client - Filtrando Service por email del cliente');
                            filteredData = data.data.filter(device => {
                                const deviceEmail = device.clientEmail ? String(device.clientEmail).toLowerCase() : '';
                                const userEmail = currentUser.email.toLowerCase();
                                
                                // Extraer la parte del correo antes del guión (si existe)
                                const deviceEmailBase = deviceEmail.split('-')[0];
                                const userEmailBase = userEmail.split('-')[0];
                                
                                const matches = deviceEmailBase === userEmailBase;
                                console.log(`Service - Dispositivo ${device.deviceId}: ${deviceEmail} (base: ${deviceEmailBase}) === ${userEmail} (base: ${userEmailBase}) = ${matches}`);
                                return matches;
                            });
                            console.log(`Dispositivos filtrados para Service: ${filteredData.length}`);
                        }
                    }
                    
                    // Limpiar opciones existentes
                    select.innerHTML = '';
                    
                    // Filtrar dispositivos válidos (usar filteredData)
                    const validDevices = filteredData.filter(device => {
                        const isValid = device.deviceId && 
                                      device.deviceId !== "Sin ID" && 
                                      String(device.deviceId).trim() !== "";
                        return isValid;
                    });
                    
                    console.log(`Cargando ${validDevices.length} dispositivos válidos en el select`);
                    
                    if (validDevices.length === 0) {
                        // No hay dispositivos válidos
                        const noDevicesOption = document.createElement('option');
                        noDevicesOption.value = '';
                        if (currentUser && currentUser.role === 'Client') {
                            noDevicesOption.textContent = 'No tienes dispositivos asignados';
                        } else {
                            noDevicesOption.textContent = 'No devices available';
                        }
                        noDevicesOption.disabled = true;
                        select.appendChild(noDevicesOption);
                        console.log('No hay dispositivos válidos disponibles');
                    } else {
                        // Agregar opción por defecto
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Select a device...';
                        defaultOption.disabled = true;
                        defaultOption.selected = true;
                        select.appendChild(defaultOption);
                        
                        // Agregar dispositivos válidos
                        validDevices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.deviceId;
                            option.textContent = `${device.buildingName} - ${device.unitElevator} (${device.deviceId})`;
                            select.appendChild(option);
                            console.log(`Dispositivo agregado al select: ${device.deviceId}`);
                        });
                    }
                    
                    // Habilitar el select
                    select.disabled = false;
                    console.log('=== DISPOSITIVOS CARGADOS EN SELECT ===');
                } else {
                    console.error('Error en la respuesta de la API:', data);
                    select.innerHTML = '<option value="">Error loading devices</option>';
                    select.disabled = false;
                }
            } catch (error) {
                console.error('Error al cargar dispositivos para servicio:', error);
                select.innerHTML = '<option value="">Error connecting to server</option>';
                select.disabled = false;
            }
        }

        // Variable global para almacenar todos los dispositivos
        let allDevicesData = [];
        
        // Cache de datos de la API para mejorar rendimiento
        let apiDataCache = null;
        let cacheTimestamp = null;
        const CACHE_DURATION = 30000; // 30 segundos de cache
        
        // Variables para actualización automática
        let autoUpdateInterval = null;
        const AUTO_UPDATE_DELAY = 30000; // 30 segundos antes de comenzar
        const AUTO_UPDATE_INTERVAL = 20000; // 20 segundos entre actualizaciones
        
        // Configuración de email de destino para reportes de servicio
        const SERVICE_REPORT_EMAIL = 'bermudaelevadores@gmail.com'; // Cambia aquí el email de destino

        // Función para obtener datos de la API con cache
        async function getApiDataWithCache() {
            const now = Date.now();
            
            // Verificar si tenemos cache válido
            if (apiDataCache && cacheTimestamp && (now - cacheTimestamp) < CACHE_DURATION) {
                console.log('Usando datos del cache');
                return apiDataCache;
            }
            
            // Verificar localStorage
            const cachedData = localStorage.getItem('elevatorApiData');
            const cachedTimestamp = localStorage.getItem('elevatorApiTimestamp');
            
            if (cachedData && cachedTimestamp && (now - parseInt(cachedTimestamp)) < CACHE_DURATION) {
                console.log('Usando datos del localStorage');
                apiDataCache = JSON.parse(cachedData);
                cacheTimestamp = parseInt(cachedTimestamp);
                return apiDataCache;
            }
            
            try {
                console.log('Obteniendo datos frescos de la API');
                const response = await fetch('https://script.google.com/macros/s/AKfycbyyoDNlKjoSYVX4fUg8nrYCGkidCt9RIz6mswQcq73oxmb0xkGwkE14Du5XOyP7rzlQ/exec');
                const data = await response.json();
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    // Guardar en cache en memoria
                    apiDataCache = data;
                    cacheTimestamp = now;
                    
                    // Guardar en localStorage
                    localStorage.setItem('elevatorApiData', JSON.stringify(data));
                    localStorage.setItem('elevatorApiTimestamp', now.toString());
                    
                    console.log('Datos guardados en cache y localStorage');
                    return data;
                } else {
                    console.error('Error en la respuesta de la API:', data);
                    return null;
                }
            } catch (error) {
                console.error('Error obteniendo datos de la API:', error);
                return null;
            }
        }
        
        // Función para limpiar el cache
        function clearApiCache() {
            apiDataCache = null;
            cacheTimestamp = null;
            localStorage.removeItem('elevatorApiData');
            localStorage.removeItem('elevatorApiTimestamp');
            console.log('Cache limpiado');
        }
        
        // Función para forzar actualización de datos
        async function forceRefreshApiData() {
            clearApiCache();
            return await getApiDataWithCache();
        }
        
        // Función para actualizar solo las tarjetas de Units
        async function refreshUnitsOnly() {
            console.log('=== ACTUALIZANDO SOLO TARJETAS DE UNITS ===');
            
            const button = document.getElementById('refresh-units-btn');
            const svg = button.querySelector('svg');
            
            try {
                // Agregar animación de rotación al SVG
                svg.style.animation = 'spin 1s linear infinite';
                button.disabled = true;
                
                // Limpiar cache para obtener datos frescos
                clearApiCache();
                
                // Obtener usuario actual
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                // Recargar solo Units
                await loadUnitsData(null, currentUser);
                
                console.log('=== UNITS ACTUALIZADO EXITOSAMENTE ===');
                
            } catch (error) {
                console.error('Error actualizando Units:', error);
            } finally {
                // Restaurar botón
                svg.style.animation = '';
                button.disabled = false;
            }
        }
        
        // Función para actualizar solo la información de las tarjetas existentes
        async function updateExistingCards() {
            console.log('=== ACTUALIZANDO INFORMACIÓN DE TARJETAS EXISTENTES ===');
            
            try {
                // Obtener datos frescos de la API
                const data = await getApiDataWithCache();
                
                if (data && data.success && data.data && Array.isArray(data.data)) {
                    console.log('Datos de la API obtenidos:', data.data.length, 'dispositivos');
                    
                    // Actualizar tarjetas del Dashboard
                    const dashboardContainer = document.getElementById('dashboard-listings');
                    if (dashboardContainer) {
                        const dashboardCards = dashboardContainer.querySelectorAll('.item-card');
                        console.log(`Dashboard: Encontradas ${dashboardCards.length} tarjetas`);
                        
                        dashboardCards.forEach((card, index) => {
                            const deviceId = card.getAttribute('data-device-id');
                            console.log(`Dashboard tarjeta ${index + 1}: deviceId = ${deviceId}`);
                            
                            if (deviceId) {
                                const deviceData = data.data.find(d => d.device_id === deviceId);
                                if (deviceData) {
                                    console.log(`Dashboard: Actualizando tarjeta ${deviceId}`);
                                    updateCardStatus(card, deviceData);
                                } else {
                                    console.log(`Dashboard: No se encontraron datos para ${deviceId}`);
                                }
                            } else {
                                console.log(`Dashboard: Tarjeta ${index + 1} sin data-device-id`);
                            }
                        });
                    }
                    
                    // Actualizar tarjetas de Units
                    const unitsContainer = document.getElementById('units-grid');
                    if (unitsContainer) {
                        const unitsCards = unitsContainer.querySelectorAll('.item-card');
                        console.log(`Units: Encontradas ${unitsCards.length} tarjetas`);
                        
                        unitsCards.forEach((card, index) => {
                            const deviceId = card.getAttribute('data-device-id');
                            console.log(`Units tarjeta ${index + 1}: deviceId = ${deviceId}`);
                            
                            if (deviceId) {
                                const deviceData = data.data.find(d => d.device_id === deviceId);
                                if (deviceData) {
                                    console.log(`Units: Actualizando tarjeta ${deviceId}`);
                                    updateCardStatus(card, deviceData);
                                } else {
                                    console.log(`Units: No se encontraron datos para ${deviceId}`);
                                }
                            } else {
                                console.log(`Units: Tarjeta ${index + 1} sin data-device-id`);
                            }
                        });
                    } else {
                        console.log('❌ NO SE ENCONTRÓ EL CONTENEDOR units-grid');
                    }
                    
                    console.log('=== TARJETAS ACTUALIZADAS EXITOSAMENTE ===');
                    
                    // Actualizar timestamp si el modal está abierto
                    updateTimestamp();
                }
            } catch (error) {
                console.error('Error actualizando tarjetas existentes:', error);
            }
        }
        
        // Función para actualizar el estado de una tarjeta específica
        function updateCardStatus(card, deviceData) {
            // Verificar si hay alarmas activas
            const hasAlarm = deviceData.OUT_OF_SERVICE || deviceData.FIRE_SERVICE || 
                           deviceData.PHONE_COMM || deviceData.PIT_FLOODED;
            
            console.log(`Actualizando tarjeta ${deviceData.device_id}:`, {
                OUT_OF_SERVICE: deviceData.OUT_OF_SERVICE,
                FIRE_SERVICE: deviceData.FIRE_SERVICE,
                PHONE_COMM: deviceData.PHONE_COMM,
                PIT_FLOODED: deviceData.PIT_FLOODED,
                hasAlarm: hasAlarm
            });
            
            let status = 'operational';
            let statusClass = 'operational';
            let progressColor = '#27ae60';
            
            if (hasAlarm) {
                status = 'ALARM';
                statusClass = 'alarm';
                progressColor = '#e74c3c';
                console.log(`🔥 ALARMA DETECTADA para ${deviceData.device_id} - Cambiando a estado ALARM`);
            }
            
            // Buscar elementos con selectores más específicos
            const statusBadge = card.querySelector('.item-meta .status-badge') ||
                              card.querySelector('.status-badge') ||
                              card.querySelector('[class*="status-badge"]');
            
            const progressFill = card.querySelector('.progress-bar .progress-fill') ||
                               card.querySelector('.progress-fill') ||
                               card.querySelector('[class*="progress-fill"]');
            
            console.log(`Elementos encontrados:`, {
                statusBadge: !!statusBadge,
                progressFill: !!progressFill,
                cardHTML: card.outerHTML.substring(0, 200) + '...'
            });
            
            if (statusBadge) {
                const oldText = statusBadge.textContent;
                const oldClass = statusBadge.className;
                
                statusBadge.textContent = status;
                statusBadge.className = `status-badge ${statusClass}`;
                
                console.log(`Estado actualizado: "${oldText}" → "${status}"`);
                console.log(`Clase actualizada: "${oldClass}" → "status-badge ${statusClass}"`);
            } else {
                console.error('❌ NO SE ENCONTRÓ .status-badge en la tarjeta');
                console.log('Intentando búsqueda alternativa...');
                
                // Búsqueda alternativa más agresiva
                const allSpans = card.querySelectorAll('span');
                const statusSpan = Array.from(allSpans).find(span => 
                    span.textContent === 'operational' || 
                    span.textContent === 'ALARM' ||
                    span.className.includes('status-badge')
                );
                
                if (statusSpan) {
                    console.log('✅ Encontrado con búsqueda alternativa:', statusSpan);
                    statusSpan.textContent = status;
                    statusSpan.className = `status-badge ${statusClass}`;
                    console.log(`Estado actualizado alternativo: "${status}"`);
                } else {
                    console.error('❌ Tampoco se encontró con búsqueda alternativa');
                }
            }
            
            if (progressFill) {
                const oldColor = progressFill.style.backgroundColor;
                progressFill.style.backgroundColor = progressColor;
                
                console.log(`Color actualizado: "${oldColor}" → "${progressColor}"`);
            } else {
                console.error('❌ NO SE ENCONTRÓ .progress-fill en la tarjeta');
                console.log('Intentando búsqueda alternativa...');
                
                // Búsqueda alternativa para progress-fill
                const allDivs = card.querySelectorAll('div');
                const progressDiv = Array.from(allDivs).find(div => 
                    div.className.includes('progress-fill') ||
                    div.style.backgroundColor === 'rgb(39, 174, 96)' ||
                    div.style.backgroundColor === 'rgb(231, 76, 60)'
                );
                
                if (progressDiv) {
                    console.log('✅ Encontrado progress-fill con búsqueda alternativa:', progressDiv);
                    progressDiv.style.backgroundColor = progressColor;
                    console.log(`Color actualizado alternativo: "${progressColor}"`);
                } else {
                    console.error('❌ Tampoco se encontró progress-fill con búsqueda alternativa');
                }
            }
        }
        
        // Función para iniciar actualización automática
        function startAutoUpdate() {
            console.log('=== INICIANDO ACTUALIZACIÓN AUTOMÁTICA ===');
            console.log(`Esperando ${AUTO_UPDATE_DELAY/1000} segundos antes de comenzar...`);
            
            // Limpiar intervalo existente si hay uno
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
            
            // Esperar 30 segundos antes de comenzar
            setTimeout(() => {
                console.log('=== COMENZANDO ACTUALIZACIÓN AUTOMÁTICA CADA 20 SEGUNDOS ===');
                
                // Actualizar inmediatamente
                updateExistingCards();
                
                // Configurar intervalo cada 20 segundos
                autoUpdateInterval = setInterval(() => {
                    console.log('=== ACTUALIZACIÓN AUTOMÁTICA PROGRAMADA ===');
                    updateExistingCards();
                }, AUTO_UPDATE_INTERVAL);
                
            }, AUTO_UPDATE_DELAY);
        }
        
        // Función para detener actualización automática
        function stopAutoUpdate() {
            console.log('=== DETENIENDO ACTUALIZACIÓN AUTOMÁTICA ===');
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
            }
        }

        // Función para actualizar todas las APIs
        async function refreshAllAPIs() {
            console.log('=== ACTUALIZANDO TODAS LAS APIs ===');
            
            // Limpiar cache para obtener datos frescos
            clearApiCache();
            
            // Obtener usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            const button = document.getElementById('refresh-all-btn');
            const svg = button.querySelector('svg');
            
            try {
                // Agregar animación de rotación al SVG existente
                svg.style.animation = 'spin 1s linear infinite';
                button.disabled = true;
                
                // Actualizar Dashboard
                console.log('Actualizando Dashboard...');
                await loadDashboardData(currentUser);
                
                // Actualizar Units
                console.log('Actualizando Units...');
                await loadUnitsData(null, currentUser);
                
                
                // Actualizar dispositivos si estamos en la pantalla de dispositivos
                if (document.getElementById('devices-screen').classList.contains('active')) {
                    console.log('Actualizando lista de dispositivos...');
                    await loadDevicesData();
                }
                
                // Actualizar usuarios si estamos en la pantalla de usuarios
                if (document.getElementById('users-screen').classList.contains('active')) {
                    console.log('Actualizando lista de usuarios...');
                    await loadRealUsersData();
                }
                
                console.log('=== ACTUALIZACIÓN COMPLETADA ===');
                
                // Mostrar mensaje de éxito
                const deviceMsg = document.getElementById('deviceMsg');
                if (deviceMsg) {
                    deviceMsg.textContent = 'Todas las APIs actualizadas exitosamente';
                    deviceMsg.className = 'success';
                    
                    setTimeout(() => {
                        deviceMsg.textContent = '';
                        deviceMsg.className = '';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error actualizando APIs:', error);
                
                // Mostrar mensaje de error
                const deviceMsg = document.getElementById('deviceMsg');
                if (deviceMsg) {
                    deviceMsg.textContent = 'Error actualizando algunas APIs';
                    deviceMsg.className = 'error';
                    
                    setTimeout(() => {
                        deviceMsg.textContent = '';
                        deviceMsg.className = '';
                    }, 3000);
                }
            } finally {
                // Restaurar botón (solo quitar animación y habilitar)
                svg.style.animation = '';
                button.disabled = false;
            }
        }

        // Función para cargar edificios del usuario actual desde la API
        async function loadUserBuildings() {
            try {
                console.log('=== CARGANDO EDIFICIOS DEL USUARIO ===');
                
                // Obtener usuario actual
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (!currentUser.email) {
                    console.log('No hay usuario logueado');
                    return;
                }
                
                console.log('Usuario actual:', currentUser.email);
                
                // Consultar la API para obtener todos los dispositivos
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('Datos de la API:', data.data);
                    
                    // Filtrar dispositivos por el email del usuario actual
                    const userDevices = data.data.filter(device => {
                        const deviceEmail = device.clientEmail ? device.clientEmail.toLowerCase() : '';
                        const userEmail = currentUser.email.toLowerCase();
                        
                        // Extraer la parte del correo antes del guión (si existe)
                        const deviceEmailBase = deviceEmail.split('-')[0];
                        const userEmailBase = userEmail.split('-')[0];
                        
                        const matches = deviceEmailBase === userEmailBase;
                        console.log(`Dispositivo ${device.deviceId}: ${deviceEmail} (base: ${deviceEmailBase}) === ${userEmail} (base: ${userEmailBase}) = ${matches}`);
                        return matches;
                    });
                    
                    console.log(`Dispositivos del usuario:`, userDevices);
                    
                    // Extraer edificios únicos del usuario
                    const uniqueBuildings = [...new Set(userDevices.map(device => device.buildingName))];
                    console.log('Edificios únicos del usuario:', uniqueBuildings);
                    
                    // Llenar el select con los edificios del usuario
                    const buildingSelect = document.getElementById('buildingFilter');
                    if (buildingSelect) {
                        // Limpiar opciones existentes (excepto "All Buildings")
                        buildingSelect.innerHTML = '<option value="all">All Buildings</option>';
                        
                        // Agregar edificios del usuario
                        uniqueBuildings.forEach(building => {
                            if (building && building.trim() !== '') {
                                const option = document.createElement('option');
                                option.value = building;
                                option.textContent = building;
                                buildingSelect.appendChild(option);
                            }
                        });
                        
                        console.log(`Select actualizado con ${uniqueBuildings.length} edificios del usuario`);
                    }
                } else {
                    console.error('Error al obtener datos de la API');
                }
            } catch (error) {
                console.error('Error al cargar edificios del usuario:', error);
            }
        }

        // Función para filtrar dispositivos por edificio y estado
        function filterDevicesByBuildingAndStatus(building, status) {
            console.log('=== FILTRANDO POR EDIFICIO Y ESTADO ===');
            console.log('Edificio seleccionado:', building);
            console.log('Estado seleccionado:', status);
            
            // Navegar a la sección Units
            showScreen('units-screen');
            
            const container = document.getElementById('units-grid');
            if (!container) {
                console.error('No se encontró el contenedor units-grid');
                return;
            }
            
            // Obtener usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Cargar datos y aplicar filtros
            loadUnitsData(null, currentUser).then(() => {
                // Filtrar dispositivos por edificio
                let filteredDevices = allDevicesData || [];
                
                if (building !== 'all') {
                    filteredDevices = filteredDevices.filter(device => 
                        device.buildingName && device.buildingName.toLowerCase() === building.toLowerCase()
                    );
                    console.log(`Dispositivos filtrados por edificio "${building}":`, filteredDevices.length);
                }
                
                // Filtrar por estado (si no es 'all')
                if (status !== 'all') {
                    filteredDevices = filteredDevices.filter(device => {
                        // Todos los dispositivos se consideran operacionales sin Firebase
                        const deviceStatus = 'operational';
                        
                        return deviceStatus === status;
                    });
                    console.log(`Dispositivos filtrados por estado "${status}":`, filteredDevices.length);
                }
                
                // Mostrar dispositivos filtrados
                displayFilteredDevices(filteredDevices);
            });
        }
        
        // Función para mostrar dispositivos filtrados
        function displayFilteredDevices(devices) {
            const container = document.getElementById('units-grid');
            if (!container) {
                console.error('No se encontró el contenedor units-grid');
                return;
            }
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            if (devices.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No devices found with the selected filters</div>';
                return;
            }
            
            // Mostrar dispositivos filtrados
            devices.forEach((device, index) => {
                const card = createDeviceElevatorCard(device, index);
                if (card) {
                    container.appendChild(card);
                    console.log(`Dispositivo ${index + 1} agregado al contenedor`);
                }
            });
            
            console.log(`Mostrando ${devices.length} dispositivos filtrados`);
        }

        // Función para filtrar elevadores/dispositivos
        function filterElevators(searchTerm) {
            console.log('=== FILTRANDO DISPOSITIVOS ===');
            console.log('Término de búsqueda:', searchTerm);
            
            // Navegar a la sección Units primero
            console.log('Navegando a la sección Units...');
            showScreen('units-screen');
            
            const container = document.getElementById('units-grid');
            if (!container) {
                console.error('No se encontró el contenedor units-grid');
                return;
            }

            if (!searchTerm || searchTerm.trim() === '') {
                console.log('Término de búsqueda vacío, mostrando todos los dispositivos');
                // Obtener usuario actual y mostrar todos los dispositivos
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                loadUnitsData(null, currentUser);
                return;
            }

            console.log('Filtrando dispositivos con término:', searchTerm);
            
            // Verificar si tenemos datos disponibles
            if (!allDevicesData || allDevicesData.length === 0) {
                console.log('No hay datos disponibles, cargando desde la API...');
                // Mostrar mensaje de carga
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">Cargando dispositivos para búsqueda...</div>';
                
                // Cargar datos y luego filtrar
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                loadUnitsData(null, currentUser).then(() => {
                    console.log('Datos cargados, aplicando filtro...');
                    // Después de cargar, aplicar el filtro
                    setTimeout(() => {
                        filterElevators(searchTerm);
                    }, 500);
                }).catch(error => {
                    console.error('Error al cargar datos para búsqueda:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar datos para búsqueda</div>';
                });
                return;
            }
            
            // Filtrar dispositivos que coincidan con el término de búsqueda
            const filteredDevices = allDevicesData.filter(device => {
                const deviceId = String(device.deviceId || '').toLowerCase();
                const building = String(device.buildingName || '').toLowerCase();
                const unit = String(device.unitElevator || '').toLowerCase();
                const email = String(device.clientEmail || '').toLowerCase();
                
                return deviceId.includes(searchTerm) ||
                       building.includes(searchTerm) ||
                       unit.includes(searchTerm) ||
                       email.includes(searchTerm);
            });

            console.log(`Encontrados ${filteredDevices.length} dispositivos que coinciden con "${searchTerm}"`);

            // Limpiar contenedor
            container.innerHTML = '';

            if (filteredDevices.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No se encontraron dispositivos que coincidan con la búsqueda</div>';
                return;
            }

            // Mostrar dispositivos filtrados
            filteredDevices.forEach((device, index) => {
                console.log(`Mostrando dispositivo filtrado ${index + 1}:`, device);
                const card = createDeviceElevatorCard(device, index);
                container.appendChild(card);
            });

            console.log('=== FILTRADO COMPLETADO ===');
        }


        // Función para agregar entrada de servicio
        async function addServiceEntry() {
            const deviceSelect = document.getElementById('serviceDeviceSelect');
            const serviceType = document.getElementById('serviceType');
            const serviceNotes = document.getElementById('serviceNotes');
            const serviceMsg = document.getElementById('serviceMsg');
            const serviceHistory = document.getElementById('serviceHistory');
            
            // Validar campos requeridos
            if (!deviceSelect.value || deviceSelect.value === '') {
                serviceMsg.textContent = 'Please select a device';
                serviceMsg.className = 'error';
                return;
            }
            
            if (!serviceNotes.value.trim()) {
                serviceMsg.textContent = 'Please enter service notes';
                serviceMsg.className = 'error';
                return;
            }
            
            // Crear entrada de servicio
            const serviceEntry = {
                id: Date.now(),
                device: deviceSelect.options[deviceSelect.selectedIndex].text,
                deviceId: deviceSelect.value,
                type: serviceType.value,
                notes: serviceNotes.value,
                date: new Date().toLocaleString(),
                photos: 0
            };
            
            // Agregar al historial
            addToServiceHistory(serviceEntry);
            
            // Enviar reporte por email
            console.log('Enviando reporte por email...');
            const emailResult = await sendServiceReportByEmail(serviceEntry);
            
            // Limpiar formulario
            deviceSelect.selectedIndex = 0; // Resetear al primer elemento (Select a device...)
            serviceNotes.value = '';
            
            // Mostrar mensaje de éxito
            if (emailResult.success) {
                serviceMsg.textContent = 'Service entry added and report sent by email successfully!';
            serviceMsg.className = 'success';
            } else {
                serviceMsg.textContent = 'Service entry added, but email failed to send.';
                serviceMsg.className = 'error';
            }
            
            // Limpiar mensaje después de 5 segundos
            setTimeout(() => {
                serviceMsg.textContent = '';
                serviceMsg.className = '';
            }, 5000);
        }

        // Función para agregar entrada al historial
        function addToServiceHistory(entry) {
            // Guardar en localStorage para persistencia
            const existingHistory = JSON.parse(localStorage.getItem('serviceHistory') || '[]');
            existingHistory.unshift(entry); // Agregar al inicio
            localStorage.setItem('serviceHistory', JSON.stringify(existingHistory));
            
            // Mostrar en el modal
            displayServiceHistory();
        }
        
        // Función para mostrar el historial de servicios
        function displayServiceHistory() {
            const serviceHistory = document.getElementById('serviceHistory');
            const historyData = JSON.parse(localStorage.getItem('serviceHistory') || '[]');
            
            if (historyData.length === 0) {
                serviceHistory.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No service history yet</p>';
                return;
            }
            
            serviceHistory.innerHTML = '';
            
            historyData.forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'service-history-item';
                historyItem.id = `history-item-${entry.id}`;
                historyItem.style.cssText = `
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 10px;
                    border-left: 4px solid #3498db;
                `;
                historyItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 8px 0; color: #2c3e50;">${entry.device} - ${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)}</h4>
                            <p style="margin: 4px 0; color: #6c757d;"><strong>Date:</strong> ${entry.date}</p>
                            <p style="margin: 4px 0; color: #6c757d;"><strong>Notes:</strong> ${entry.notes}</p>
                            ${entry.photos > 0 ? `<p style="margin: 4px 0; color: #6c757d;"><strong>Photos:</strong> ${entry.photos} uploaded</p>` : ''}
                        </div>
                        <button class="delete-entry-btn" onclick="deleteHistoryEntry(${entry.id})" style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-left: 10px;">
                            Delete
                        </button>
                    </div>
                `;
                
                serviceHistory.appendChild(historyItem);
            });
        }

        // Función para borrar entrada individual
        function deleteHistoryEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry from the history?')) {
                // Remover del localStorage
                const existingHistory = JSON.parse(localStorage.getItem('serviceHistory') || '[]');
                const updatedHistory = existingHistory.filter(entry => entry.id !== entryId);
                localStorage.setItem('serviceHistory', JSON.stringify(updatedHistory));
                
                // Actualizar la visualización
                displayServiceHistory();
            }
        }

        // Función para abrir modal de historial
        function openServiceHistoryModal() {
            document.getElementById('service-history-modal').style.display = 'flex';
            // Cargar y mostrar el historial
            displayServiceHistory();
        }

        // Función para cerrar modal de historial
        function closeServiceHistoryModal() {
            document.getElementById('service-history-modal').style.display = 'none';
        }

        // Función para borrar todo el historial
        function clearServiceHistory() {
            if (confirm('Are you sure you want to delete ALL service history? This action cannot be undone.')) {
                // Limpiar localStorage
                localStorage.removeItem('serviceHistory');
                
                // Actualizar la visualización
                displayServiceHistory();
                
                // Mostrar mensaje de confirmación
                const serviceHistory = document.getElementById('serviceHistory');
                const originalContent = serviceHistory.innerHTML;
                serviceHistory.innerHTML = '<p style="text-align:center;color:#27ae60;padding:20px;font-weight:600;">All service history has been deleted successfully</p>';
                
                // Restaurar mensaje original después de 2 segundos
                setTimeout(() => {
                    serviceHistory.innerHTML = originalContent;
                }, 2000);
            }
        }

        // Función para cargar datos de reportes
        function loadReportsData() {
            // Esta función ya no se usa, el contenido se maneja con el formulario
        }

        // Función para generar reporte
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const deviceSelect = document.getElementById('reportDeviceSelect');
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const reportMsg = document.getElementById('reportMsg');
            
            // Validar campos requeridos
            if (!startDate || !endDate) {
                reportMsg.textContent = 'Please select both start and end dates';
                reportMsg.className = 'error';
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                reportMsg.textContent = 'Start date must be before end date';
                reportMsg.className = 'error';
                return;
            }
            
            // Simular generación de reporte
            reportMsg.textContent = 'Generating report...';
            reportMsg.className = 'success';
            
            setTimeout(() => {
                reportMsg.textContent = `Report generated successfully! Type: ${reportType}, Device: ${deviceSelect.options[deviceSelect.selectedIndex].text}, Date Range: ${startDate} to ${endDate}`;
                reportMsg.className = 'success';
                
                // Simular descarga
                const link = document.createElement('a');
                link.href = '#';
                link.download = `report_${reportType}_${new Date().getTime()}.pdf`;
                link.click();
                
                // Limpiar mensaje después de 5 segundos
                setTimeout(() => {
                    reportMsg.textContent = '';
                    reportMsg.className = '';
                }, 5000);
            }, 2000);
        }

        // Función para cargar datos de dispositivos desde la API
        async function loadDevicesData() {
            console.log('=== CARGANDO DATOS DE DISPOSITIVOS ===');
            console.log('URL de la API:', 'https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
            
            // Mostrar indicador de carga
            const tbody = document.querySelector('#devicesTable tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">Cargando dispositivos...</td></tr>';
            }
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                console.log('Respuesta de la API recibida:', response);
                console.log('Status de la respuesta:', response.status);
                console.log('OK de la respuesta:', response.ok);
                
                const data = await response.json();
                console.log('Datos JSON parseados:', data);
                console.log('Tipo de datos:', typeof data);
                console.log('¿Tiene success?', 'success' in data);
                console.log('¿Tiene data?', 'data' in data);
                
                if (data.success && data.data) {
                    console.log('Datos válidos encontrados, cantidad:', data.data.length);
                    console.log('Primer dispositivo:', data.data[0]);
                    
                    updateDevicesTable(data.data);
                    return data.data;
                } else {
                    console.error('Error en la respuesta de la API:', data);
                    console.log('Estructura de la respuesta:', JSON.stringify(data, null, 2));
                    return [];
                }
            } catch (error) {
                console.error('Error al cargar datos de dispositivos:', error);
                console.error('Tipo de error:', error.name);
                console.error('Mensaje de error:', error.message);
                console.error('Stack trace:', error.stack);
                return [];
            }
        }

        // Función para actualizar la tabla de dispositivos
        function updateDevicesTable(devicesData) {
            console.log('=== ACTUALIZANDO TABLA DE DISPOSITIVOS ===');
            console.log('Datos recibidos:', devicesData);
            
            const tbody = document.querySelector('#devicesTable tbody');
            console.log('Elemento tbody encontrado:', tbody);
            
            if (!tbody) {
                console.error('No se encontró la tabla de dispositivos');
                return;
            }

            // Mostrar indicador de carga
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">Cargando dispositivos...</td></tr>';
            console.log('Indicador de carga mostrado');

            // Simular un pequeño delay para mostrar el indicador de carga
            setTimeout(() => {
                console.log('Iniciando actualización de tabla...');
                
                // Limpiar tabla existente
                tbody.innerHTML = '';
                console.log('Tabla limpiada');

                if (!devicesData || devicesData.length === 0) {
                    console.log('No hay datos de dispositivos, mostrando mensaje');
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">No hay dispositivos registrados</td></tr>';
                    return;
                }
                
                // Filtrar dispositivos que no sean "Sin ID" o datos vacíos
                const validDevices = devicesData.filter(device => 
                    device.deviceId && 
                    device.deviceId !== "Sin ID" && 
                    String(device.deviceId).trim() !== ""
                );
                
                if (validDevices.length === 0) {
                    console.log('No hay dispositivos válidos, mostrando mensaje');
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">No hay dispositivos válidos registrados</td></tr>';
                    return;
                }
                
                console.log(`Procesando ${validDevices.length} dispositivos válidos de ${devicesData.length} total`);

                // Agregar cada dispositivo válido
                validDevices.forEach((device, index) => {
                    console.log(`Procesando dispositivo ${index + 1}:`, device);
                    
                    const row = document.createElement('tr');
                    row.setAttribute('data-device-id', device.deviceId);
                    row.setAttribute('data-building', device.buildingName);
                    row.setAttribute('data-unit', device.unitElevator);
                    row.setAttribute('data-email', device.clientEmail || '');
                    
                    row.innerHTML = `
                        <td style="padding:5px;"><strong style="font-size:0.85rem;">${device.deviceId}</strong></td>
                        <td style="padding:5px;font-size:0.8rem;">${device.buildingName}</td>
                        <td style="padding:5px;font-size:0.8rem;">${device.unitElevator}</td>
                        <td style="white-space:nowrap;padding:5px;">
                            <button class="edit-email" data-id="${device.deviceId}" style="background:#2980b9;color:white;border:none;padding:5px 10px;font-size:0.75rem;margin-right:5px;border-radius:4px;cursor:pointer;font-weight:500;">Edit</button>
                            <button class="del btn-delete" data-id="${device.deviceId}" onclick="deleteDevice('${device.deviceId}')" style="padding:5px 10px;font-size:0.75rem;">Delete</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                    console.log(`Dispositivo ${index + 1} agregado a la tabla`);
                });

                console.log(`Tabla actualizada con ${validDevices.length} dispositivos válidos`);
                console.log('=== FIN DE ACTUALIZACIÓN DE TABLA ===');
            }, 500);
        }

        // Función para agregar dispositivo
        async function addDevice() {
            const deviceId = document.getElementById('newId').value.trim();
            const building = document.getElementById('newBld').value.trim();
            const unit = document.getElementById('newUnit').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const deviceMsg = document.getElementById('deviceMsg');
            
            console.log('=== AGREGANDO DISPOSITIVO ===');
            console.log('Device ID:', deviceId);
            console.log('Building:', building);
            console.log('Unit:', unit);
            console.log('Email:', email);
            console.log('Tipo de deviceId:', typeof deviceId);
            console.log('Longitud de deviceId:', deviceId.length);
            
            // Validar campos requeridos
            if (!deviceId || !building || !unit) {
                deviceMsg.textContent = 'Please fill in all required fields';
                deviceMsg.className = 'error';
                return;
            }
            
            // Obtener el formulario de agregar dispositivo
            const addForm = document.getElementById('addDeviceForm');
            const deviceIdInput = document.getElementById('addDeviceId');
            const buildingInput = document.getElementById('addDeviceBuilding');
            const unitInput = document.getElementById('addDeviceUnit');
            const emailInput = document.getElementById('addDeviceEmail');
            
            console.log('Formulario encontrado:', addForm);
            console.log('URL del formulario:', addForm.action);
            console.log('Elementos del formulario encontrados:');
            console.log('deviceIdInput:', deviceIdInput);
            console.log('buildingInput:', buildingInput);
            console.log('unitInput:', unitInput);
            console.log('emailInput:', emailInput);
            
            // Verificar si los elementos existen
            console.log('¿deviceIdInput existe?', !!deviceIdInput);
            console.log('¿buildingInput existe?', !!buildingInput);
            console.log('¿unitInput existe?', !!unitInput);
            console.log('¿emailInput existe?', !!emailInput);
            
            // Verificar que los elementos existen antes de establecer valores
            if (!deviceIdInput || !buildingInput || !unitInput || !emailInput) {
                console.error('No se encontraron todos los elementos del formulario');
                deviceMsg.textContent = 'Error: Formulario no encontrado';
                deviceMsg.className = 'error';
                return;
            }
            
            // Generar email único para el dispositivo
            const uniqueEmail = await generateUniqueEmail(email);
            
            // Establecer los valores en el formulario
            deviceIdInput.value = deviceId;
            buildingInput.value = building;
            unitInput.value = unit;
            emailInput.value = uniqueEmail;
            
            console.log('Valores establecidos en el formulario:');
            console.log('Device ID:', deviceIdInput.value);
            console.log('Building:', buildingInput.value);
            console.log('Unit:', unitInput.value);
            console.log('Email original:', email);
            console.log('Email único generado:', emailInput.value);
            console.log('Action:', addForm.querySelector('input[name="action"]').value);
            
            // Log de todos los datos que se van a enviar
            const formData = new FormData(addForm);
            console.log('=== DATOS QUE SE ENVÍAN ===');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // Enviar el formulario
            console.log('Enviando formulario...');
            addForm.submit();
            
            // Limpiar formulario de entrada
            document.getElementById('newId').value = '';
            document.getElementById('newBld').value = '';
            document.getElementById('newUnit').value = '';
            document.getElementById('newEmail').value = '';
            
            // Mostrar mensaje de éxito con email único
            if (uniqueEmail !== email) {
                deviceMsg.textContent = `Device added successfully! (Unique Email: ${uniqueEmail})`;
            } else {
                deviceMsg.textContent = 'Device added successfully!';
            }
            deviceMsg.className = 'success';
            
            // Limpiar mensaje después de 3 segundos
            setTimeout(() => {
                deviceMsg.textContent = '';
                deviceMsg.className = '';
            }, 3000);
            
            // Recargar datos de Units y Dashboard después de agregar dispositivo
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                console.log('Recargando datos de Units después de agregar dispositivo...');
                loadUnitsData(null, currentUser).catch(error => {
                    console.error('Error al recargar Units después de agregar:', error);
                });
                console.log('Recargando datos de Dashboard después de agregar dispositivo...');
                loadDashboardData(currentUser).catch(error => {
                    console.error('Error al recargar Dashboard después de agregar:', error);
                });
            }, 1000);
            
            console.log('=== FIN DEL PROCESO DE AGREGAR DISPOSITIVO ===');
        }

        // Función para eliminar dispositivo
        function deleteDevice(deviceId) {
            console.log('=== INICIANDO ELIMINACIÓN DE DISPOSITIVO ===');
            console.log('Device ID:', deviceId);
            
            // Buscar el email del dispositivo en la tabla
                const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
            if (!row) {
                console.error('No se encontró la fila del dispositivo');
                alert('Error: No se encontró el dispositivo');
                return;
            }
            
            const deviceEmail = row.getAttribute('data-email');
            console.log('Email del dispositivo encontrado:', deviceEmail);
            
            if (!deviceEmail) {
                console.error('No se encontró el email del dispositivo');
                alert('Error: No se encontró el email del dispositivo');
                return;
            }
            
            // Almacenar datos del dispositivo a eliminar
            deviceToDelete = {
                id: deviceId,
                email: deviceEmail,
                row: row
            };
            
            // Mostrar modal de confirmación
            const modal = document.getElementById('delete-device-confirm-modal');
            modal.style.display = 'flex';
            console.log('Modal de confirmación de dispositivo mostrado');
        }

        // Función para editar email
        function editEmail(deviceId) {
            const newEmail = prompt(`Enter new email for device ${deviceId}:`);
            if (newEmail !== null) {
                const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
                if (row) {
                    row.setAttribute('data-email', newEmail || '');
                    const emailCell = row.querySelector('td:nth-child(4)');
                    emailCell.innerHTML = `<em style="color:#999;font-size:0.75rem;">${newEmail || 'Not set'}</em>`;
                }
            }
        }

        // Función para cargar datos de usuarios
        function loadUsersData() {
            // Esta función ya no se usa, el contenido se maneja con el formulario
        }

        // Función para manejar cambio de rol
        function handleRoleChange() {
            const roleType = document.getElementById('roleType').value;
            const buildingsGroup = document.getElementById('buildingsGroup');
            const technicianInfo = document.getElementById('technicianInfo');
            
            if (roleType === 'client') {
                buildingsGroup.style.display = 'block';
                technicianInfo.style.display = 'none';
            } else if (roleType === 'technician') {
                buildingsGroup.style.display = 'none';
                technicianInfo.style.display = 'block';
            } else if (roleType === 'admin') {
                buildingsGroup.style.display = 'none';
                technicianInfo.style.display = 'none';
            }
        }

        // Función para enviar datos al Google Apps Script
        function sendUserDataToGoogleScript(userData) {
            return new Promise((resolve, reject) => {
                // Crear formulario dinámico
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://script.google.com/macros/s/AKfycbwKhq2YbQQxyF1YRuLgRL9Ik8UZ3FtfhGXeLuV2Xn9HlzVd0UpirhIh0FgdTyH3OYaMpg/exec';
                form.target = 'hiddenIframe';
                form.style.display = 'none';
                
                // Agregar campos del formulario
                Object.keys(userData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = userData[key];
                    form.appendChild(input);
                });
                
                // Agregar formulario al DOM y enviarlo
                document.body.appendChild(form);
                form.submit();
                
                // Limpiar formulario después del envío
                setTimeout(() => {
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                }, 1000);
                
                // Simular respuesta exitosa basada en el script de Google Apps
                setTimeout(() => {
                    resolve({ 
                        success: true, 
                        message: `�?Guardado correctamente: ${userData.correo}`,
                        data: userData
                    });
                }, 2000);
            });
        }

        // Función para generar identificador único de email
        async function generateUniqueEmail(baseEmail) {
            let uniqueEmail = baseEmail;
            let counter = 1;
            
            console.log(`Buscando email único para: ${baseEmail}`);
            
            try {
                // Consultar la API real para obtener todos los dispositivos
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Extraer todos los emails de dispositivos de la API
                    const existingEmails = data.data
                        .map(device => device.clientEmail)
                        .filter(email => email && email !== -1 && email !== '-1');
                    
                    console.log(`Todos los emails existentes en API:`, existingEmails);
                    
                    // Buscar emails que coincidan con el patrón base-XX
                    const baseEmailPattern = new RegExp(`^${baseEmail.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(-\\d+)?$`);
                    const matchingEmails = existingEmails.filter(email => baseEmailPattern.test(email));
                    
                    console.log(`Emails que coinciden con el patrón:`, matchingEmails);
                    
                    if (matchingEmails.length > 0) {
                        // Buscar el siguiente número disponible
                        while (matchingEmails.includes(`${baseEmail}-${counter}`)) {
                            counter++;
                        }
                        
                        uniqueEmail = `${baseEmail}-${counter}`;
                        console.log(`Email único generado: ${uniqueEmail}`);
                    } else {
                        console.log(`No se encontraron emails duplicados, usando email base: ${baseEmail}`);
                    }
                } else {
                    console.log('No se pudieron obtener datos de la API, usando email base');
                }
            } catch (error) {
                console.error('Error al consultar API para emails únicos:', error);
                console.log('Usando email base como fallback');
            }
            
            return uniqueEmail;
        }

        // Función para agregar/actualizar usuario (NUEVA VERSIÓN)
        async function addUserNew() {
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('rolePass').value.trim();
            const roleType = document.getElementById('roleType').value;
            const userMsg = document.getElementById('userMsg');
            
            // Validar campos requeridos
            if (!email) {
                userMsg.textContent = 'Please enter an email address';
                userMsg.className = 'error';
                return;
            }
            
            if (!password) {
                userMsg.textContent = 'Please enter a password';
                userMsg.className = 'error';
                return;
            }
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                userMsg.textContent = 'Please enter a valid email address';
                userMsg.className = 'error';
                return;
            }
            
            // Obtener edificio seleccionado para clientes
            let buildings = '';
            if (roleType === 'client') {
                const selectedBuilding = document.getElementById('allowedBuildings').value;
                if (!selectedBuilding || selectedBuilding.trim() === '') {
                    userMsg.textContent = 'Please select a building for client access';
                    userMsg.className = 'error';
                    return;
                }
                buildings = selectedBuilding;
            } else {
                buildings = 'All Buildings';
            }
            
            // Mostrar mensaje de carga
            userMsg.textContent = 'Sending user data...';
            userMsg.className = 'info';
            
            try {
                // Usar el email original para usuarios (no necesitan ID único)
                const userData = {
                    nombre: password,
                    correo: email,
                    role: roleType.charAt(0).toUpperCase() + roleType.slice(1),
                    buildings: buildings,
                    action: 'add_user',
                    timestamp: new Date().toISOString()
                };
                
                // Enviar datos al Google Apps Script
                await sendUserDataToGoogleScript(userData);
                
                // Agregar nuevo usuario
                const tbody = document.querySelector('#rolesTable tbody');
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-user', password);
                newRow.setAttribute('data-user-email', email);
                newRow.setAttribute('data-buildings', buildings);
                newRow.innerHTML = `
                    <td><code>${password}</code></td>
                    <td>${roleType.charAt(0).toUpperCase() + roleType.slice(1)}</td>
                    <td><button class="delR btn-delete" data-id="${password}">Delete</button></td>
                `;
                tbody.appendChild(newRow);
                
                // Mostrar mensaje de éxito
                userMsg.textContent = '✅Usuario agregado exitosamente!';
                
                userMsg.className = 'success';
                
                // Limpiar formulario
                document.getElementById('userEmail').value = '';
                document.getElementById('rolePass').value = '';
                document.getElementById('allowedBuildings').selectedIndex = 0;
                
                // Limpiar mensaje después de 5 segundos
                setTimeout(() => {
                    userMsg.textContent = '';
                    userMsg.className = '';
                }, 5000);
                
            } catch (error) {
                console.error('Error adding user:', error);
                userMsg.textContent = '❌Error enviando datos al servidor. Usuario agregado solo localmente.';
                userMsg.className = 'error';
            }
        }

        // Función para agregar/actualizar usuario (VERSIÓN ORIGINAL - PROBLEMÁTICA)
        async function addUser() {
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('rolePass').value.trim();
            const roleType = document.getElementById('roleType').value;
            const userMsg = document.getElementById('userMsg');
            
            // Validar campos requeridos
            if (!email) {
                userMsg.textContent = 'Please enter an email address';
                userMsg.className = 'error';
                return;
            }
            
            if (!password) {
                userMsg.textContent = 'Please enter a password';
                userMsg.className = 'error';
                return;
            }
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                userMsg.textContent = 'Please enter a valid email address';
                userMsg.className = 'error';
                return;
            }
            
            // Obtener edificio seleccionado para clientes
            let buildings = '';
            if (roleType === 'client') {
                const selectedBuilding = document.getElementById('allowedBuildings').value;
                if (!selectedBuilding || selectedBuilding.trim() === '') {
                    userMsg.textContent = 'Please select a building for client access';
                    userMsg.className = 'error';
                    return;
                }
                buildings = selectedBuilding;
            } else {
                buildings = 'All Buildings';
            }
            
            // Mostrar mensaje de carga
            userMsg.textContent = 'Sending user data...';
            userMsg.className = 'info';
            
            try {
                // Usar el email original para usuarios (no necesitan ID único)
                const userData = {
                    nombre: password, // El script espera 'nombre' como primer campo
                    correo: email,    // Usar el email original
                    role: roleType.charAt(0).toUpperCase() + roleType.slice(1),
                    buildings: buildings,
                    action: 'add_user',
                    timestamp: new Date().toISOString()
                };
                
                // Enviar datos al Google Apps Script
                await sendUserDataToGoogleScript(userData);
                
                // Agregar nuevo usuario (siempre crear nueva entrada)
                const tbody = document.querySelector('#rolesTable tbody');
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-user', password);
                newRow.setAttribute('data-user-email', email);
                newRow.setAttribute('data-buildings', buildings);
                newRow.innerHTML = `
                        <td><code>${password}</code></td>
                        <td>${roleType.charAt(0).toUpperCase() + roleType.slice(1)}</td>
                        <td><button class="delR btn-delete" data-id="${password}">Delete</button></td>
                    `;
                tbody.appendChild(newRow);
                userMsg.textContent = '¡Usuario agregado exitosamente!';
                
                userMsg.className = 'success';
                
                // Limpiar formulario
                document.getElementById('userEmail').value = '';
                document.getElementById('rolePass').value = '';
                document.getElementById('allowedBuildings').selectedIndex = 0;
                
                // Limpiar mensaje después de 5 segundos
                setTimeout(() => {
                    userMsg.textContent = '';
                    userMsg.className = '';
                }, 5000);
                
                // Limpiar caché para forzar recarga desde API
                localStorage.removeItem('usersData');
                localStorage.removeItem('usersDataTimestamp');
                
            } catch (error) {
                console.error('Error sending user data:', error);
                userMsg.textContent = '�?Error enviando datos al servidor. Usuario agregado solo localmente.';
                userMsg.className = 'error';
                
                // Aún así agregar el usuario localmente
                const existingRow = document.querySelector(`tr[data-user-email="${email}"]`);
                if (!existingRow) {
                    const tbody = document.querySelector('#rolesTable tbody');
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-user', password);
                    newRow.setAttribute('data-user-email', email);
                    newRow.setAttribute('data-buildings', buildings);
                    newRow.innerHTML = `
                        <td><code>${password}</code></td>
                        <td>${roleType.charAt(0).toUpperCase() + roleType.slice(1)}</td>
                        <td><button class="delR btn-delete" data-id="${password}">Delete</button></td>
                    `;
                    tbody.appendChild(newRow);
                }
                
                // Limpiar formulario
                document.getElementById('userEmail').value = '';
                document.getElementById('rolePass').value = '';
                document.querySelectorAll('.building-checkbox').forEach(cb => cb.checked = false);
            }
        }

        // Función para eliminar usuario
        function deleteUser(password) {
            if (confirm(`Are you sure you want to delete user ${password}?`)) {
                const row = document.querySelector(`tr[data-user="${password}"]`);
                if (row) {
                    row.remove();
                }
            }
        }

        // Función para abrir modal de lista de usuarios
        function openUsersListModal() {
            document.getElementById('users-list-modal').style.display = 'flex';
        }

        // Función para cerrar modal de lista de usuarios
        function closeUsersListModal() {
            document.getElementById('users-list-modal').style.display = 'none';
        }

        // Función para abrir modal de detalles de usuario
        function openUserDetailsModal(password, role, buildings, email) {
            const modal = document.getElementById('user-details-modal');
            const content = document.getElementById('userDetailsContent');
            
            // Crear contenido detallado del usuario
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 22px; font-weight: 700; text-align: center;">User Information</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                        <!-- Email Section -->
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #3498db; color: white; padding: 6px 10px; border-radius: 50%; margin-right: 12px; font-size: 14px;">📧</span>
                                <strong style="color: #0b3d91; font-size: 16px;">Email Address</strong>
                            </div>
                            <div style="color: #2c3e50; font-size: 15px; font-weight: 500;">${email}</div>
                        </div>
                        
                        <!-- Password Section -->
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #e74c3c; color: white; padding: 6px 10px; border-radius: 50%; margin-right: 12px; font-size: 14px;">🔐</span>
                                <strong style="color: #0b3d91; font-size: 16px;">Password</strong>
                            </div>
                            <code style="background: #f8f9fa; color: #e74c3c; padding: 8px 12px; border-radius: 6px; font-size: 15px; font-weight: 600; display: inline-block;">${password}</code>
                        </div>
                        
                        <!-- Role Section -->
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid ${role === 'Admin' ? '#e74c3c' : role === 'Technician' ? '#f39c12' : '#3498db'}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: ${role === 'Admin' ? '#e74c3c' : role === 'Technician' ? '#f39c12' : '#3498db'}; color: white; padding: 6px 10px; border-radius: 50%; margin-right: 12px; font-size: 14px;">${role === 'Admin' ? '👑' : role === 'Technician' ? '🔧' : '👤'}</span>
                                <strong style="color: #0b3d91; font-size: 16px;">User Role</strong>
                            </div>
                            <span style="background: ${role === 'Admin' ? '#e74c3c' : role === 'Technician' ? '#f39c12' : '#3498db'}; color: white; padding: 8px 16px; border-radius: 25px; font-size: 15px; font-weight: 600; display: inline-block;">${role}</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Access Permissions</h4>
                    <div>
                        <strong style="color: #0b3d91;">Buildings Access:</strong><br>
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #3498db;">
                            ${buildings}
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Role Description</h4>
                    <div style="line-height: 1.6;">
                        ${role === 'Admin' ? 
                            '<p><strong>Full Access:</strong> Can view, edit, and manage all aspects of the elevator system including users, devices, reports, and service logs.</p>' :
                            role === 'Technician' ? 
                            '<p><strong>Technical Access:</strong> Can access all buildings and perform maintenance tasks, view service logs, and update device status.</p>' :
                            '<p><strong>Client Access:</strong> View-only access to specific buildings assigned to this user. Can view elevator status and basic information.</p>'
                        }
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Función para cerrar modal de detalles de usuario
        function closeUserDetailsModal() {
            document.getElementById('user-details-modal').style.display = 'none';
        }

        // Función para abrir modal de lista de dispositivos
        function openDevicesListModal() {
            console.log('=== ABRIENDO MODAL DE DISPOSITIVOS ===');
            document.getElementById('devices-list-modal').style.display = 'flex';
            
            // Siempre cargar datos frescos
            console.log('Cargando datos frescos de dispositivos para el modal...');
            loadDevicesData();
        }

        // Función para cerrar modal de lista de dispositivos
        function closeDevicesListModal() {
            document.getElementById('devices-list-modal').style.display = 'none';
        }

        // Función para abrir modal de detalles de dispositivo
        function openDeviceDetailsModal(deviceId, building, unit, email) {
            const modal = document.getElementById('device-details-modal');
            const content = document.getElementById('deviceDetailsContent');
            
            // Crear contenido detallado del dispositivo
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 20px;">Device Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: #0b3d91;">Device ID:</strong><br>
                            <code style="font-size: 16px; padding: 8px 12px;">${deviceId}</code>
                        </div>
                        <div>
                            <strong style="color: #0b3d91;">Status:</strong><br>
                            <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">Online</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Location Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: #0b3d91;">Building:</strong><br>
                            <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #3498db;">
                                ${building}
                            </div>
                        </div>
                        <div>
                            <strong style="color: #0b3d91;">Unit/Elevator:</strong><br>
                            <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #e74c3c;">
                                ${unit}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Contact Information</h4>
                    <div>
                        <strong style="color: #0b3d91;">Client Email:</strong><br>
                        <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #f39c12;">
                            ${email || '<em style="color: #999;">Not set</em>'}
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Device Capabilities</h4>
                    <div style="line-height: 1.6;">
                        <p><strong>Monitoring:</strong> Real-time elevator status, floor position, door status, and operational state.</p>
                        <p><strong>Alerts:</strong> Automatic notifications for maintenance needs, safety issues, and system errors.</p>
                        <p><strong>Control:</strong> Remote diagnostics, emergency stop, and maintenance mode activation.</p>
                        <p><strong>Data:</strong> Usage statistics, performance metrics, and maintenance history tracking.</p>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Función para cerrar modal de detalles de dispositivo
        function closeDeviceDetailsModal() {
            document.getElementById('device-details-modal').style.display = 'none';
        }

        // Función para manejar filtros
        function handleFilterClick(event) {
            const filterPills = document.querySelectorAll('.filter-pill');
            filterPills.forEach(pill => pill.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            
            // Filtros de estado
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.addEventListener('click', handleFilterClick);
            });
            
            // Búsqueda
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.toLowerCase();
                    filterElevators(searchTerm);
                }
            });

            // Botón de búsqueda
            document.getElementById('search-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                filterElevators(searchTerm);
            });
            
            // Botón de filtro - abrir modal (primer botón del header-right)
            document.querySelector('.header-right .icon-btn').addEventListener('click', function() {
                document.getElementById('filter-modal').style.display = 'flex';
                // Cargar edificios del usuario cuando se abre el modal
                loadUserBuildings();
            });
            
            // Cerrar modal
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('filter-modal').style.display = 'none';
            });
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('filter-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });

            // Cerrar modal del elevador
            document.getElementById('close-elevator-modal').addEventListener('click', function() {
                document.getElementById('elevator-modal').style.display = 'none';
            });
            
            // Cerrar modal del elevador al hacer clic fuera
            document.getElementById('elevator-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // Aplicar filtros
            document.getElementById('apply-filters').addEventListener('click', function() {
                const selectedStatus = document.querySelector('input[name="status"]:checked').value;
                const selectedBuilding = document.getElementById('buildingFilter').value;
                
                console.log('Filtros aplicados:', { status: selectedStatus, building: selectedBuilding });
                
                // Filtrar dispositivos por edificio y estado
                filterDevicesByBuildingAndStatus(selectedBuilding, selectedStatus);
                
                document.getElementById('filter-modal').style.display = 'none';
            });
            
            // Limpiar filtros
            document.getElementById('clear-filters').addEventListener('click', function() {
                document.querySelector('input[name="status"][value="all"]').checked = true;
                document.getElementById('buildingFilter').value = 'all';
                
                // Mostrar todos los dispositivos
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                loadUnitsData(null, currentUser);
            });

            // Service form functionality
            
            // Add service entry button
            document.getElementById('addServiceBtn').addEventListener('click', addServiceEntry);
            
            // Generate report button
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            
            // Add device button
            document.getElementById('addDeviceBtn').addEventListener('click', addDevice);
            
            // Device table event delegation
            document.getElementById('devicesTable').addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-delete')) {
                    const deviceId = e.target.getAttribute('data-id');
                    deleteDevice(deviceId);
                } else if (e.target.classList.contains('edit-email')) {
                    const deviceId = e.target.getAttribute('data-id');
                    editEmail(deviceId);
                } else if (e.target.tagName === 'TD' || e.target.tagName === 'STRONG') {
                    // Click en cualquier celda para ver detalles
                    const row = e.target.closest('tr');
                    if (row) {
                        const deviceId = row.getAttribute('data-device-id');
                        const building = row.getAttribute('data-building');
                        const unit = row.getAttribute('data-unit');
                        const email = row.getAttribute('data-email');
                        openDeviceDetailsModal(deviceId, building, unit, email);
                    }
                }
            });
            
            // View devices button
            document.getElementById('viewDevicesBtn').addEventListener('click', openDevicesListModal);
            

            // Refresh All APIs button
            document.getElementById('refresh-all-btn').addEventListener('click', function() {
                console.log('Botón Refresh All APIs clickeado');
                refreshAllAPIs();
            });
            
            // Refresh Units Only button
            document.getElementById('refresh-units-btn').addEventListener('click', function() {
                console.log('Botón Refresh Units clickeado');
                refreshUnitsOnly();
            });
            
            // Close devices list modal
            document.getElementById('close-devices-modal').addEventListener('click', closeDevicesListModal);
            document.getElementById('devices-list-modal').addEventListener('click', function(e) {
                if (e.target === this) closeDevicesListModal();
            });
            
            // Close device details modal
            document.getElementById('close-device-details-modal').addEventListener('click', closeDeviceDetailsModal);
            document.getElementById('device-details-modal').addEventListener('click', function(e) {
                if (e.target === this) closeDeviceDetailsModal();
            });
            
            // User management functionality
            document.getElementById('roleType').addEventListener('change', handleRoleChange);
            document.getElementById('addRoleBtn').addEventListener('click', addUserNew);
            
            // User table event delegation
            document.getElementById('rolesTable').addEventListener('click', function(e) {
                if (e.target.classList.contains('delR')) {
                    const password = e.target.getAttribute('data-id');
                    deleteUser(password);
                } else if (e.target.tagName === 'TD' || e.target.tagName === 'CODE') {
                    // Click en cualquier celda para ver detalles
                    const row = e.target.closest('tr');
                    if (row) {
                        const password = row.querySelector('code').textContent;
                        const role = row.cells[1].textContent;
                        const buildings = row.getAttribute('data-buildings') || 'All Buildings';
                        const email = row.getAttribute('data-user-email') || 'Not set';
                        openUserDetailsModal(password, role, buildings, email);
                    }
                }
            });
            
            // View users button
            document.getElementById('viewUsersBtn').addEventListener('click', openUsersListModal);
            
            // Close users list modal
            document.getElementById('close-users-modal').addEventListener('click', closeUsersListModal);
            document.getElementById('users-list-modal').addEventListener('click', function(e) {
                if (e.target === this) closeUsersListModal();
            });
            
            // Close user details modal
            document.getElementById('close-user-details-modal').addEventListener('click', closeUserDetailsModal);
            document.getElementById('user-details-modal').addEventListener('click', function(e) {
                if (e.target === this) closeUserDetailsModal();
            });
            
            // View history button
            document.getElementById('viewHistoryBtn').addEventListener('click', openServiceHistoryModal);
            
            // Close history modal
            document.getElementById('close-history-modal').addEventListener('click', closeServiceHistoryModal);
            
            // Close history modal when clicking outside
            document.getElementById('service-history-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeServiceHistoryModal();
                }
            });

            // Event listeners para el modal de confirmación de eliminación de usuario
            document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
            document.getElementById('cancel-delete').addEventListener('click', cancelDelete);
            
            // Event listeners para el modal de confirmación de eliminación de dispositivo
            document.getElementById('confirm-delete-device').addEventListener('click', confirmDeleteDevice);
            document.getElementById('cancel-delete-device').addEventListener('click', cancelDeleteDevice);
            
            // Event listeners para el modal de confirmación de logout
            document.getElementById('confirm-logout').addEventListener('click', confirmLogout);
            document.getElementById('cancel-logout').addEventListener('click', closeLogoutModal);
            
            // Cerrar modal de confirmación de usuario al hacer clic fuera
            document.getElementById('delete-confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelDelete();
                }
            });
            
            // Cerrar modal de confirmación de dispositivo al hacer clic fuera
            document.getElementById('delete-device-confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelDeleteDevice();
                }
            });

        });

        // Cargar datos cuando se cambie de pantalla
        function showScreen(screenId) {
            // Verificar si la pantalla está permitida para el usuario actual
            if (!isScreenAllowed(screenId)) {
                console.log(`Pantalla ${screenId} no permitida para el usuario actual`);
                // Redirigir a la primera pantalla permitida
                const allowedScreen = getFirstAllowedScreen();
                console.log(`Redirigiendo a ${allowedScreen}`);
                showScreen(allowedScreen);
                return;
            }
            
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Activar el botón de navegación correspondiente
            const navButtons = document.querySelectorAll(`[onclick="showScreen('${screenId}')"]`);
            navButtons.forEach(button => button.classList.add('active'));
            
            // Cargar datos cuando sea necesario
            switch(screenId) {
                case 'dashboard-screen':
                    console.log('=== NAVEGANDO A PANTALLA DE DASHBOARD ===');
                    // Los datos ya están cargados desde el inicio de la página
                    break;
                case 'units-screen':
                    console.log('=== NAVEGANDO A PANTALLA DE UNIDADES ===');
                    // Los datos ya están cargados desde el inicio de la página
                    break;
                case 'service-screen':
                    console.log('=== NAVEGANDO A PANTALLA DE SERVICIO ===');
                    // Cargar dispositivos para el select
                    loadServiceDevices();
                    break;
                case 'reports-screen':
                    console.log('=== NAVEGANDO A PANTALLA DE REPORTES ===');
                    // Cargar dispositivos para el select de reportes
                    loadReportDevices();
                    if (document.getElementById('reports-list').children.length === 0) {
                        loadReportsData();
                    }
                    break;
                case 'devices-screen':
                    console.log('=== NAVEGANDO A PANTALLA DE DISPOSITIVOS ===');
                    // No cargar datos automáticamente, solo cuando se abra el modal
                    break;
                case 'users-screen':
                    console.log('=== NAVEGANDO A PANTALLA DE USUARIOS ===');
                    // Verificar qué elementos existen en la pantalla de usuarios
                    const usersListElement = document.getElementById('users-list');
                    const rolesTableElement = document.getElementById('rolesTable');
                    console.log('Elemento users-list encontrado:', usersListElement);
                    console.log('Elemento rolesTable encontrado:', rolesTableElement);
                    
                    if (usersListElement && usersListElement.children.length === 0) {
                        console.log('Cargando datos estáticos...');
                        loadUsersData();
                    }
                    // Cargar datos reales cuando se abra la pantalla de usuarios
                    console.log('Iniciando carga de datos reales...');
                    loadRealUsersData();
                    
                    // Cargar edificios desde la API
                    console.log('Cargando edificios desde API...');
                    loadBuildingsFromAPI();
                    break;
            }
        }

        // Los datos se cargan a través de checkAuthentication() y loadAppData()

        // Función de prueba para verificar la API
        async function testAPI() {
            console.log('=== PRUEBA DE API ===');
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbyvJDE1qb-qULHBpeSnWDs88KH-PZhlmzRxQKV2be2aR2oD-f48-MDLwSz0xil2NIKl/exec');
                console.log('Respuesta de prueba:', response);
                const data = await response.json();
                console.log('Datos de prueba:', data);
                return data;
            } catch (error) {
                console.error('Error en prueba de API:', error);
                return null;
            }
        }

        // Ejecutar prueba de API al cargar la página
        testAPI();

        // Función para cargar datos reales de usuarios desde la API
        async function loadRealUsersData() {
            try {
                console.log('=== INICIANDO CARGA DE DATOS DE USUARIOS ===');
                console.log('URL de la API:', 'https://script.google.com/macros/s/AKfycbyvJDE1qb-qULHBpeSnWDs88KH-PZhlmzRxQKV2be2aR2oD-f48-MDLwSz0xil2NIKl/exec');
                
                // Cargar datos del localStorage primero
                const cachedData = localStorage.getItem('usersData');
                const cacheTimestamp = localStorage.getItem('usersDataTimestamp');
                const now = Date.now();
                const cacheAge = cacheTimestamp ? now - parseInt(cacheTimestamp) : Infinity;
                
                console.log('Datos en caché:', cachedData ? 'Sí' : 'No');
                console.log('Edad del caché:', cacheAge, 'ms');
                
                // Si hay datos en caché y son recientes (menos de 5 minutos), usarlos
                if (cachedData && cacheAge < 300000) {
                    console.log('Usando datos del localStorage (caché)');
                    const data = JSON.parse(cachedData);
                    updateUsersTable(data);
                    return data;
                }
                
                // Mostrar indicador de carga solo si no hay datos en caché
                const tbody = document.querySelector('#rolesTable tbody');
                if (tbody && !cachedData) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6c757d;">Cargando usuarios...</td></tr>';
                }
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbyvJDE1qb-qULHBpeSnWDs88KH-PZhlmzRxQKV2be2aR2oD-f48-MDLwSz0xil2NIKl/exec');
                console.log('Respuesta de la API recibida:', response);
                console.log('Status de la respuesta:', response.status);
                console.log('OK de la respuesta:', response.ok);
                
                const data = await response.json();
                console.log('Datos JSON parseados:', data);
                console.log('Tipo de datos:', typeof data);
                console.log('¿Tiene success?', 'success' in data);
                console.log('¿Tiene data?', 'data' in data);
                
                if (data.success && data.data) {
                    console.log('Datos válidos encontrados, cantidad:', data.data.length);
                    console.log('Primer usuario:', data.data[0]);
                    
                    // Guardar en localStorage
                    localStorage.setItem('usersData', JSON.stringify(data.data));
                    localStorage.setItem('usersDataTimestamp', now.toString());
                    console.log('Datos guardados en localStorage');
                    
                    updateUsersTable(data.data);
                    return data.data;
                } else {
                    console.error('Error en la respuesta de la API:', data);
                    console.log('Estructura de la respuesta:', JSON.stringify(data, null, 2));
                    
                    // Si hay error en la API pero hay datos en caché, usarlos
                    if (cachedData) {
                        console.log('Usando datos del localStorage como fallback');
                        const fallbackData = JSON.parse(cachedData);
                        updateUsersTable(fallbackData);
                        return fallbackData;
                    }
                    
                    return [];
                }
            } catch (error) {
                console.error('Error al cargar datos de usuarios:', error);
                console.error('Tipo de error:', error.name);
                console.error('Mensaje de error:', error.message);
                console.error('Stack trace:', error.stack);
                
                // Si hay error en la API pero hay datos en caché, usarlos
                const cachedData = localStorage.getItem('usersData');
                if (cachedData) {
                    console.log('Usando datos del localStorage como fallback después del error');
                    const fallbackData = JSON.parse(cachedData);
                    updateUsersTable(fallbackData);
                    return fallbackData;
                }
                
                return [];
            }
        }

        // Función para actualizar la tabla de usuarios con datos reales
        function updateUsersTable(usersData) {
            console.log('=== ACTUALIZANDO TABLA DE USUARIOS ===');
            console.log('Datos recibidos:', usersData);
            console.log('Tipo de datos:', typeof usersData);
            console.log('Es array:', Array.isArray(usersData));
            console.log('Cantidad de usuarios:', usersData ? usersData.length : 'undefined');
            
            const tbody = document.querySelector('#rolesTable tbody');
            console.log('Elemento tbody encontrado:', tbody);
            
            if (!tbody) {
                console.error('No se encontró la tabla de usuarios');
                return;
            }

            // Mostrar indicador de carga
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6c757d;">Cargando usuarios...</td></tr>';
            console.log('Indicador de carga mostrado');

            // Simular un pequeño delay para mostrar el indicador de carga
            setTimeout(() => {
                console.log('Iniciando actualización de tabla...');
                
                // Limpiar tabla existente
                tbody.innerHTML = '';
                console.log('Tabla limpiada');

                if (!usersData || usersData.length === 0) {
                    console.log('No hay datos de usuarios, mostrando mensaje');
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6c757d;">No hay usuarios registrados</td></tr>';
                    return;
                }

                console.log(`Procesando ${usersData.length} usuarios...`);

                // Agregar cada usuario
                usersData.forEach((user, index) => {
                    console.log(`Procesando usuario ${index + 1}:`, user);
                    
                    const row = document.createElement('tr');
                    row.setAttribute('data-user', user.Contraseña);
                    row.setAttribute('data-user-email', user.Email);
                    row.setAttribute('data-buildings', user.builds);
                    
                    // Determinar si es admin (protegido)
                    const isAdmin = user.role === 'Admin';
                    const actionButton = isAdmin 
                        ? '<span style="color:#999;font-size:0.85rem;">Protected</span>'
                        : `<button class="delR btn-delete" data-id="${user.Contraseña}" onclick="deleteUser('${user.Contraseña}')">Delete</button>`;
                    
                    row.innerHTML = `
                        <td><code>${user.Contraseña}</code></td>
                        <td>${user.role}</td>
                        <td style="white-space: nowrap;">
                            ${actionButton}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                    console.log(`Usuario ${index + 1} agregado a la tabla`);
                });

                console.log(`Tabla actualizada con ${usersData.length} usuarios`);
                console.log('=== FIN DE ACTUALIZACIÓN DE TABLA ===');
            }, 500);
        }

        // Función para mostrar detalles de usuario con datos reales
        function showUserDetails(userId) {
            console.log('=== MOSTRANDO DETALLES DE USUARIO ===');
            console.log('ID del usuario:', userId);
            console.log('Tipo de ID:', typeof userId);
            
            // Mostrar modal inmediatamente con indicador de carga
            const modal = document.getElementById('user-details-modal');
            const content = document.getElementById('userDetailsContent');
            
            console.log('Modal encontrado:', modal);
            console.log('Content encontrado:', content);
            
            if (!modal || !content) {
                console.error('Modal de detalles de usuario no encontrado');
                return;
            }

            // Mostrar indicador de carga
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 18px; margin-bottom: 10px;">Cargando detalles del usuario...</div>
                    <div style="font-size: 14px;">Por favor espera</div>
                </div>
            `;
            
            modal.style.display = 'flex';
            console.log('Modal mostrado con indicador de carga');
            
            // Buscar el usuario en la tabla
            const userRow = document.querySelector(`tr[data-user="${userId}"]`);
            console.log('Fila del usuario encontrada:', userRow);
            
            if (!userRow) {
                console.error('Usuario no encontrado en la tabla');
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Usuario no encontrado</div>';
                return;
            }

            const userEmail = userRow.getAttribute('data-user-email');
            const userBuildings = userRow.getAttribute('data-buildings');
            console.log('Email del usuario:', userEmail);
            console.log('Edificios del usuario:', userBuildings);
            
            // Obtener datos completos del usuario desde la API
            console.log('Cargando datos completos desde la API...');
            loadRealUsersData().then(usersData => {
                console.log('Datos completos recibidos:', usersData);
                console.log('Buscando usuario con ID:', userId);
                
                const user = usersData.find(u => u.Contraseña === userId);
                console.log('Usuario encontrado:', user);
                
                if (user) {
                    console.log('Mostrando detalles del usuario');
                    displayUserDetails(user);
                } else {
                    console.error('No se encontraron datos completos del usuario');
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">No se encontraron datos del usuario</div>';
                }
            }).catch(error => {
                console.error('Error al cargar datos del usuario:', error);
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar datos del usuario</div>';
            });
        }

        // Función para mostrar los detalles del usuario en el modal
        function displayUserDetails(user) {
            console.log('=== MOSTRANDO DETALLES EN EL MODAL ===');
            console.log('Datos del usuario recibidos:', user);
            console.log('Tipo de datos:', typeof user);
            
            const modal = document.getElementById('user-details-modal');
            const content = document.getElementById('userDetailsContent');
            
            console.log('Modal encontrado:', modal);
            console.log('Content encontrado:', content);
            
            if (!modal || !content) {
                console.error('Modal de detalles de usuario no encontrado');
                return;
            }

            console.log('Creando contenido HTML...');
            console.log('Contraseña:', user.Contraseña);
            console.log('Email:', user.Email);
            console.log('Rol:', user.role);
            console.log('Edificios:', user.builds);
            console.log('Proyecto:', user.proyecto);
            console.log('Fecha inicio:', user.fecha_inicio_de_plan);
            console.log('Fecha fin:', user.fecha_fin_de_plan);

            // Crear contenido HTML con los datos del usuario
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Información Personal</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Contraseña:</strong><br>
                            <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px;">${user.Contraseña}</code>
                        </div>
                        <div>
                            <strong>Email:</strong><br>
                            <span style="color: #2980b9;">${user.Email}</span>
                        </div>
                        <div>
                            <strong>Rol:</strong><br>
                            <span style="background: ${user.role === 'Admin' ? '#e74c3c' : user.role === 'Client' ? '#27ae60' : '#f39c12'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;">
                                ${user.role}
                            </span>
                        </div>
                        <div>
                            <strong>Proyecto:</strong><br>
                            <span>${user.proyecto || 'Sin proyecto'}</span>
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Edificios Asignados</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                        ${user.builds || 'Sin edificios asignados'}
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Plan de Mantenimiento</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Fecha de Inicio:</strong><br>
                            <span style="color: ${user.fecha_inicio_de_plan ? '#27ae60' : '#e74c3c'};">
                                ${user.fecha_inicio_de_plan || 'Sin fecha'}
                            </span>
                        </div>
                        <div>
                            <strong>Fecha de Fin:</strong><br>
                            <span style="color: ${user.fecha_fin_de_plan ? '#27ae60' : '#e74c3c'};">
                                ${user.fecha_fin_de_plan || 'Sin fecha'}
                            </span>
                        </div>
                    </div>
                </div>
            `;

            // Mostrar el modal
            modal.style.display = 'flex';
            console.log('Modal mostrado con detalles del usuario');
            console.log('=== FIN DE MOSTRAR DETALLES EN EL MODAL ===');
        }

        // Variable global para almacenar el usuario a eliminar
        let userToDelete = null;
        
        // Variable global para almacenar el dispositivo a eliminar
        let deviceToDelete = null;

        // Función para eliminar usuario
        function deleteUser(userId) {
            console.log('=== INICIANDO ELIMINACIÓN DE USUARIO ===');
            console.log('Usuario a eliminar (password):', userId);
            
            // Buscar el correo real del usuario en la tabla
            const userRow = document.querySelector(`tr[data-user="${userId}"]`);
            let userEmail = userId; // Por defecto usar el userId
            
            if (userRow) {
                // Buscar si hay un atributo data-user-email
                const emailAttr = userRow.getAttribute('data-user-email');
                if (emailAttr) {
                    userEmail = emailAttr;
                    console.log('Correo encontrado en data-user-email:', userEmail);
                } else {
                    // Si no hay data-user-email, buscar en la tabla de usuarios dinámicos
                    const dynamicUserRow = document.querySelector(`tr[data-user-email="${userId}"]`);
                    if (dynamicUserRow) {
                        userEmail = dynamicUserRow.getAttribute('data-user-email');
                        console.log('Correo encontrado en tabla dinámica:', userEmail);
                    } else {
                        console.log('No se encontró correo específico, usando password como correo:', userEmail);
                    }
                }
            } else {
                console.log('No se encontró la fila del usuario, usando password como correo:', userEmail);
            }
            
            // Almacenar datos del usuario a eliminar
            userToDelete = {
                id: userId,
                email: userEmail
            };
            
            // Mostrar modal de confirmación
            const modal = document.getElementById('delete-confirm-modal');
            modal.style.display = 'flex';
            console.log('Modal de confirmación mostrado');
        }

        // Función para confirmar eliminación
        function confirmDelete() {
            if (!userToDelete) {
                console.error('No hay usuario para eliminar');
                return;
            }
            
            console.log('Usuario confirmó la eliminación');
            console.log('Eliminando usuario:', userToDelete.id, 'con email:', userToDelete.email);
            
            // Obtener el formulario de eliminación
            const deleteForm = document.getElementById('deleteUserForm');
            const emailInput = document.getElementById('deleteUserEmail');
            
            console.log('Formulario encontrado:', deleteForm);
            console.log('Campo email encontrado:', emailInput);
            console.log('URL del formulario:', deleteForm.action);
            
            // Establecer el correo del usuario
            emailInput.value = userToDelete.email;
            
            console.log('Valor del email establecido:', emailInput.value);
            console.log('Action del formulario:', deleteForm.querySelector('input[name="action"]').value);
            
            // Log de todos los datos que se van a enviar
            const formData = new FormData(deleteForm);
            console.log('=== DATOS QUE SE ENVÍAN ===');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // Enviar el formulario
            console.log('Enviando formulario...');
            deleteForm.submit();
            
            // Cerrar modal de confirmación
            const modal = document.getElementById('delete-confirm-modal');
            modal.style.display = 'none';
            
            console.log('=== INICIANDO ACTUALIZACIÓN DE USUARIOS ===');
            
            // Mostrar indicador de actualización
            const tbody = document.querySelector('#rolesTable tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6c757d;">Actualizando lista de usuarios...</td></tr>';
            }
            
            // Esperar un momento para que el servidor procese la eliminación
            setTimeout(() => {
                console.log('Recargando datos de usuarios después de eliminación...');
                // Limpiar caché para forzar recarga desde API
                localStorage.removeItem('usersData');
                localStorage.removeItem('usersDataTimestamp');
                loadRealUsersData().then(usersData => {
                    console.log('Datos actualizados después de eliminación:', usersData);
                    console.log('Lista de usuarios actualizada exitosamente');
                }).catch(error => {
                    console.error('Error al recargar usuarios después de eliminación:', error);
                    // En caso de error, mostrar mensaje
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #e74c3c;">Error al actualizar la lista</td></tr>';
                    }
                });
            }, 2000); // Esperar 2 segundos para que el servidor procese
            
            console.log('=== FIN DEL PROCESO DE ELIMINACIÓN ===');
            
            // Limpiar variable
            userToDelete = null;
        }

        // Función para cancelar eliminación
        function cancelDelete() {
            console.log('Usuario canceló la eliminación');
            const modal = document.getElementById('delete-confirm-modal');
            modal.style.display = 'none';
            userToDelete = null;
        }

        // Función para confirmar eliminación de dispositivo
        function confirmDeleteDevice() {
            if (!deviceToDelete) {
                console.error('No hay dispositivo para eliminar');
                return;
            }
            
            console.log('Usuario confirmó la eliminación del dispositivo');
            console.log('Eliminando dispositivo:', deviceToDelete.id, 'con email:', deviceToDelete.email);
            
            // Obtener el formulario de eliminar dispositivo
            const deleteForm = document.getElementById('deleteDeviceForm');
            const emailInput = document.getElementById('deleteDeviceEmail');
            
            console.log('Formulario encontrado:', deleteForm);
            console.log('URL del formulario:', deleteForm.action);
            
            // Establecer el email del dispositivo
            emailInput.value = deviceToDelete.email;
            
            console.log('Valor del clientEmail establecido:', emailInput.value);
            console.log('Action del formulario:', deleteForm.querySelector('input[name="action"]').value);
            
            // Log de todos los datos que se van a enviar
            const formData = new FormData(deleteForm);
            console.log('=== DATOS QUE SE ENVÍAN ===');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // Enviar el formulario
            console.log('Enviando formulario...');
            deleteForm.submit();
            
            // Cerrar modal de confirmación
            const modal = document.getElementById('delete-device-confirm-modal');
            modal.style.display = 'none';
            
            // Cerrar modal de All Devices
            const devicesModal = document.getElementById('devices-list-modal');
            devicesModal.style.display = 'none';
            
            // Mostrar indicador de eliminación en la tabla
            if (deviceToDelete.row) {
                deviceToDelete.row.innerHTML = '<td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">Eliminando dispositivo...</td>';
                console.log('Mostrando indicador de eliminación');
            }
            
            // Recargar lista de dispositivos después de eliminar
            setTimeout(() => {
                console.log('Recargando lista de dispositivos después de eliminar...');
                loadDevicesData();
            }, 2000);
            
            // Recargar datos de Units y Dashboard después de eliminar dispositivo
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                console.log('Recargando datos de Units después de eliminar dispositivo...');
                loadUnitsData(null, currentUser).catch(error => {
                    console.error('Error al recargar Units después de eliminar:', error);
                });
                console.log('Recargando datos de Dashboard después de eliminar dispositivo...');
                loadDashboardData(currentUser).catch(error => {
                    console.error('Error al recargar Dashboard después de eliminar:', error);
                });
            }, 1000);
            
            console.log('=== FIN DEL PROCESO DE ELIMINACIÓN DE DISPOSITIVO ===');
            
            // Limpiar variable
            deviceToDelete = null;
        }

        // Función para cancelar eliminación de dispositivo
        function cancelDeleteDevice() {
            console.log('Usuario canceló la eliminación del dispositivo');
            const modal = document.getElementById('delete-device-confirm-modal');
            modal.style.display = 'none';
            deviceToDelete = null;
        }


        // Función para generar y descargar PDF de reportes
        function generateReportPDF() {
            console.log('=== GENERANDO PDF DE REPORTE ===');
            
            try {
                // Verificar que jsPDF esté disponible
                if (typeof window.jspdf === 'undefined') {
                    console.error('jsPDF no está disponible');
                    alert('Error: jsPDF library not loaded. Please refresh the page.');
                    return;
                }
                
                // Obtener datos del formulario
                const reportType = document.getElementById('reportType').value;
                const deviceSelect = document.getElementById('reportDeviceSelect');
                const selectedDevice = deviceSelect.value;
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const comments = document.getElementById('reportComments').value;
                
                console.log('Datos del formulario:', {
                    reportType,
                    selectedDevice,
                    startDate,
                    endDate,
                    comments
                });
                
                // Crear nuevo documento PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            
            // Configurar fuente y colores
            doc.setFont('helvetica');
            
            // Título del reporte
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80); // Color azul oscuro
            doc.text('BERMUDA ELEVATORS', 20, 30);
            doc.text('REPORTE DE SISTEMA', 20, 40);
            
            // Línea separadora
            doc.setDrawColor(44, 62, 80);
            doc.setLineWidth(0.5);
            doc.line(20, 45, 190, 45);
            
            // Información del reporte
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Report Type: ${reportType}`, 20, 60);
            doc.text(`Device: ${selectedDevice === 'all' ? 'All Devices' : selectedDevice}`, 20, 70);
            doc.text(`Start Date: ${startDate || 'Not specified'}`, 20, 80);
            doc.text(`End Date: ${endDate || 'Not specified'}`, 20, 90);
            doc.text(`Generated: ${new Date().toLocaleString('en-US')}`, 20, 100);
            
                // Inicializar yPosition
                let yPosition = 110;
                
                // Agregar comentarios del técnico si existen
                if (comments && comments.trim()) {
                    doc.text(`Technician Comments:`, 20, yPosition);
                    yPosition += 10;
                    
                    // Dividir comentarios largos en múltiples líneas
                    const maxWidth = 170;
                    const splitComments = doc.splitTextToSize(comments, maxWidth);
                    splitComments.forEach(line => {
                        doc.text(line, 20, yPosition);
                        yPosition += 5;
                    });
                    yPosition += 5; // Espacio adicional después de los comentarios
                }
            
            // Línea separadora
            doc.line(20, yPosition, 190, yPosition);
            yPosition += 10;
            
            // Contenido del reporte basado en el tipo
            
            if (reportType === 'alarms') {
                doc.setFontSize(16);
                doc.setTextColor(44, 62, 80);
                doc.text('REPORTE DE ALARMAS', 20, yPosition);
                yPosition += 15;
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('No hay datos de alarmas disponibles en este momento.', 20, yPosition);
                yPosition += 10;
                doc.text('Los datos de alarmas se registrarán automáticamente', 20, yPosition);
                yPosition += 10;
                doc.text('cuando se detecten eventos en los elevadores.', 20, yPosition);
                
            } else if (reportType === 'service') {
                doc.setFontSize(16);
                doc.setTextColor(44, 62, 80);
                doc.text('REPORTE DE SERVICIOS', 20, yPosition);
                yPosition += 15;
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('No hay registros de servicio disponibles en este momento.', 20, yPosition);
                yPosition += 10;
                doc.text('Los registros de servicio se crearán cuando se', 20, yPosition);
                yPosition += 10;
                doc.text('realicen mantenimientos o reparaciones.', 20, yPosition);
                
            } else if (reportType === 'summary') {
                doc.setFontSize(16);
                doc.setTextColor(44, 62, 80);
                doc.text('RESUMEN MENSUAL', 20, yPosition);
                yPosition += 15;
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('No hay datos de resumen disponibles en este momento.', 20, yPosition);
                yPosition += 10;
                doc.text('El resumen mensual se generará automáticamente', 20, yPosition);
                yPosition += 10;
                doc.text('al final de cada mes con las estadísticas del sistema.', 20, yPosition);
            }
            
                // Pie de página
                yPosition = 280;
                doc.setFontSize(10);
                doc.setTextColor(108, 117, 125); // Color gris
                doc.text('Este reporte fue generado automáticamente por el Sistema de Control de Elevadores', 20, yPosition);
                doc.text('Bermuda Elevators - Sistema de Monitoreo en Tiempo Real', 20, yPosition + 10);
                
                // Descargar el PDF
                const fileName = `Reporte_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
                console.log('Intentando descargar PDF:', fileName);
                doc.save(fileName);
                
                console.log('PDF generado y descargado:', fileName);
                
                // Mostrar mensaje de éxito
                const reportMsg = document.getElementById('reportMsg');
                if (reportMsg) {
                    reportMsg.textContent = 'PDF generado y descargado exitosamente';
                    reportMsg.className = 'success';
                    setTimeout(() => {
                        reportMsg.textContent = '';
                        reportMsg.className = '';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('Error generando PDF: ' + error.message);
                
                const reportMsg = document.getElementById('reportMsg');
                if (reportMsg) {
                    reportMsg.textContent = 'Error generando PDF: ' + error.message;
                    reportMsg.className = 'error';
                }
            }
        }
        
        // Función de prueba simple para PDF
        function testPDF() {
            console.log('=== PRUEBA SIMPLE DE PDF ===');
            try {
                if (typeof window.jspdf === 'undefined') {
                    console.error('jsPDF no disponible');
                    alert('Error: jsPDF library not loaded');
                    return;
                }
                
                console.log('jsPDF disponible, creando documento...');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                console.log('Documento creado, agregando texto...');
                doc.text('Bermuda Elevators - Test Report', 20, 20);
                doc.text('Fecha: ' + new Date().toLocaleString(), 20, 30);
                doc.text('Este es un PDF de prueba', 20, 40);
                
                console.log('Texto agregado, guardando PDF...');
                const fileName = 'test_report_' + new Date().getTime() + '.pdf';
                doc.save(fileName);
                
                console.log('PDF de prueba generado exitosamente:', fileName);
                alert('PDF de prueba generado exitosamente: ' + fileName);
                
            } catch (error) {
                console.error('Error en prueba PDF:', error);
                alert('Error generando PDF de prueba: ' + error.message);
            }
        }

        // Event listener para el botón de generar PDF
        document.addEventListener('DOMContentLoaded', function() {
            const generateReportBtn = document.getElementById('generateReportBtn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Botón de generar PDF clickeado');
                    
                    // Usar la función completa de reporte
                    generateReportPDF();
                });
                console.log('Event listener agregado para generar PDF');
            } else {
                console.error('No se encontró el botón generateReportBtn');
            }
            
            // Event listener para el select de edificios
            const allowedBuildingsSelect = document.getElementById('allowedBuildings');
            if (allowedBuildingsSelect) {
                allowedBuildingsSelect.addEventListener('change', function() {
                    const selectedBuilding = this.value;
                    console.log('Edificio seleccionado:', selectedBuilding);
                });
            }
        });

        // Login functionality
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // Validación básica
            if (!email || !password) {
                showLoginError('Please complete all fields');
                return;
            }
            
            // Validación de formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showLoginError('Please enter a valid email');
                return;
            }
            
            console.log('=== INICIANDO VERIFICACIÓN DE CREDENCIALES ===');
            console.log('Email:', email);
            
            try {
                // Mostrar indicador de carga
                showLoginLoading(true);
                
                // Obtener usuarios de la API
                const response = await fetch('https://script.google.com/macros/s/AKfycbyvJDE1qb-qULHBpeSnWDs88KH-PZhlmzRxQKV2be2aR2oD-f48-MDLwSz0xil2NIKl/exec');
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Respuesta de la API:', data);
                
                if (!data.success || !data.data) {
                    throw new Error('Error en la respuesta de la API');
                }
                
                // Buscar usuario por email
                const users = data.data;
                console.log('Usuarios disponibles:', users.length);
                
                const user = users.find(u => 
                    u.Email && u.Email.toLowerCase() === email.toLowerCase()
                );
                
                if (!user) {
                    console.log('Usuario no encontrado');
                    showLoginError('Email or password incorrect');
                    return;
                }
                
                console.log('Usuario encontrado:', user);
                
                // Verificar contraseña (convertir ambos a string para comparación)
                const userPassword = String(user.Contraseña);
                const inputPassword = String(password);
                
                console.log('Comparando contraseñas:');
                console.log('Contraseña del usuario:', userPassword);
                console.log('Contraseña ingresada:', inputPassword);
                
                if (userPassword !== inputPassword) {
                    console.log('Contraseña incorrecta');
                    showLoginError('Email or password incorrect');
                    return;
                }
                
                console.log('=== LOGIN EXITOSO ===');
                console.log('Usuario autenticado:', user);
                
                // Guardar información del usuario en localStorage para persistencia
                localStorage.setItem('currentUser', JSON.stringify({
                    email: user.Email,
                    password: user.Contraseña,
                    role: user.role,
                    buildings: user.builds
                }));
                
                // Guardar timestamp de la sesión para control de expiración
                localStorage.setItem('sessionTimestamp', Date.now().toString());
                
                // Ocultar login y mostrar pantalla de carga
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('loading-screen').style.display = 'flex';
                
                // Configurar permisos de navegación
                setupNavigationPermissions();
                
                // Cargar datos de la aplicación con pantalla de carga
                await loadAppData();
                
                // Verificar rol de admin después del login con un pequeño delay
                setTimeout(() => {
                    checkAdminRole();
                }, 1000);
                
            } catch (error) {
                console.error('Error en el login:', error);
                showLoginError('Connection error. Please try again.');
            } finally {
                showLoginLoading(false);
            }
        }

        // Función para mostrar errores de login
        function showLoginError(message) {
            // Crear o actualizar elemento de error
            let errorElement = document.getElementById('login-error');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = 'login-error';
                errorElement.style.cssText = `
                    color: #e74c3c;
                    background: #fdf2f2;
                    border: 1px solid #fecaca;
                    border-radius: 8px;
                    padding: 12px;
                    margin-top: 15px;
                    font-size: 14px;
                    text-align: center;
                `;
                
                const loginForm = document.getElementById('loginForm');
                loginForm.appendChild(errorElement);
            }
            
            errorElement.textContent = message;
            
            // Ocultar error después de 5 segundos
            setTimeout(() => {
                if (errorElement) {
                    errorElement.remove();
                }
            }, 5000);
        }

        // Función para mostrar/ocultar indicador de carga
        function showLoginLoading(show) {
            const loginBtn = document.querySelector('.login-btn');
            if (show) {
                loginBtn.textContent = 'Verifying...';
                loginBtn.disabled = true;
                loginBtn.style.opacity = '0.7';
            } else {
                loginBtn.textContent = 'Sign in';
                loginBtn.disabled = false;
                loginBtn.style.opacity = '1';
            }
        }

        // Función para cargar datos de la aplicación con pantalla de carga
        async function loadAppData() {
            console.log('=== INICIANDO CARGA DE DATOS DE LA APLICACIÓN ===');
            
            const loadingText = document.querySelector('.loading-text');
            
            try {
                // Limpiar cache antes de cargar datos para evitar problemas con usuarios anteriores
                clearApiCache();
                console.log('Cache limpiado antes de cargar datos del nuevo usuario');
                
                // Obtener información del usuario actual
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                console.log('Usuario actual:', currentUser);
                
                // Actualizar texto de carga
                if (loadingText) {
                    loadingText.textContent = 'Connecting to server...';
                }
                
                // Cargar datos de Dashboard PRIMERO (filtrados por usuario)
                console.log('=== CARGANDO DATOS INICIALES DE DASHBOARD ===');
                if (loadingText) {
                    loadingText.textContent = 'Loading personalized dashboard...';
                }
                await loadDashboardData(currentUser);
                
                // Esperar a que la tarjeta del dashboard se renderice completamente
                console.log('=== ESPERANDO RENDERIZADO COMPLETO DEL DASHBOARD ===');
                if (loadingText) {
                    loadingText.textContent = 'Finalizing dashboard...';
                }
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // QUITAR PANTALLA DE CARGA INMEDIATAMENTE DESPUÉS DEL DASHBOARD
                console.log('=== QUITANDO PANTALLA DE CARGA - DASHBOARD LISTO ===');
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                
                // Cargar datos de Units EN SEGUNDO PLANO (sin bloquear la UI)
                console.log('=== CARGANDO DATOS DE UNITS EN SEGUNDO PLANO ===');
                loadUnitsData(null, currentUser).then(() => {
                    console.log('=== UNITS CARGADO EN SEGUNDO PLANO ===');
                    
                    // Iniciar actualización automática después de que Units esté cargado
                    startAutoUpdate();
                }).catch(error => {
                    console.error('Error cargando Units en segundo plano:', error);
                    // Iniciar actualización automática incluso si hay error
                    startAutoUpdate();
                });
                
                console.log('=== APLICACIÓN CARGADA EXITOSAMENTE ===');
                
            } catch (error) {
                console.error('Error cargando datos de la aplicación:', error);
                
                if (loadingText) {
                    loadingText.textContent = 'Error loading, continuing...';
                }
                
                // Esperar un poco antes de mostrar la app
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // En caso de error, mostrar app de todas formas
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
            }
        }

        // Función para verificar si el usuario es admin y mostrar/ocultar botón View History
        function checkAdminRole() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const viewHistoryContainer = document.getElementById('viewHistoryContainer');
                
                console.log('Verificando rol de admin:', currentUser.role);
                
                if (viewHistoryContainer) {
                    if (currentUser.role === 'Admin' || currentUser.role === 'admin') {
                        viewHistoryContainer.style.display = 'block';
                        console.log('Usuario admin detectado - Mostrando botón View History');
                    } else {
                        viewHistoryContainer.style.display = 'none';
                        console.log('Usuario no admin - Ocultando botón View History');
                    }
                } else {
                    console.log('Contenedor viewHistoryContainer no encontrado');
                }
            } catch (error) {
                console.error('Error verificando rol de admin:', error);
                // En caso de error, ocultar el botón por seguridad
                const viewHistoryContainer = document.getElementById('viewHistoryContainer');
                if (viewHistoryContainer) {
                    viewHistoryContainer.style.display = 'none';
                }
            }
        }

        // Event listeners para login
        document.addEventListener('DOMContentLoaded', function() {
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
            }
            
            // Social login buttons
            const socialBtns = document.querySelectorAll('.social-btn');
            socialBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const provider = this.classList.contains('google-btn') ? 'Google' : 
                                   this.classList.contains('facebook-btn') ? 'Facebook' : 'Twitter';
                    console.log(`Login con ${provider}`);
                    // Simular login social
                    handleLogin();
                });
            });
            
            // Sign up link
            const signupLink = document.getElementById('signupLink');
            if (signupLink) {
                signupLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('Registration functionality coming soon');
                });
            }
            
            // Verificar rol de admin para mostrar/ocultar botón View History
            checkAdminRole();
            
            // Profile buttons
            const profileBtns = document.querySelectorAll('.profile-btn');
            profileBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    openProfileModal();
                });
            });
        });

        // Profile Modal Functions
        function openProfileModal() {
            const modal = document.getElementById('profile-modal');
            
            // Obtener información del usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Actualizar información del usuario en el modal
            const userName = document.getElementById('profile-user-name');
            const userEmail = document.getElementById('profile-user-email');
            
            if (userName && userEmail) {
                // Mostrar el rol del usuario
                const roleText = getRoleDisplayText(currentUser.role);
                userName.textContent = roleText;
                
                // Mostrar el email del usuario actual
                userEmail.textContent = currentUser.email || 'No email available';
            }
            
            modal.style.display = 'flex';
        }

        // Función para obtener el texto de visualización del rol
        function getRoleDisplayText(role) {
            switch (role) {
                case 'Admin':
                    return 'Administrator';
                case 'Technician':
                    return 'Technician';
                case 'Client':
                    return 'Client';
                default:
                    return 'User';
            }
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'none';
        }

        function showProfileSettings() {
            closeProfileModal();
            // Profile functionality not implemented yet
        }

        function showAccountSettings() {
            closeProfileModal();
            // Settings functionality not implemented yet
        }

        function showNotifications() {
            closeProfileModal();
            // Notifications functionality not implemented yet
        }

        // Mostrar modal de confirmación de logout
        function showLogoutModal() {
            closeProfileModal();
            document.getElementById('logout-confirm-modal').style.display = 'flex';
        }

        // Cerrar modal de confirmación de logout
        function closeLogoutModal() {
            document.getElementById('logout-confirm-modal').style.display = 'none';
        }

        // Confirmar logout
        function confirmLogout() {
            // Limpiar información del usuario
            localStorage.removeItem('currentUser');
            localStorage.removeItem('sessionTimestamp');
            
            // Limpiar caché de datos de usuarios para forzar recarga en próximo login
            localStorage.removeItem('usersData');
            localStorage.removeItem('usersDataTimestamp');
            
            // Limpiar cache de la API para evitar problemas al cambiar de usuario
            clearApiCache();
            
            // Limpiar historial de servicios (opcional - comentado para mantener historial)
            // localStorage.removeItem('serviceHistory');
            
            // Ocultar app y mostrar login
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            
            // Limpiar formulario de login
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            // Limpiar cualquier mensaje de error
            const errorElement = document.getElementById('login-error');
            if (errorElement) {
                errorElement.remove();
            }
            
            // Cerrar modal de logout
            closeLogoutModal();
            
            console.log('Usuario cerró sesión - datos limpiados');
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(event) {
            const profileModal = document.getElementById('profile-modal');
            const logoutModal = document.getElementById('logout-confirm-modal');
            
            if (event.target === profileModal) {
                closeProfileModal();
            }
            
            if (event.target === logoutModal) {
                closeLogoutModal();
            }
        });

        // Función para controlar la visibilidad de elementos de navegación basada en el rol
        function setupNavigationPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            console.log('Configurando permisos de navegación para:', currentUser.role);
            
            // Obtener todos los elementos de navegación
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(navItem => {
                const onclick = navItem.getAttribute('onclick');
                if (!onclick) return;
                
                // Extraer el nombre de la pantalla del onclick
                const screenName = onclick.match(/showScreen\('([^']+)'\)/);
                if (!screenName) return;
                
                const screen = screenName[1];
                let shouldShow = false;
                
                // Definir permisos por rol
                switch (currentUser.role) {
                    case 'Admin':
                        // Admin ve todo
                        shouldShow = true;
                        break;
                    case 'Technician':
                        // Técnico ve: Dashboard, Units, Service, Reports (sin Devices y Users)
                        shouldShow = ['dashboard-screen', 'units-screen', 'service-screen', 'reports-screen'].includes(screen);
                        break;
                    case 'Client':
                        // Cliente ve: Dashboard, Units, Service
                        shouldShow = ['dashboard-screen', 'units-screen', 'service-screen'].includes(screen);
                        break;
                    default:
                        shouldShow = false;
                }
                
                // Mostrar u ocultar elemento
                if (shouldShow) {
                    navItem.style.display = 'flex';
                    console.log(`Mostrando navegación: ${screen}`);
                } else {
                    navItem.style.display = 'none';
                    console.log(`Ocultando navegación: ${screen}`);
                }
            });
        }

        // Función para verificar si una pantalla está permitida para el usuario actual
        function isScreenAllowed(screenName) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            switch (currentUser.role) {
                case 'Admin':
                    return true; // Admin ve todo
                case 'Technician':
                    return ['dashboard-screen', 'units-screen', 'service-screen', 'reports-screen'].includes(screenName);
                case 'Client':
                    return ['dashboard-screen', 'units-screen', 'service-screen'].includes(screenName);
                default:
                    return false;
            }
        }

        // Función para obtener la primera pantalla permitida para el usuario
        function getFirstAllowedScreen() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            switch (currentUser.role) {
                case 'Admin':
                    return 'dashboard-screen';
                case 'Technician':
                    return 'dashboard-screen';
                case 'Client':
                    return 'dashboard-screen';
                default:
                    return 'dashboard-screen';
            }
        }

        // Verificar si la sesión ha expirado (DESHABILITADO - sesión permanente)
        function isSessionExpired() {
            // La sesión nunca expira - siempre retorna false
            return false;
        }

        // Verificar autenticación al cargar la página
        function checkAuthentication() {
            console.log('=== VERIFICANDO AUTENTICACIÓN ===');
            const currentUser = localStorage.getItem('currentUser');
            
            if (currentUser) {
                console.log('Usuario ya autenticado:', JSON.parse(currentUser));
                // Usuario ya está logueado, mostrar la app directamente
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('loading-screen').style.display = 'flex';
                
                // Configurar permisos de navegación
                setupNavigationPermissions();
                
                // Cargar datos de la aplicación
                console.log('Iniciando carga de datos de la aplicación...');
                loadAppData();
            } else {
                console.log('Usuario no autenticado, mostrando login');
                // Usuario no está logueado, mostrar login
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        // Inicializar verificación de autenticación
        checkAuthentication();

    </script>

    <!-- PWA Service Worker + Push API -->
    <script>
        // VAPID Public Key
        const VAPID_PUBLIC_KEY = 'BP9tERGLAHCk3jrMIXlRxDpvcsJdM7Lvr0RUgRRd5F-u3bamRLzpdryhr3wZPY6niab8lojRp3dvzrvTtCtHoz0';
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('✅ Service Worker registrado:', registration.scope);
                        
                        // Registrar Push API después de 2 segundos
                        setTimeout(() => {
                            registerPushNotifications(registration);
                        }, 2000);
                        
                        // Verificar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('🔄 Nueva versión disponible');
                                    // Opcional: Mostrar notificación de actualización
                                    if (confirm('Nueva versión disponible. ¿Recargar la página?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('❌ Error registrando Service Worker:', error);
                    });
            });
        }

        // Función para registrar Push Notifications
        async function registerPushNotifications(registration) {
            try {
                console.log('🔔 Iniciando registro de Push API...');
                
                // Solicitar permisos de notificación
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    console.log('❌ Permisos de notificación denegados');
                    return;
                }
                
                console.log('✅ Permisos de notificación concedidos');
                
                // Suscribirse a push
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                console.log('✅ Push subscription creada:', subscription);
                
                // Enviar subscription a tu servidor
                await sendSubscriptionToServer(subscription);
                
            } catch (error) {
                console.error('❌ Error registrando Push API:', error);
            }
        }

        // Función para convertir VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Función para enviar subscription al servidor
        async function sendSubscriptionToServer(subscription) {
            try {
                console.log('📤 Enviando subscription al servidor...');
                
                // Obtener email del usuario actual
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userEmail = currentUser.email || 'unknown@example.com';
                
                console.log(`📧 Enviando suscripción para usuario: ${userEmail}`);
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbzI0XRsuouSr7SxQDx64BLx50bVmM8YXDshJ9LoPJ4XFrq55Jlr3BMVNrBTRxKqTRU-Yg/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveSubscription',
                        userEmail: userEmail,
                        subscription: subscription
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Subscription enviada al servidor exitosamente');
                    console.log(`📋 ID de suscripción: ${result.subscriptionId}`);
                    
                    // Guardar ID de suscripción en localStorage
                    localStorage.setItem('pushSubscriptionId', result.subscriptionId);
                } else {
                    console.error('❌ Error enviando subscription:', response.status);
                }
            } catch (error) {
                console.error('❌ Error enviando subscription:', error);
            }
        }

        // Instalar PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('📱 PWA puede ser instalada - MOSTRANDO NOTIFICACIÓN ELEGANTE');
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar notificación de instalación elegante
            const installNotification = document.createElement('div');
            installNotification.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    right: 20px;
                    background: #f8f9fa;
                    border-radius: 16px;
                    padding: 16px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                    z-index: 1000;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                ">
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 12px;
                    ">
                        <div style="
                            width: 48px;
                            height: 48px;
                            background: #0b3d91;
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 20px;
                            color: white;
                            font-weight: bold;
                            flex-shrink: 0;
                        ">
                            📱
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="
                                font-size: 16px;
                                font-weight: 600;
                                color: #2c3e50;
                                line-height: 1.2;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            ">
                                Bermuda Elevators
                            </div>
                            <div style="
                                font-size: 14px;
                                color: #7f8c8d;
                                line-height: 1.3;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            ">
                                Descarga La app Ahora
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button id="install-dismiss" style="
                            background: transparent;
                            border: 1px solid #dee2e6;
                            color: #6c757d;
                            padding: 8px 12px;
                            border-radius: 8px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        ">
                            Cerrar
                        </button>
                        <button id="install-accept" style="
                            background: #0b3d91;
                            border: none;
                            color: white;
                            padding: 8px 16px;
                            border-radius: 8px;
                            font-size: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        ">
                            Instalar
                        </button>
                    </div>
                </div>
            `;
            
            // Event listeners
            installNotification.querySelector('#install-accept').addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('✅ Usuario aceptó instalar la PWA');
                    } else {
                        console.log('❌ Usuario rechazó instalar la PWA');
                    }
                    deferredPrompt = null;
                    installNotification.remove();
                });
            });
            
            installNotification.querySelector('#install-dismiss').addEventListener('click', () => {
                installNotification.remove();
            });
            
            // Hover effects
            const acceptBtn = installNotification.querySelector('#install-accept');
            const dismissBtn = installNotification.querySelector('#install-dismiss');
            
            acceptBtn.addEventListener('mouseenter', () => {
                acceptBtn.style.background = '#0a2d6b';
                acceptBtn.style.transform = 'translateY(-1px)';
            });
            
            acceptBtn.addEventListener('mouseleave', () => {
                acceptBtn.style.background = '#0b3d91';
                acceptBtn.style.transform = 'translateY(0)';
            });
            
            dismissBtn.addEventListener('mouseenter', () => {
                dismissBtn.style.background = '#f8f9fa';
                dismissBtn.style.borderColor = '#adb5bd';
            });
            
            dismissBtn.addEventListener('mouseleave', () => {
                dismissBtn.style.background = 'transparent';
                dismissBtn.style.borderColor = '#dee2e6';
            });
            
            document.body.appendChild(installNotification);
        });

        // PWA instalada
        window.addEventListener('appinstalled', (evt) => {
            console.log('🎉 PWA instalada exitosamente');
            // Ocultar indicador rojo cuando se instala automáticamente
            hideNotificationIndicator();
        });

        // SISTEMA DE NOTIFICACIONES CON ANIMACIÓN
        let notificationClosed = false;
        let notificationElement = null;
        let notificationButton = null;

        // Función para mostrar notificación con animación
        function showInstallNotification() {
            if (notificationClosed) return;
            
            console.log('🔔 Mostrando notificación de instalación...');
            notificationElement = document.createElement('div');
            notificationElement.innerHTML = `
                <div id="install-notification" style="
                    position: fixed;
                    top: 28%;
                    left: 50%;
                    transform: translateX(-50%) translateY(-50%) translateY(100px);
                    width: 90%;
                    max-width: 400px;
                    background: #f8f9fa;
                    border-radius: 16px;
                    padding: 16px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                    z-index: 1000;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                    opacity: 0;
                    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                ">
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 12px;
                    ">
                        <div style="
                            width: 48px;
                            height: 48px;
                            background: #0b3d91;
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 20px;
                            color: white;
                            font-weight: bold;
                            flex-shrink: 0;
                        ">
                            📱
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="
                                font-size: 16px;
                                font-weight: 600;
                                color: #2c3e50;
                                line-height: 1.2;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            ">
                                Bermuda Elevators
                            </div>
                            <div style="
                                font-size: 14px;
                                color: #7f8c8d;
                                line-height: 1.3;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            ">
                                Descarga La app Ahora
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button id="notification-dismiss" style="
                            background: transparent;
                            border: 1px solid #dee2e6;
                            color: #6c757d;
                            padding: 8px 12px;
                            border-radius: 8px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        ">
                            Cerrar
                        </button>
                        <button id="notification-install" style="
                            background: #0b3d91;
                            border: none;
                            color: white;
                            padding: 8px 16px;
                            border-radius: 8px;
                            font-size: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        ">
                            Instalar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notificationElement);
            
            // Animar entrada
            setTimeout(() => {
                const notification = document.getElementById('install-notification');
                if (notification) {
                    notification.style.transform = 'translateX(-50%) translateY(-50%)';
                    notification.style.opacity = '1';
                }
            }, 100);
            
            // Event listeners
            document.getElementById('notification-dismiss').addEventListener('click', () => {
                hideNotification();
            });
            
            document.getElementById('notification-install').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('✅ Usuario aceptó instalar la PWA');
                            // Ocultar indicador rojo cuando se instala
                            hideNotificationIndicator();
                        } else {
                            console.log('❌ Usuario rechazó instalar la PWA');
                        }
                        deferredPrompt = null;
                        hideNotification();
                    });
                } else {
                    console.log('⚠️ deferredPrompt no disponible - PWA ya instalada o no compatible');
                    // Ocultar indicador rojo y notificación sin mensaje
                    hideNotificationIndicator();
                    hideNotification();
                }
            });
        }

        // Función para ocultar notificación con animación
        function hideNotification() {
            if (!notificationElement) return;
            
            const notification = document.getElementById('install-notification');
            if (notification) {
                notification.style.transform = 'translateX(-50%) translateY(-50%) translateY(100px)';
                notification.style.opacity = '0';
                
                setTimeout(() => {
                    notificationElement.remove();
                    notificationElement = null;
                    notificationClosed = true;
                    // Mostrar indicador rojo en el botón del header
                    showNotificationIndicator();
                }, 500);
            }
        }

        // Función para mostrar indicador rojo en el botón de notificaciones
        function showNotificationIndicator() {
            const notificationBtn = document.getElementById('notification-header-btn');
            if (notificationBtn) {
                // Crear indicador rojo
                const indicator = document.createElement('div');
                indicator.id = 'notification-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: -2px;
                    right: -2px;
                    width: 12px;
                    height: 12px;
                    background: #e74c3c;
                    border-radius: 50%;
                    border: 2px solid white;
                    z-index: 1001;
                    animation: pulse 2s infinite;
                `;
                
                // Agregar animación CSS
                if (!document.getElementById('notification-pulse-style')) {
                    const style = document.createElement('style');
                    style.id = 'notification-pulse-style';
                    style.textContent = `
                        @keyframes pulse {
                            0% { transform: scale(1); opacity: 1; }
                            50% { transform: scale(1.2); opacity: 0.7; }
                            100% { transform: scale(1); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Hacer el botón relativo para el indicador
                notificationBtn.style.position = 'relative';
                notificationBtn.appendChild(indicator);
                
                console.log('🔴 Indicador rojo agregado al botón de notificaciones');
            }
        }

        // Función para ocultar indicador rojo
        function hideNotificationIndicator() {
            const indicator = document.getElementById('notification-indicator');
            if (indicator) {
                indicator.remove();
                console.log('🔴 Indicador rojo removido del botón de notificaciones');
            }
        }

        // Función para crear botón de notificación (ELIMINADA - solo se abre desde header)
        function createNotificationButton() {
            // Esta función ya no crea el botón rojo
            // Solo se abre desde el botón del header
            console.log('🔔 Botón rojo eliminado - solo se abre desde header');
        }

        // Mostrar notificación después de 3 segundos
        setTimeout(() => {
            showInstallNotification();
        }, 3000);

        // Event listener para botón de notificaciones del header
        document.addEventListener('DOMContentLoaded', function() {
            // Buscar el botón de notificaciones por ID
            const notificationHeaderBtn = document.getElementById('notification-header-btn');
            if (notificationHeaderBtn) {
                notificationHeaderBtn.addEventListener('click', function() {
                    console.log('🔔 Botón de notificaciones del header clickeado');
                    // Abrir notificación directamente desde el header
                    if (notificationClosed) {
                        notificationClosed = false;
                        showInstallNotification();
                    }
                });
            }
        });
    </script>
</body>
</html>